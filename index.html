<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>éŠæˆ¯ç‹ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆÎ²/ãƒ©ã‚¤ãƒˆãƒ€ãƒ¼ã‚¯ï¼‰</title>
  <meta name="description" content="éŠæˆ¯ç‹OCGãƒœãƒƒã‚¯ã‚¹ã®æœŸå¾…å€¤ï¼ˆè²·å–é¡ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’ã€ã‚„ã‚„æš—ã‚ãƒ©ã‚¤ãƒˆUIã§ç°¡å˜ç®—å‡ºã€‚ã‚¹ãƒãƒ›æœ€é©åŒ–ï¼†ã‚¢ãƒ•ã‚£ãƒ»AdSenseé€£æºã€‚" />
  <style>
    :root {
      /* å°‘ã—æš—ã‚ã®ãƒ©ã‚¤ãƒˆåŸºèª¿ï¼ˆå¤‰ãˆãŸã„å ´åˆã¯ã“ã“ã‚’èª¿æ•´ï¼‰ */
      --bg: #e9edf3;          /* æ˜ã‚‹ã„ç°é’ */
      --card: #ffffff;        /* ç™½ã‚«ãƒ¼ãƒ‰ */
      --ink: #0e1525;         /* æ¿ƒã„ã‚¤ãƒ³ã‚¯ */
      --muted: #4b5563;       /* ãƒŸãƒ‰ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ */
      --line: #d7deea;        /* ç½«ç·š */
      --accent: #0ea5e9;      /* ç©ºè‰² */
      --accent-2: #22c55e;    /* ç·‘ */
      --accent-3: #f59e0b;    /* é»„ */
      --bad: #ef4444;         /* èµ¤ */
      --ok: #22c55e;          /* ç·‘ */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--ink); font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif; }

    header { position: sticky; top: 0; z-index: 60; background: rgba(255,255,255,.92); backdrop-filter: saturate(140%) blur(8px); border-bottom: 1px solid var(--line); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px 16px; }

    .brand { display: flex; gap: 12px; align-items: center; }
    .logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #60a5fa, #38bdf8); display: grid; place-items: center; font-weight: 800; color: #082f49; }
    .logo span { font-size: 18px; }
    .title { font-weight: 800; letter-spacing: .02em; }
    .sub { color: var(--muted); font-size: 13px; }

    main.wrap { display: grid; grid-template-columns: 1.15fr .85fr; gap: 16px; align-items: start; }
    @media (max-width: 980px) { main.wrap { grid-template-columns: 1fr; } }

    .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: 0 6px 14px rgba(2,6,23,.06); }
    .card h2 { margin: 0 0 10px; font-size: 18px; letter-spacing: .02em; }
    .hint { color: var(--muted); font-size: 13px; }

    label { display: block; font-weight: 700; margin: 10px 0 6px; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--line); background: #f8fafc; color: var(--ink); outline: none; }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14,165,233,.15); }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1.2fr .8fr .8fr; gap: 10px; }
    .row4 { display: grid; grid-template-columns: 1fr .8fr .8fr .8fr; gap: 10px; }
    @media (max-width: 700px) { .row, .row3, .row4 { grid-template-columns: 1fr; } }

    .rarity-list { display: grid; gap: 12px; margin-top: 8px; }
    .rar-item { background: #f3f6fb; border: 1px solid var(--line); border-radius: 12px; padding: 10px; }

    .btn { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; border-radius: 12px; background: #e6f6ff; border: 1px solid #bae6fd; color: #0b4a6f; cursor: pointer; user-select: none; font-weight: 700; }
    .btn:hover { background: #dff2ff; }
    .btn.ghost { background: #fff; border-color: var(--line); color: var(--muted); }
    .btn.small { padding: 9px 12px; font-size: 14px; }
    .btn.ok { background: #e7f8ee; border-color: #b7f0cb; color: #064e3b; }
    .btn.warn { background: #fff7e6; border-color: #fde68a; color: #5b3702; }
    .btn.bad { background: #ffecec; border-color: #fecaca; color: #7f1d1d; }

    .sticky-cta { position: sticky; bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; background: transparent; padding-top: 8px; }

    .kpi { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi .box { background: #f7f9fc; border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .kpi .val { font-size: 22px; font-weight: 800; letter-spacing: .02em; }
    .kpi .lbl { color: var(--muted); font-size: 12px; }

    .evbar { height: 12px; background: linear-gradient(90deg, var(--bad), var(--accent-3), var(--ok)); border-radius: 999px; opacity: .9; margin-top: 6px; position: relative; }
    .evpin { position: absolute; top: -4px; width: 2px; height: 20px; background: #0f172a; border-radius: 2px; }

    .sources { display: grid; gap: 8px; }
    .src-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }

    footer { color: var(--muted); text-align: center; padding: 30px 10px; font-size: 12px; }

    .ad, .aff { background: #ffffff; border: 1px dashed var(--line); border-radius: 12px; padding: 12px; color: var(--muted); font-size: 13px; }
    .stack { display: grid; gap: 12px; }

    .note { font-size: 12px; color: var(--muted); }
    .pill { display: inline-block; background: #eef2ff; border: 1px solid #c7d2fe; color: #3730a3; border-radius: 999px; padding: 2px 8px; font-size: 12px; }

    .hr { height: 1px; background: var(--line); margin: 12px 0; }

    @media (max-width: 480px){
      header .wrap { padding: 10px 12px; }
      .btn { padding: 12px 14px; }
      .kpi .val { font-size: 20px; }
    }

    /* dialog */
    dialog.settings { width: min(720px, 96vw); border: 1px solid var(--line); border-radius: 14px; padding: 0; }
    .dlg-head { padding: 14px 16px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
    .dlg-body { padding: 14px 16px; display: grid; gap: 10px; }
    .dlg-foot { padding: 14px 16px; border-top: 1px solid var(--line); display:flex; gap:8px; justify-content:flex-end; }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div class="brand" aria-label="ã‚µã‚¤ãƒˆåã¨èª¬æ˜">
        <div class="logo" aria-hidden="true"><span>EV</span></div>
        <div>
          <div class="title">éŠæˆ¯ç‹ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆÎ²ï¼‰</div>
          <div class="sub">Noteæº–æ‹ ã®ç°¡ä¾¿å¼ã§æœŸå¾…å€¤ã‚’ç®—å‡ºã€‚ã‚„ã‚„æš—ã‚ãƒ©ã‚¤ãƒˆUI/ã‚¹ãƒãƒ›æœ€é©åŒ–ãƒ»ã‚¢ãƒ•ã‚£é€£æºå¯¾å¿œã€‚</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn small" id="btn-save" title="è¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜">ä¿å­˜</button>
        <button class="btn small ghost" id="btn-load" title="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿">èª­è¾¼</button>
        <button class="btn small ghost" id="btn-reset" title="åˆæœŸåŒ–">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn small" id="btn-settings" title="APIã‚„ã‚¢ãƒ•ã‚£IDãªã©ã®è¨­å®š">è¨­å®š</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- å·¦ï¼šå…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <section class="card">
      <h2>å…¥åŠ›ï¼ˆç®±ã®åŸºæœ¬æƒ…å ±ï¼‰</h2>
      <div class="row">
        <div>
          <label for="boxName">ãƒœãƒƒã‚¯ã‚¹å</label>
          <input id="boxName" type="text" placeholder="ä¾‹ï¼šQUARTER CENTURY CHRONICLE side:UNITY" />
        </div>
        <div>
          <label for="boxPrice">å‚è€ƒè²©å£²ä¾¡æ ¼ï¼ˆ1ç®±, Â¥ï¼‰</label>
          <input id="boxPrice" type="number" min="0" step="1" placeholder="ä¾‹ï¼š6000" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="packsPerBox">1ç®±ã®ãƒ‘ãƒƒã‚¯æ•°</label>
          <input id="packsPerBox" type="number" min="1" step="1" placeholder="ä¾‹ï¼š30" />
        </div>
        <div>
          <label for="memo">ãƒ¡ãƒ¢ï¼ˆç‰ˆåãƒ»å°åˆ·ãƒ­ãƒƒãƒˆãƒ»å‚™è€ƒãªã©ï¼‰<span class="pill">ä»»æ„</span></label>
          <input id="memo" type="text" placeholder="ä¾‹ï¼šåˆç‰ˆï¼å†è²©ã€ä½ç¢ºç‡æ ã¯å‡ç­‰ä»®å®š ãªã©" />
        </div>
      </div>

      <div class="sticky-cta">
        <button class="btn" id="btn-autoFill" title="ç®±åã‹ã‚‰ãƒãƒƒãƒˆæ¤œç´¢APIã‚’å‘¼ã³å‡ºã—ã¦ä¸‹ã®ãƒ¬ã‚¢æ ã‚’è‡ªå‹•å…¥åŠ›">ğŸ” è‡ªå‹•å…¥åŠ›ï¼ˆÎ²ï¼‰</button>
        <button class="btn ghost" id="btn-affGen" title="ç®±åã‹ã‚‰å„ã‚·ãƒ§ãƒƒãƒ—æ¤œç´¢ãƒªãƒ³ã‚¯ã‚’æ›´æ–°">ğŸ”— è³¼å…¥ãƒªãƒ³ã‚¯æ›´æ–°</button>
      </div>

      <div class="hr"></div>

      <h2>ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥ã®å…¥åŠ›ï¼ˆå¹³å‡è²·å–é¡Ã—ç®±ã‚ãŸã‚Šå°å…¥æšæ•°ï¼‰</h2>
      <p class="hint">â€» ç°¡ä¾¿å¼ï¼š<b>åŒä¸€ãƒ¬ã‚¢å†…ã¯å¹³å‡ä¾¡æ ¼ã§å‡ç­‰</b>ã¨ä»®å®šã€‚ã‚«ãƒ¼ãƒ‰åˆ¥ä¾¡æ ¼ã‚’è²¼ã‚Šä»˜ã‘ã‚Œã°å¹³å‡ã«åæ˜ å¯èƒ½ã€‚</p>
      <div id="rarityList" class="rarity-list"></div>
      <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn" id="btn-addRarity">+ ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¡Œã‚’è¿½åŠ </button>
        <button class="btn ghost" id="btn-addTemplate">ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆUR/SR/SEâ€¦ï¼‰ã‚’å…¥ã‚Œã‚‹</button>
      </div>

      <div class="hr"></div>

      <h2>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆä¸Šä½3ã€œ5ã‚µã‚¤ãƒˆï¼‰</h2>
      <p class="hint">å‚è€ƒã«ã—ãŸè²·å–è¡¨ã‚„ç›¸å ´ãƒšãƒ¼ã‚¸ã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆé€æ˜æ€§å‘ä¸Šï¼‰ã€‚è‡ªå‹•å…¥åŠ›æ™‚ã¯å–å¾—å…ƒãŒè‡ªå‹•è¿½è¨˜ã•ã‚Œã¾ã™ã€‚</p>
      <div id="sources" class="sources"></div>
      <button class="btn small" id="btn-addSrc" style="margin-top:8px;">+ å‚ç…§URLã‚’è¿½åŠ </button>

      <div class="hr"></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;" class="sticky-cta">
        <button class="btn ok" id="btn-calc">æœŸå¾…å€¤ã‚’è¨ˆç®—</button>
        <button class="btn warn" id="btn-export">JSONæ›¸ãå‡ºã—</button>
        <button class="btn ghost" id="btn-import">JSONèª­ã¿è¾¼ã¿</button>
      </div>
      <p class="hint">è¨­å®šã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆLocalStorageï¼‰ã€‚</p>
    </section>

    <!-- å³ï¼šçµæœï¼†åºƒå‘Š/ã‚¢ãƒ•ã‚£ -->
    <aside class="stack">
      <section class="card" id="resultCard">
        <h2>çµæœ</h2>
        <div class="kpi" aria-live="polite">
          <div class="box">
            <div class="lbl">1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ï¼ˆÂ¥ï¼‰</div>
            <div class="val" id="evPerPack">â€”</div>
          </div>
          <div class="box">
            <div class="lbl">1ç®±æœŸå¾…å€¤ï¼ˆÂ¥ï¼‰</div>
            <div class="val" id="evPerBox">â€”</div>
          </div>
          <div class="box">
            <div class="lbl">å›åç‡ï¼ˆæœŸå¾…å€¤Ã·ç®±ä¾¡æ ¼ï¼‰</div>
            <div class="val" id="roi">â€”</div>
          </div>
        </div>
        <div style="margin-top:10px;">
          <div class="lbl">å›åç‡ã‚²ãƒ¼ã‚¸</div>
          <div class="evbar"><div id="evpin" class="evpin" style="left:0%"></div></div>
          <div class="hint">50%æœªæº€ï¼šå³ã—ã‚ / 50ã€œ80%ï¼šä¸­åº¸ / 80%ä»¥ä¸Šï¼šå¼·ã„ï¼ˆå¹³å‡å€¤ã€‚åˆ†å¸ƒã¯æ­ªã¿ãŒã¡ï¼‰ã€‚</div>
        </div>
        <div class="hr"></div>
        <div id="evBreakdown" class="hint">ï¼ˆè¨ˆç®—å‰ï¼‰</div>
      </section>

      <section class="aff">
        <b>ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆï¼ˆæ¥½å¤©/Amazonï¼‰</b>
        <div class="hint">ç®±åã‹ã‚‰æ¤œç´¢ãƒªãƒ³ã‚¯ã‚’è‡ªå‹•ç”Ÿæˆã€‚è¨­å®šï¼ã‚¢ãƒ•ã‚£IDã«ã‚ãªãŸã®IDã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <a id="rakutenBtn" class="btn small" target="_blank" rel="noopener" href="https://search.rakuten.co.jp/search/mall/éŠæˆ¯ç‹%20ãƒœãƒƒã‚¯ã‚¹/">æ¥½å¤©ã§ãƒœãƒƒã‚¯ã‚¹ã‚’æ¢ã™</a>
          <a id="amazonBtn" class="btn small ghost" target="_blank" rel="noopener" href="https://www.amazon.co.jp/s?k=éŠæˆ¯ç‹%20ãƒœãƒƒã‚¯ã‚¹">Amazonã§ãƒœãƒƒã‚¯ã‚¹ã‚’æ¢ã™</a>
        </div>
        <div class="note" style="margin-top:6px;">æ¥½å¤©ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒªãƒ³ã‚¯ï¼Amazonæ¤œç´¢URLã®æœ«å°¾ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã§ãã¾ã™ï¼ˆè¨­å®šå‚ç…§ï¼‰ã€‚</div>
      </section>

      <section class="ad">
        <b>åºƒå‘Šï¼ˆGoogle AdSenseï¼‰</b>
        <div class="hint">ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åºƒå‘Šã®ä¾‹ï¼ˆè¨­å®šï¼AdSenseã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID/ã‚¹ãƒ­ãƒƒãƒˆIDã‚’ä¿å­˜ï¼‰ã€‚</div>
        <div id="adsenseSlot" class="note" style="white-space:pre-wrap;">
          <!-- è¨­å®šã‹ã‚‰æœ‰åŠ¹åŒ–ã™ã‚‹ã¨è‡ªå‹•æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>
      </section>

      <section class="card">
        <h2>ä½¿ã„æ–¹ï¼ˆè¶…ç°¡ç•¥ï¼‰</h2>
        <ol class="hint" style="margin:0 0 8px 18px;">
          <li>ç®±åãƒ»ä¾¡æ ¼ãƒ»ãƒ‘ãƒƒã‚¯æ•°ã‚’å…¥åŠ›</li>
          <li>ã€Œè‡ªå‹•å…¥åŠ›ï¼ˆÎ²ï¼‰ã€ã§ãƒãƒƒãƒˆæ¤œç´¢APIã‹ã‚‰ãƒ¬ã‚¢æ ã‚’è‡ªå‹•å–å¾—ï¼ˆä»»æ„ï¼‰ã€‚å¤±æ•—æ™‚ã¯æ‰‹å…¥åŠ›</li>
          <li>ã€ŒæœŸå¾…å€¤ã‚’è¨ˆç®—ã€ã§å³ã«çµæœè¡¨ç¤ºã€‚å‚ç…§URLã‚’3ã€œ5ä»¶å…¥åŠ›</li>
          <li>ã‚¢ãƒ•ã‚£IDã‚„åºƒå‘Šã¯ã€Œè¨­å®šã€ã‹ã‚‰ç®¡ç†</li>
        </ol>
        <div class="hint">å‰æï¼šåŒãƒ¬ã‚¢å†…ã¯å‡ç­‰å°å…¥ã€‚åˆç‰ˆ/å†è²©ã‚„éå¯¾ç§°é…åˆ—ã¯æœªå¯¾å¿œã€‚</div>
      </section>
    </aside>
  </main>

  <footer>
    Â© <span id="year"></span> Box EV Checker Î² â€” ç°¡ä¾¿å¼ã«ã‚ˆã‚‹å‚è€ƒå€¤ã€‚æŠ•è³‡åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
  </footer>

  <!-- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆAPI/ã‚¢ãƒ•ã‚£/åºƒå‘Šï¼‰ -->
  <dialog class="settings" id="dlg-settings">
    <div class="dlg-head">
      <strong>è¨­å®š</strong>
      <button class="btn small ghost" id="btn-close-settings">é–‰ã˜ã‚‹</button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div>
          <label>è‡ªå‹•å…¥åŠ›APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆGET ã¾ãŸã¯ POSTï¼‰</label>
          <input id="apiEndpoint" type="text" placeholder="ä¾‹ï¼šhttps://your-cloudfunc.example/api/ygo-ev" />
          <div class="hint">ä»•æ§˜ï¼š{ query: boxName } ã‚’æ¸¡ã™ã¨ã€rarities: [{name, avg, cpb, types}], sources: [url...] ã‚’è¿”ã™æƒ³å®šã€‚CORSè¨±å¯ãŒå¿…è¦ã€‚</div>
        </div>
        <div>
          <label>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰</label>
          <input id="apiTimeout" type="number" min="3" step="1" placeholder="10" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>æ¥½å¤©ã‚¢ãƒ•ã‚£ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ä¸</label>
          <input id="rakutenParams" type="text" placeholder="ä¾‹ï¼š?l-id=affiliate-XXXXX" />
          <div class="hint">æ¥½å¤©ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒªãƒ³ã‚¯ç­‰ã€‚æ¤œç´¢URLæœ«å°¾ã«é€£çµã€‚</div>
        </div>
        <div>
          <label>Amazonã‚¢ãƒ•ã‚£ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ä¸</label>
          <input id="amazonParams" type="text" placeholder="ä¾‹ï¼š&tag=yourtag-22" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>AdSense ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID</label>
          <input id="adsClient" type="text" placeholder="ca-pub-XXXXXXXXXXXXXXXX" />
        </div>
        <div>
          <label>AdSense ã‚¹ãƒ­ãƒƒãƒˆID</label>
          <input id="adsSlot" type="text" placeholder="XXXXXXXXXX" />
        </div>
      </div>
    </div>
    <div class="dlg-foot">
      <button class="btn ghost" id="btn-settings-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn" id="btn-settings-save">ä¿å­˜</button>
    </div>
  </dialog>

  <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
  <template id="rarityRowTpl">
    <div class="rar-item">
      <div class="row4">
        <div>
          <label>ãƒ¬ã‚¢ãƒªãƒ†ã‚£å</label>
          <input type="text" placeholder="ä¾‹ï¼šUR / SR / PSE / QSR ãªã©" class="rar-name" />
        </div>
        <div>
          <label>å¹³å‡è²·å–é¡ï¼ˆÂ¥ï¼‰</label>
          <input type="number" min="0" step="1" placeholder="ä¾‹ï¼š800" class="rar-avg" />
        </div>
        <div>
          <label>ç®±ã‚ãŸã‚Šå°å…¥æšæ•°</label>
          <input type="number" min="0" step="0.01" placeholder="ä¾‹ï¼š5" class="rar-cpb" />
        </div>
        <div>
          <label>ã‚«ãƒ¼ãƒ‰ç¨®æ•°ï¼ˆä»»æ„ï¼‰</label>
          <input type="number" min="0" step="1" placeholder="ä¾‹ï¼š12" class="rar-types" />
        </div>
      </div>
      <details style="margin-top:8px;">
        <summary class="hint">â–¼ ä¸Šç´šï¼šã‚«ãƒ¼ãƒ‰åˆ¥ã®è²·å–é¡ã‚’è²¼ã‚‹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰â†’ å¹³å‡ã«åæ˜ </summary>
        <textarea rows="3" class="rar-list" placeholder="ä¾‹ï¼š1200, 900, 300, 200, 150 ..."></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button type="button" class="btn small ghost btn-calc-avg">å¹³å‡ã¸åæ˜ </button>
          <span class="note">â€» åŠè§’ã‚«ãƒ³ãƒ/ã‚¹ãƒšãƒ¼ã‚¹/æ”¹è¡Œã§åŒºåˆ‡ã‚Šã€‚æ•°å€¤ã‚’æŠ½å‡ºã—ã¾ã™</span>
        </div>
      </details>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button type="button" class="btn small ghost btn-dup">è¤‡è£½</button>
        <button type="button" class="btn small bad btn-del">å‰Šé™¤</button>
      </div>
    </div>
  </template>

  <template id="srcRowTpl">
    <div class="src-row">
      <input type="text" placeholder="https://...ï¼ˆã‚«ãƒ¼ãƒ‰ãƒ©ãƒƒã‚·ãƒ¥/é§¿æ²³å±‹/éŠã€…äº­/ãƒ¡ãƒ«ã‚«ãƒª ç­‰ï¼‰" class="src-url" />
      <button type="button" class="btn small ghost btn-src-del">å‰Šé™¤</button>
    </div>
  </template>

  <script>
  const $  = (q, el=document) => el.querySelector(q);
  const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

  const els = {
    boxName: $('#boxName'),
    boxPrice: $('#boxPrice'),
    packsPerBox: $('#packsPerBox'),
    memo: $('#memo'),
    rarityList: $('#rarityList'),
    sources: $('#sources'),
    evPerPack: $('#evPerPack'),
    evPerBox: $('#evPerBox'),
    roi: $('#roi'),
    evpin: $('#evpin'),
    evBreakdown: $('#evBreakdown'),
    rakutenBtn: $('#rakutenBtn'),
    amazonBtn: $('#amazonBtn'),
    dlg: $('#dlg-settings'),
    apiEndpoint: $('#apiEndpoint'),
    apiTimeout: $('#apiTimeout'),
    rakutenParams: $('#rakutenParams'),
    amazonParams: $('#amazonParams'),
    adsClient: $('#adsClient'),
    adsSlot: $('#adsSlot'),
    adsenseSlot: $('#adsenseSlot'),
  };

  const fmt = (n) => isFinite(n) ? n.toLocaleString('ja-JP', { maximumFractionDigits: 2 }) : 'â€”';

  function addRarityRow(data={}) {
    const tpl = document.getElementById('rarityRowTpl');
    const node = tpl.content.firstElementChild.cloneNode(true);
    if (data.name)  node.querySelector('.rar-name').value  = data.name;
    if (data.avg!=null)   node.querySelector('.rar-avg').value   = data.avg;
    if (data.cpb!=null)   node.querySelector('.rar-cpb').value   = data.cpb;
    if (data.types!=null) node.querySelector('.rar-types').value = data.types;
    if (data.list)  node.querySelector('.rar-list').value  = data.list;

    node.querySelector('.btn-del').addEventListener('click', ()=> node.remove());
    node.querySelector('.btn-dup').addEventListener('click', ()=> {
      const d = readRarityRow(node);
      addRarityRow(d);
    });
    node.querySelector('.btn-calc-avg').addEventListener('click', ()=> {
      const txt = node.querySelector('.rar-list').value || '';
      const vals = txt.split(/[^0-9.]+/).map(v=>parseFloat(v)).filter(v=>!isNaN(v));
      if (!vals.length) return alert('æ•°å€¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      node.querySelector('.rar-avg').value = Math.round(avg);
      node.querySelector('.rar-types').value = vals.length;
    });

    els.rarityList.appendChild(node);
  }

  function readRarityRow(node){
    return {
      name:  node.querySelector('.rar-name').value.trim(),
      avg:   parseFloat(node.querySelector('.rar-avg').value),
      cpb:   parseFloat(node.querySelector('.rar-cpb').value),
      types: parseInt(node.querySelector('.rar-types').value,10) || null,
      list:  node.querySelector('.rar-list').value.trim()
    };
  }

  function addSourceRow(url=''){
    const tpl = document.getElementById('srcRowTpl');
    const node = tpl.content.firstElementChild.cloneNode(true);
    node.querySelector('.src-url').value = url;
    node.querySelector('.btn-src-del').addEventListener('click', ()=> node.remove());
    els.sources.appendChild(node);
  }

  function readAll(){
    return {
      boxName: els.boxName.value.trim(),
      boxPrice: parseFloat(els.boxPrice.value) || 0,
      packsPerBox: parseInt(els.packsPerBox.value,10) || 1,
      memo: els.memo.value.trim(),
      rarities: $$('.rar-item').map(readRarityRow),
      sources: $$('.src-url').map(i=> i.value.trim()).filter(Boolean),
      settings: readSettings(),
      ts: Date.now(),
    };
  }

  function calcEV(data){
    let evBox = 0;
    const lines = [];
    for (const r of data.rarities){
      if (!isFinite(r.avg) || !isFinite(r.cpb)) continue;
      const partBox = r.avg * r.cpb;
      evBox += partBox;
      lines.push(`${r.name || 'ï¼ˆåç§°æœªå…¥åŠ›ï¼‰'}ï¼š å¹³å‡Â¥${fmt(r.avg)} Ã— ${r.cpb}æš/ç®± = Â¥${fmt(partBox)}`);
    }
    const evPack = evBox / (data.packsPerBox || 1);
    const roi = data.boxPrice ? (evBox / data.boxPrice) : NaN;
    return { evBox, evPack, roi, lines };
  }

  function updateView(){
    const d = readAll();
    const { evBox, evPack, roi, lines } = calcEV(d);
    els.evPerPack.textContent = isFinite(evPack) ? `Â¥${fmt(evPack)}` : 'â€”';
    els.evPerBox.textContent  = isFinite(evBox)  ? `Â¥${fmt(evBox)}`  : 'â€”';
    els.roi.textContent       = isFinite(roi)    ? `${(roi*100).toFixed(1)}%` : 'â€”';

    const pct = Math.max(0, Math.min(100, isFinite(roi) ? roi*100 : 0));
    els.evpin.style.left = `${pct}%`;

    const sourcesHtml = d.sources.length ? `\nå‚ç…§URLï¼š\n- ` + d.sources.join(`\n- `) : '';
    els.evBreakdown.textContent = lines.length ? lines.join('\n') + sourcesHtml : 'ï¼ˆå…¥åŠ›å¾Œã«è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰';

    updateAffiliateLinks(d.boxName);
  }

  function save(){
    const d = readAll();
    localStorage.setItem('ygo_box_ev_light', JSON.stringify(d));
    alert('ä¿å­˜ã—ã¾ã—ãŸ');
  }

  function load(){
    const raw = localStorage.getItem('ygo_box_ev_light');
    if (!raw) return alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    const d = JSON.parse(raw);
    els.boxName.value = d.boxName || '';
    els.boxPrice.value = d.boxPrice || '';
    els.packsPerBox.value = d.packsPerBox || '';
    els.memo.value = d.memo || '';

    els.rarityList.innerHTML = '';
    (d.rarities || []).forEach(addRarityRow);

    els.sources.innerHTML = '';
    (d.sources || []).forEach(addSourceRow);

    if (d.settings) writeSettings(d.settings);
    updateView();
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(readAll(), null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: 'ygo_box_ev.json' });
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(){
    const inp = Object.assign(document.createElement('input'), { type: 'file', accept: 'application/json' });
    inp.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const d = JSON.parse(fr.result);
          localStorage.setItem('ygo_box_ev_light', JSON.stringify(d));
          load();
        }catch(err){ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };
      fr.readAsText(file);
    });
    inp.click();
  }

  /* ===== è‡ªå‹•å…¥åŠ›ï¼ˆÎ²ï¼‰ï¼šç®±åâ†’å¤–éƒ¨APIå‘¼ã³å‡ºã— =====
     æ³¨æ„ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ã‚·ãƒ§ãƒƒãƒ—ã‚µã‚¤ãƒˆã‚’ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¨è¦ç´„/CORSã§å¤±æ•—ã—ã¾ã™ã€‚
           è‡ªå‰ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ç­‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆâ†’æ•´å½¢æ¸ˆã¿JSONã‚’è¿”ã™è¨­è¨ˆã€‚
           æœŸå¾…ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
           {
             "rarities":[{"name":"UR","avg":1200,"cpb":2,"types":10}, ...],
             "sources":["https://...","https://..."]
           }
  */
  async function autoFillFromAPI(){
    const name = els.boxName.value.trim();
    if (!name) return alert('ãƒœãƒƒã‚¯ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    const { endpoint, timeoutSec } = getApiConf();
    if (!endpoint) return alert('è¨­å®šï¼è‡ªå‹•å…¥åŠ›APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');

    try{
      const ctrl = new AbortController();
      const t = setTimeout(()=> ctrl.abort(), (timeoutSec||10)*1000);
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: name }),
        signal: ctrl.signal
      });
      clearTimeout(t);
      if (!res.ok) throw new Error('APIã‚¨ãƒ©ãƒ¼: ' + res.status);
      const data = await res.json();

      if (Array.isArray(data.rarities)){
        els.rarityList.innerHTML='';
        data.rarities.forEach(r => addRarityRow(r));
      }
      if (Array.isArray(data.sources)){
        els.sources.innerHTML='';
        data.sources.forEach(u => addSourceRow(u));
      }
      updateView();
      alert('è‡ªå‹•å…¥åŠ›ã‚’åæ˜ ã—ã¾ã—ãŸ');
    }catch(err){
      console.error(err);
      alert('è‡ªå‹•å…¥åŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIè¨­å®šã‚„CORSã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
    }
  }

  /* ===== ã‚¢ãƒ•ã‚£ãƒªãƒ³ã‚¯ç”Ÿæˆ ===== */
  function updateAffiliateLinks(boxName){
    const q = encodeURIComponent(boxName || 'éŠæˆ¯ç‹ ãƒœãƒƒã‚¯ã‚¹');
    const st = readSettings();
    const rakutenBase = `https://search.rakuten.co.jp/search/mall/${q}/`;
    const amazonBase  = `https://www.amazon.co.jp/s?k=${q}`;

    els.rakutenBtn.href = st.rakutenParams ? (rakutenBase + st.rakutenParams) : rakutenBase;
    els.amazonBtn.href  = st.amazonParams  ? (amazonBase  + st.amazonParams)  : amazonBase;
  }

  /* ===== è¨­å®šä¿å­˜ï¼èª­è¾¼ & AdSenseæŒ¿å…¥ ===== */
  function readSettings(){
    return {
      endpoint: localStorage.getItem('ygo_api_endpoint') || '',
      timeoutSec: parseInt(localStorage.getItem('ygo_api_timeout')||'10',10),
      rakutenParams: localStorage.getItem('ygo_rakuten_params') || '',
      amazonParams: localStorage.getItem('ygo_amazon_params') || '',
      adsClient: localStorage.getItem('ygo_ads_client') || '',
      adsSlot: localStorage.getItem('ygo_ads_slot') || ''
    };
  }
  function writeSettings(s){
    if (s.endpoint!=null)     localStorage.setItem('ygo_api_endpoint', s.endpoint);
    if (s.timeoutSec!=null)   localStorage.setItem('ygo_api_timeout', String(s.timeoutSec));
    if (s.rakutenParams!=null)localStorage.setItem('ygo_rakuten_params', s.rakutenParams);
    if (s.amazonParams!=null) localStorage.setItem('ygo_amazon_params', s.amazonParams);
    if (s.adsClient!=null)    localStorage.setItem('ygo_ads_client', s.adsClient);
    if (s.adsSlot!=null)      localStorage.setItem('ygo_ads_slot', s.adsSlot);
    applyAdsense();
  }
  function getApiConf(){
    const s = readSettings();
    els.apiEndpoint.value = s.endpoint; els.apiTimeout.value = s.timeoutSec;
    return { endpoint: s.endpoint, timeoutSec: s.timeoutSec };
  }
  function applyAdsense(){
    const s = readSettings();
    els.adsenseSlot.innerHTML = '';
    if (s.adsClient && s.adsSlot){
      const sc = document.createElement('script');
      sc.async = true; sc.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${encodeURIComponent(s.adsClient)}`;
      sc.crossOrigin = 'anonymous';
      document.head.appendChild(sc);
      const ins = document.createElement('ins');
      ins.className = 'adsbygoogle';
      ins.style.display = 'block';
      ins.setAttribute('data-ad-client', s.adsClient);
      ins.setAttribute('data-ad-slot', s.adsSlot);
      ins.setAttribute('data-ad-format', 'auto');
      ins.setAttribute('data-full-width-responsive', 'true');
      els.adsenseSlot.appendChild(ins);
      const push = document.createElement('script');
      push.text = '(adsbygoogle = window.adsbygoogle || []).push({});';
      els.adsenseSlot.appendChild(push);
    }
  }

  // åˆæœŸåŒ–
  (function init(){
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    document.getElementById('btn-addRarity').addEventListener('click', ()=> addRarityRow());
    document.getElementById('btn-addTemplate').addEventListener('click', ()=> {
      addRarityRow({ name:'UR', avg:'', cpb:'2',   types:'' });
      addRarityRow({ name:'SR', avg:'', cpb:'5',   types:'' });
      addRarityRow({ name:'SE/Prismatic', avg:'', cpb:'0.5', types:'' });
    });

    document.getElementById('btn-addSrc').addEventListener('click', ()=> addSourceRow(''));
    document.getElementById('btn-calc').addEventListener('click', updateView);
    document.getElementById('btn-save').addEventListener('click', save);
    document.getElementById('btn-load').addEventListener('click', load);
    document.getElementById('btn-reset').addEventListener('click', ()=> { localStorage.removeItem('ygo_box_ev_light'); location.reload(); });
    document.getElementById('btn-export').addEventListener('click', exportJSON);
    document.getElementById('btn-import').addEventListener('click', importJSON);

    document.getElementById('btn-settings').addEventListener('click', ()=> els.dlg.showModal());
    document.getElementById('btn-close-settings').addEventListener('click', ()=> els.dlg.close());
    document.getElementById('btn-settings-cancel').addEventListener('click', ()=> els.dlg.close());
    document.getElementById('btn-settings-save').addEventListener('click', ()=>{
      writeSettings({
        endpoint: els.apiEndpoint.value.trim(),
        timeoutSec: parseInt(els.apiTimeout.value||'10',10),
        rakutenParams: els.rakutenParams.value.trim(),
        amazonParams: els.amazonParams.value.trim(),
        adsClient: els.adsClient.value.trim(),
        adsSlot: els.adsSlot.value.trim(),
      });
      alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      els.dlg.close();
      updateView();
    });

    document.getElementById('btn-autoFill').addEventListener('click', autoFillFromAPI);
    document.getElementById('btn-affGen').addEventListener('click', ()=> updateAffiliateLinks(els.boxName.value.trim()));

    // åˆæœŸçŠ¶æ…‹
    addRarityRow();
    addSourceRow('');
    applyAdsense();

    ['input','change'].forEach(evt => {
      document.addEventListener(evt, (e)=>{
        if (e.target.closest('.rar-item') || ['boxName','boxPrice','packsPerBox'].includes(e.target.id)) {
          updateView();
        }
      });
    });

    updateView();
  })();
  </script>
</body>
</html>
