<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«ã®æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
<meta name="description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒãªã©ä¸»è¦ãƒˆãƒ¬ã‚«ã®ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ã‚’è‡ªå‹•é›†è¨ˆã€‚å¹³å‡è²·å–ã‹ã‚‰å›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯EVã‚’è¨ˆç®—ã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€‚">
<meta name="keywords" content="éŠæˆ¯ç‹,ãƒã‚±ã‚«,ãƒˆãƒ¬ã‚«,æœŸå¾…å€¤,å›åç‡,ãƒœãƒƒã‚¯ã‚¹,ç›¸å ´,è²·å–,ãƒ©ãƒ³ã‚­ãƒ³ã‚°">
<meta name="robots" content="index,follow">
<meta name="geo.region" content="JP">
<meta name="geo.placename" content="Japan">
<meta property="og:title" content="ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«ã®æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°">
<meta property="og:description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œã€‚å›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’è¦‹ã‚„ã™ãæ¯”è¼ƒã§ãã¾ã™ã€‚">
<meta property="og:type" content="website">
<link rel="icon" href="assets/favicon.ico">

<!-- Tailwind / DataTables / noUiSlider -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">

<style>
  /* å…±é€š */
  .badge { display:inline-block; padding:0.1rem .4rem; border-radius:.25rem; background:#fde68a; color:#92400e; font-size:.75rem; }
  .thumb { width:56px; height:56px; object-fit:cover; border-radius:.5rem; border:1px solid #e5e7eb; }
  .tab-btn { padding:.45rem .8rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
  .tab-btn.active { background:#fef3c7; border-color:#f59e0b; color:#92400e; }
  .range-pill { background:#111827; color:#fff; border-radius:9999px; padding:.2rem .6rem; font-size:.75rem; }
  .pr-card { border:1px solid #fcd34d; border-radius:.75rem; background:#fffbea; }
  .is-top { background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px #fbbf24; }

  /* DataTables èª¿æ•´ */
  .dt-container .dataTables_filter input { border:1px solid #cbd5e1; }
  table.dataTable thead th, table.dataTable tbody td { white-space:nowrap; }
  .dt-container { overflow-x:auto; }

  /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é‡ãªã‚Šå¯¾ç­– */
  .filter-bar { position:relative; z-index:10; }
  #rankingTable { position:relative; z-index:1; }

  /* PCãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ¡ãƒªãƒãƒª */
  @media (min-width:1024px){
    header .title-lg { font-size:2.25rem; }  /* 36px */
    header .sub-lg { font-size:1rem; color:#6b7280; }
    main .section { padding:1.25rem 1.5rem; border-radius:14px; }
    #rankingTable_wrapper { padding-top:.75rem; }
    .filter-grid { display:grid; grid-template-columns: 1fr 1fr auto; gap:1.25rem; align-items:end; }
    .filter-card { padding:1rem; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
  }
</style>

<!-- GA4 / Clarity ã¯å¿…è¦æ™‚ã«æœ‰åŠ¹åŒ–
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XXXXXXX');</script>
<script>(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window,document,"clarity","script","CLARITY-ID");</script>
-->
</head>

<body class="bg-gray-50 text-gray-900">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="py-6 border-b border-gray-200 bg-white shadow-sm">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="title-lg font-extrabold text-yellow-600 tracking-tight">ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²</h1>
        <p class="sub-lg mt-1">éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œï½œå›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯EVã‚’æ¯”è¼ƒ</p>
      </div>
      <span class="hidden lg:inline-block badge">PRã‚’å«ã¿ã¾ã™</span>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- â‘  ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <section id="ranking" class="mb-8">
    <div class="flex items-end justify-between">
      <h2 class="text-2xl font-semibold mb-3">ğŸ“Š æœ€æ–°æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
    </div>

    <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç¾¤ï¼ˆç‹¬ç«‹ãƒãƒ¼ï¼‰ -->
    <div class="filter-bar mb-4">
      <div class="filter-grid">
        <div class="filter-card">
          <div class="flex items-center justify-between mb-2">
            <label class="font-medium">å›åç‡ï¼ˆROI %ï¼‰</label>
            <span id="roiRange" class="range-pill">â€”</span>
          </div>
          <div id="roiSlider"></div>
        </div>
        <div class="filter-card">
          <div class="flex items-center justify-between mb-2">
            <label class="font-medium">ç®±ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
            <span id="priceRange" class="range-pill">â€”</span>
          </div>
          <div id="priceSlider"></div>
        </div>
        <div class="hidden lg:block text-right">
          <div class="text-xs text-gray-500 mb-1">è¡¨ç¤ºä»¶æ•°</div>
          <select id="pageSize" class="border rounded p-2">
            <option>10</option><option>25</option><option>50</option>
          </select>
        </div>
      </div>
    </div>

    <table id="rankingTable" class="stripe hover w-full text-sm bg-white rounded shadow"></table>
    <p class="text-xs text-gray-500 mt-2">â€» ãƒ‡ãƒ¼ã‚¿ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã—ã¾ã›ã‚“ã€‚ä¾¡æ ¼ã¯å¤‰å‹•ã—ã¾ã™ã€‚</p>
  </section>

  <!-- â‘¤ PRæ  -->
  <section class="mb-10">
    <div class="pr-card p-4 flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">ã€PRã€‘äººæ°—ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½å¤© / Amazonï¼‰</div>
        <div class="text-xs text-gray-500">ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™</div>
      </div>
      <div class="flex gap-3">
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 bg-yellow-400 hover:bg-yellow-500 text-white rounded">æ¥½å¤©</a>
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 bg-gray-800 hover:bg-black text-white rounded">Amazon</a>
      </div>
    </div>
  </section>

  <!-- â‘¢ å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ï¼ˆã‚¿ãƒ–åˆ‡æ›¿ï¼‰ -->
  <section id="all" class="mb-12">
    <div class="flex items-end justify-between mb-3">
      <h3 class="text-2xl font-semibold">ğŸ“š å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§</h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm bg-white rounded shadow"></table>
  </section>

  <!-- â‘£ è‡ªåˆ†ã§è¨ˆç®— -->
  <section id="calc" class="bg-white rounded-xl shadow p-6 mb-12">
    <h3 class="text-xl font-semibold mb-4">ğŸ§® è‡ªåˆ†ã§è¨ˆç®—ã—ã¦ã¿ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¯ï¼‰</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰
        <input type="text" id="c_title" class="border p-2 w-full" placeholder="ä¾‹ï¼šè‡ªåˆ†ç”¨ãƒ†ã‚¹ãƒˆè¨ˆç®—">
      </label>
      <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆå††ï¼‰
        <input type="number" id="c_packPrice" class="border p-2 w-full" value="200" min="0">
      </label>
      <label>ãƒ‘ãƒƒã‚¯æ•°ï¼ˆç®±ï¼‰
        <input type="number" id="c_packCount" class="border p-2 w-full" value="30" min="1">
      </label>
    </div>
    <div id="rarityRows" class="grid md:grid-cols-3 gap-4 mt-4"></div>
    <div class="mt-3">
      <button id="addRarity" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">ï¼‹ ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¿½åŠ </button>
      <button id="calcBtn" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded ml-2">è¨ˆç®—ã™ã‚‹</button>
      <button id="saveCalc" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded ml-2">ä¿å­˜</button>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>
    <div class="mt-6">
      <h4 class="font-semibold mb-2">ğŸ’¾ ä¿å­˜å±¥æ­´</h4>
      <table id="historyTable" class="stripe hover w-full text-sm bg-white rounded shadow"></table>
    </div>
  </section>

  <!-- â‘¥ åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ -->
  <section id="legal" class="bg-gray-100 rounded-xl p-6">
    <h3 class="text-xl font-semibold mb-3">ğŸ“œ åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h3>
    <details class="mb-2" open>
      <summary class="cursor-pointer font-medium">åˆ©ç”¨è¦ç´„ï¼ˆè¦æ—¨ï¼‰</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€æŠ•è³‡åŠ©è¨€ç­‰ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ²è¼‰æƒ…å ±ã®æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ãƒ»æœ€æ–°æ€§ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ã”åˆ©ç”¨ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
      </p>
    </details>
    <details class="mb-2">
      <summary class="cursor-pointer font-medium">å…è²¬äº‹é …</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        ä¾¡æ ¼ãƒ»ç›¸å ´ã¯å¤‰å‹•ã—ã¾ã™ã€‚å¤–éƒ¨ã‚µã‚¤ãƒˆã®ä»•æ§˜å¤‰æ›´ãƒ»ã‚¢ã‚¯ã‚»ã‚¹éšœå®³ãƒ»æƒ…å ±é…å»¶ç­‰ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚å½“æ–¹ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
      </p>
    </details>
    <details>
      <summary class="cursor-pointer font-medium">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        æœ¬ã‚µã‚¤ãƒˆã¯åˆ©ç”¨çŠ¶æ³ã®æŠŠæ¡ã®ãŸã‚è§£æãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚Cookieç­‰ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€åŒæ„ã®ä¸Šã”åˆ©ç”¨ãã ã•ã„ã€‚æŠ•ç¨¿æ©Ÿèƒ½ï¼ˆå°†æ¥æä¾›äºˆå®šï¼‰ã§ã¯ã€æŠ•ç¨¿è€…ã®åŒæ„ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šæ‰±ã„ã¾ã™ã€‚
      </p>
    </details>
  </section>

</main>

<footer class="text-center text-gray-600 text-sm py-6 border-t border-gray-200 bg-white mt-12">
  <p>Â© 2025 ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î² | ãƒ‡ãƒ¼ã‚¿å‚è€ƒ: CardRush / ãƒˆãƒ¬ã‚³ãƒ­ / ãƒ¡ãƒ«ã‚«ãƒª / yugioh-starter.com</p>
  <p class="text-xs mt-2">æœ¬ãƒšãƒ¼ã‚¸ã«ã¯åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ï¼ˆPRï¼‰ã€‚</p>
</footer>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

<script>
(async function(){
  // JSONèª­ã¿è¾¼ã¿
  let data = [];
  try {
    const r = await fetch('torekadata.json', {cache:'no-store'});
    data = await r.json();
  } catch(e){
    console.error(e);
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚/data/torekadata.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // æ•´å½¢ï¼šæ•°å€¤åŒ–ï¼†è£œå®Œ
  data = data.map(d => {
    const n = x => (x === null || x === undefined || x === '' || isNaN(Number(x))) ? 0 : Number(x);
    const roiNum = d.roi ? Number(d.roi) : ( (n(d.avgBuyTotal) && n(d.boxPrice)) ? (n(d.avgBuyTotal)/n(d.boxPrice)) : 0 );
    return {
      ...d,
      game: d.game || 'OTH',
      releaseDate: d.releaseDate || '',
      boxPrice: n(d.boxPrice),
      avgBuyTotal: n(d.avgBuyTotal),
      packEV: n(d.packEV),
      roi: roiNum,
      roi_pct: d.roi_pct || (roiNum ? (roiNum*100).toFixed(1)+'%' : ''),
      affiliateImage: d.affiliateImage || '',
      affiliateUrl: d.affiliateUrl || ''
    };
  });

  /* ================= â‘  ãƒ©ãƒ³ã‚­ãƒ³ã‚° ================= */
  const rankingColumns = [
    { title: "ã‚²ãƒ¼ãƒ ", data: "game", visible:false },
    {
      title: "å•†å“",
      data: null,
      render: function(_, __, row){
        const img = row.affiliateImage ?
          `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">` :
          `<div class="thumb bg-gray-100"></div>`;
        const name = row.boxName || "-";
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        const sub = `${row.game}ï½œ${row.releaseDate || ''}`;
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${name}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${sub}</div>
                  </div>
                </div>`;
      }
    },
    { title: "ç™ºå£²", data: "releaseDate" },
    { title: "ç®±(å††)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "æœŸå¾…(å††)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1P EV", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "ROI", data: "roi_pct" },
    { title: "roiNum", data: "roi", visible: false }
  ];

  const rankingDT = $('#rankingTable').DataTable({
    data,
    columns: rankingColumns,
    order: [[7, "desc"]],
    pageLength: 10,
    autoWidth: false,
    scrollX: true,
    fixedHeader: true,
    columnDefs: [
      { targets: 2, width: 96 },
      { targets: 3, width: 110 },
      { targets: 4, width: 110 },
      { targets: 5, width: 100 },
      { targets: 6, width: 85 }
    ],
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  // Top3å¼·èª¿
  function highlightTop3(){
    $(rankingDT.rows().nodes()).removeClass('is-top');
    const idx = rankingDT.rows({search:'applied', order:'applied'}).indexes().toArray().slice(0,3);
    idx.forEach(i => $(rankingDT.row(i).node()).addClass('is-top'));
  }
  rankingDT.on('draw', highlightTop3);
  highlightTop3();

  /* =============== â‘¡ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆROI/ä¾¡æ ¼ï¼‰ =============== */
  const roiVals = data.map(d=>Math.round((d.roi||0)*100)).filter(x=>isFinite(x));
  const priceVals = data.map(d=>Number(d.boxPrice||0)).filter(x=>isFinite(x));

  const roiMin = roiVals.length? Math.min(...roiVals):0;
  const roiMax = roiVals.length? Math.max(...roiVals):200;
  const priceMin = priceVals.length? Math.min(...priceVals):0;
  const priceMax = priceVals.length? Math.max(...priceVals):15000;

  function percentile(arr, p){
    if (!arr.length) return 0;
    const s=[...arr].sort((a,b)=>a-b);
    const idx=Math.min(s.length-1,Math.max(0,Math.round((p/100)*(s.length-1))));
    return s[idx];
  }
  const roiStart = [ Math.floor(percentile(roiVals,10)), Math.ceil(percentile(roiVals,90)) ];
  const priceStart = [ Math.floor(percentile(priceVals,10)), Math.ceil(percentile(priceVals,90)) ];

  const roiSlider = document.getElementById('roiSlider');
  const priceSlider = document.getElementById('priceSlider');
  noUiSlider.create(roiSlider,{ start: roiStart, connect:true, step:1, range:{min:0,max:Math.max(200,roiMax)} });
  noUiSlider.create(priceSlider,{ start: priceStart, connect:true, step:100, range:{min:0,max:Math.max(20000,priceMax)} });

  const roiRangeEl = document.getElementById('roiRange');
  const priceRangeEl = document.getElementById('priceRange');

  function applyFilters(){
    const [rMin, rMax] = roiSlider.noUiSlider.get().map(Number);
    const [pMin, pMax] = priceSlider.noUiSlider.get().map(Number);
    roiRangeEl.textContent = `${Math.round(rMin)}% ã€œ ${Math.round(rMax)}%`;
    priceRangeEl.textContent = `${Math.round(pMin).toLocaleString()}å†† ã€œ ${Math.round(pMax).toLocaleString()}å††`;

    $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(f => !f.__isTorekaFilter);
    $.fn.dataTable.ext.search.push(function(settings, dataArr, dataIndex){
      if (settings.nTable.id !== 'rankingTable') return true;
      const roiNum = Number(rankingDT.row(dataIndex).data().roi||0)*100;
      const price = Number(rankingDT.row(dataIndex).data().boxPrice||0);
      return (roiNum >= rMin && roiNum <= rMax && price >= pMin && price <= pMax);
    });
    $.fn.dataTable.ext.search[$.fn.dataTable.ext.search.length-1].__isTorekaFilter = true;
    rankingDT.draw();
  }
  roiSlider.noUiSlider.on('update', applyFilters);
  priceSlider.noUiSlider.on('update', applyFilters);
  $('#pageSize').on('change', function(){ rankingDT.page.len(Number(this.value)).draw(); });
  applyFilters();

  /* =============== â‘¢ å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ï¼ˆã‚¿ãƒ–åˆ‡æ›¿ï¼‰ =============== */
  const games = Array.from(new Set(data.map(d=>d.game||'OTH')));
  const tabsWrap = document.getElementById('gameTabs');
  const makeBtn = (label) => {
    const b = document.createElement('button');
    b.className = 'tab-btn'; b.textContent = label; b.dataset.game = label;
    b.addEventListener('click', ()=> setGameFilter(label));
    return b;
  };
  tabsWrap.appendChild(makeBtn('ALL'));
  games.forEach(g => tabsWrap.appendChild(makeBtn(g)));
  function activateTab(label){ [...tabsWrap.children].forEach(el => el.classList.toggle('active', el.textContent === label)); }

  const allColumns = [
    { title: "ã‚²ãƒ¼ãƒ ", data: "game" },
    {
      title: "å•†å“",
      data: null,
      render: function(_, __, row){
        const img = row.affiliateImage ? `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">` : `<div class="thumb bg-gray-100"></div>`;
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${row.boxName||'-'}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${row.releaseDate||''}</div>
                  </div>
                </div>`;
      }
    },
    { title: "ç®±(å††)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "æœŸå¾…(å††)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1P EV", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "ROI", data: "roi_pct" },
  ];

  const allDT = $('#allTable').DataTable({
    data,
    columns: allColumns,
    order: [[0,'asc'],[5,'desc']],
    pageLength: 10,
    autoWidth:false,
    scrollX:true
  });

  function setGameFilter(label){
    activateTab(label);
    if (label === 'ALL') { allDT.column(0).search('').draw(); }
    else { allDT.column(0).search('^'+label+'$', true, false).draw(); }
  }
  setGameFilter('ALL');

  /* =============== â‘£ è‡ªåˆ†ã§è¨ˆç®—ï¼ˆLocalStorageï¼‰ =============== */
  const rarityRows = document.getElementById('rarityRows');
  let rarityCount = 0;
  function addRarity(avg=0, cpb=0){
    if (rarityCount >= 6) return;
    rarityCount++;
    const wrap = document.createElement('div');
    wrap.className = 'border rounded p-3 bg-white';
    wrap.innerHTML = `
      <div class="font-medium mb-2">ãƒ¬ã‚¢${rarityCount}</div>
      <label class="block text-sm">å¹³å‡è²·å–ï¼ˆå††ï¼‰
        <input type="number" class="r-avg border p-2 w-full mt-1" value="${avg}">
      </label>
      <label class="block text-sm mt-2">å°å…¥æ•°ï¼ˆæšï¼‰
        <input type="number" class="r-cpb border p-2 w-full mt-1" value="${cpb}">
      </label>
      <button type="button" class="mt-2 text-xs text-red-600 underline remove">å‰Šé™¤</button>
    `;
    wrap.querySelector('.remove').addEventListener('click', ()=>{ rarityRows.removeChild(wrap); rarityCount--; });
    rarityRows.appendChild(wrap);
  }
  addRarity(900,3); addRarity(450,6);
  document.getElementById('addRarity').addEventListener('click', ()=> addRarity());

  function calcNow(){
    const n = v => (v===''||v===null||isNaN(Number(v)))?0:Number(v);
    const packPrice = n(document.getElementById('c_packPrice').value);
    const packCount = Math.max(1, n(document.getElementById('c_packCount').value));
    const boxPrice = packPrice * packCount;
    let ev = 0;
    rarityRows.querySelectorAll('.border').forEach(box=>{
      ev += n(box.querySelector('.r-avg').value) * n(box.querySelector('.r-cpb').value);
    });
    const packEV = Math.round(ev/packCount);
    const roi = boxPrice? (ev/boxPrice):0;
    const roiPct = (roi*100).toFixed(1)+'%';
    document.getElementById('calcResult').textContent =
      `ç®±ä¾¡æ ¼ï¼š${boxPrice.toLocaleString()}å†† ï¼ æœŸå¾…å€¤ï¼š${ev.toLocaleString()}å†† ï¼ 1ãƒ‘ãƒƒã‚¯EVï¼š${packEV.toLocaleString()}å†† ï¼ ROIï¼š${roiPct}`;
    return {boxPrice, ev, packEV, roi, roiPct};
  }
  document.getElementById('calcBtn').addEventListener('click', calcNow);

  const STORAGE_KEY = 'toreka_calc_history_v1';
  const hisDT = $('#historyTable').DataTable({
    data: [],
    columns: [
      { title: "ã‚¿ã‚¤ãƒˆãƒ«", data: "title" },
      { title: "ç®±ä¾¡æ ¼", data: "boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title: "æœŸå¾…å€¤", data: "ev", render:v=>Number(v||0).toLocaleString() },
      { title: "1P EV", data: "packEV", render:v=>Number(v||0).toLocaleString() },
      { title: "ROI", data: "roiPct" },
      { title: "ä¿å­˜æ—¥æ™‚", data: "savedAt" }
    ],
    pageLength: 5,
    autoWidth:false,
    scrollX:true
  });

  function loadHistory(){
    try{
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      hisDT.clear().rows.add(arr).draw();
    }catch(e){}
  }
  loadHistory();

  document.getElementById('saveCalc').addEventListener('click', ()=>{
    const title = (document.getElementById('c_title').value || 'æœªã‚¿ã‚¤ãƒˆãƒ«').trim();
    const now = calcNow();
    const rec = { title, boxPrice: now.boxPrice, ev: now.ev, packEV: now.packEV, roi: now.roi, roiPct: now.roiPct, savedAt: new Date().toLocaleString() };
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    arr.unshift(rec);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,100)));
    loadHistory();
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰');
  });

})();
</script>
</body>
</html>

