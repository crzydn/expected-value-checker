<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pgTitle">BOX詳細 | トレカ期待値チェッカー β</title>
  <meta name="description" content="ボックスの回収率と1パック期待値の詳細。">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    .badge{ display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:#fff3cd; color:#92400e; font-size:.75rem; border:1px solid #ffe69c; }
    .thumb{ width:88px; height:88px; object-fit:cover; border-radius:.6rem; border:1px solid #e5e7eb; background:#f1f5f9; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<header class="py-6 border-b bg-white">
  <div class="max-w-5xl mx-auto px-4 flex items-center justify-between">
    <a href="index.html" class="font-bold">← ランキングへ</a>
    <span class="badge">PRを含みます</span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-8">
  <div id="boxCard" class="bg-white rounded-xl border p-5 shadow-sm"></div>
  <section class="mt-8 bg-white rounded-xl border p-5 shadow-sm">
    <h2 class="text-xl font-semibold mb-3">価格・期待値</h2>
    <div id="stats" class="grid sm:grid-cols-2 gap-4"></div>
  </section>
  <section class="mt-8 bg-white rounded-xl border p-5 shadow-sm">
    <h3 class="text-lg font-semibold mb-3">共有</h3>
    <div class="flex gap-2">
      <a id="share-line" class="px-3 py-2 rounded text-white" style="background:#06C755">LINEで共有</a>
      <a id="share-x" class="px-3 py-2 rounded text-white" style="background:#000">Xで共有</a>
    </div>
  </section>
  <section class="mt-8 text-xs text-gray-500">
    <p>※ 参考情報であり、投資助言ではありません。価格は変動します。</p>
  </section>
</main>

<script>
(async function(){
  /* ====== ここだけあなたのURLに変更 ====== */
  const WORKER_BASE = 'https://evchecker.crzydn.workers.dev';
  const SHEET_NAME  = 'トレカ期待値入力';
  /* ===================================== */

  const toNum = v => (typeof v==='number')?v:Number(String(v||'').replace(/[^\d.-]/g,'')||0);
  const toSlug = s => (String(s||'').toLowerCase().trim().replace(/[^\w一-龥ぁ-んァ-ヶ]+/g,'-').replace(/^-+|-+$/g,''));
  const params=new URL(location.href).searchParams;
  const slug=params.get('slug')||'';

  // データ取得
  let rows=[];
  try{
    const res=await fetch(`${WORKER_BASE}/gas?sheet=${encodeURIComponent(SHEET_NAME)}&ts=${Date.now()}`,{cache:'no-store'});
    const json=await res.json(); rows=(json&&json.data)||[];
  }catch(e){ document.getElementById('boxCard').innerHTML='<p>データ取得に失敗しました。</p>'; return; }

  const rec = rows
    .map(r => ({ ...r, __slug: r.slug || toSlug(r.boxName || r.boxname || r['ボックス名'] || '') }))
    .find(r => r.__slug === slug);

  if(!rec){ document.getElementById('boxCard').innerHTML='<p>該当データが見つかりませんでした。</p>'; return; }

  const name = rec.boxName || rec.boxname || rec['ボックス名'] || '';
  const boxPrice = toNum(rec.boxPrice||rec['箱価格']);
  const avgBuyTotal = toNum(rec.avgBuyTotal||rec['期待値合計']);
  const packEV = toNum(rec.packEV||rec['1P_EV']);
  const roi = rec.roi ? Number(rec.roi) : (boxPrice? avgBuyTotal/boxPrice:0);
  const roiPct = (roi*100).toFixed(1)+'%';

  const img = rec.affiliateImage || '';
  const aff = rec.affiliateUrl ? `<a href="${rec.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="badge ml-2">PR</a>` : '';

  document.title = `${name} | トレカ期待値チェッカー β`;
  document.getElementById('boxCard').innerHTML = `
    <div class="flex items-center gap-4">
      ${img ? `<img src="${img}" alt="${name}" class="thumb">` : `<div class="thumb"></div>`}
      <div>
        <h1 class="text-2xl font-bold">${name}${aff}</h1>
        <div class="text-sm text-gray-600">${rec.game||''}${rec.releaseDate?'｜'+rec.releaseDate:''}</div>
      </div>
    </div>`;

  document.getElementById('stats').innerHTML = `
    <div class="border rounded p-3"><div class="text-gray-500 text-sm">箱価格</div><div class="text-xl font-semibold">${boxPrice.toLocaleString()} 円</div></div>
    <div class="border rounded p-3"><div class="text-gray-500 text-sm">期待値合計</div><div class="text-xl font-semibold">${avgBuyTotal.toLocaleString()} 円</div></div>
    <div class="border rounded p-3"><div class="text-gray-500 text-sm">1パック期待値</div><div class="text-xl font-semibold">${packEV.toLocaleString()} 円</div></div>
    <div class="border rounded p-3"><div class="text-gray-500 text-sm">回収率</div><div class="text-xl font-semibold">${roiPct}</div></div>
  `;

  const pageUrl=location.href;
  document.getElementById('share-line').href=`https://line.me/R/msg/text/?${encodeURIComponent(name+'\n'+pageUrl)}`;
  document.getElementById('share-x').href   =`https://x.com/intent/tweet?text=${encodeURIComponent(name)}&url=${encodeURIComponent(pageUrl)}`;

  // JSON-LD（AEO/SEO）
  const ld = {
    "@context":"https://schema.org",
    "@type":"Product",
    "name": name,
    "category":"Trading Card Game Box",
    "brand": rec.game || "TCG",
    "releaseDate": rec.releaseDate || "",
    "offers":{"@type":"AggregateOffer","priceCurrency":"JPY","lowPrice": String(boxPrice||""), "highPrice": String(boxPrice||"")},
    "additionalProperty":[
      {"@type":"PropertyValue","name":"回収率","value": roiPct},
      {"@type":"PropertyValue","name":"1パック期待値","value": String(packEV||"")}
    ],
    "url": location.href
  };
  const s=document.createElement('script'); s.type='application/ld+json'; s.textContent=JSON.stringify(ld); document.head.appendChild(s);
})();
</script>
</body>
</html>
