<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œéŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œ</title>
<meta name="description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒãªã©ä¸»è¦ãƒˆãƒ¬ã‚«ã®ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ã‚’è‡ªå‹•é›†è¨ˆã€‚å¹³å‡è²·å–ã‹ã‚‰å›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯EVã‚’å¯è¦–åŒ–ã—ã¦æ¯”è¼ƒã§ãã¾ã™ã€‚">
<meta name="keywords" content="éŠæˆ¯ç‹,ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰,ãƒ´ã‚¡ã‚¤ã‚¹,ãƒ‡ãƒ¥ã‚¨ãƒ,ãƒˆãƒ¬ã‚«,æœŸå¾…å€¤,ãƒœãƒƒã‚¯ã‚¹,è²·å–,å›åç‡,ç›¸å ´,ã‚«ãƒ¼ãƒ‰ãƒ©ãƒƒã‚·ãƒ¥,ãƒˆãƒ¬ã‚³ãƒ­,ãƒ¡ãƒ«ã‚«ãƒª">
<meta name="robots" content="index,follow">
<meta name="author" content="ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²">
<meta name="geo.region" content="JP">
<meta name="geo.placename" content="Japan">
<meta property="og:title" content="ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°">
<meta property="og:description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œã®æœŸå¾…å€¤æ¯”è¼ƒã‚µã‚¤ãƒˆã€‚ROIãƒ»1ãƒ‘ãƒƒã‚¯EVã‚’è‡ªå‹•è¨ˆç®—ã€‚">
<meta property="og:type" content="website">
<meta property="og:image" content="assets/ogp.jpg">
<link rel="icon" href="assets/favicon.ico">

<!-- Tailwind (light theme base) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<!-- jQuery + DataTables -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- DataTables æ—¥æœ¬èª -->
<script src="https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json"></script>
<!-- noUiSlider for range filters -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css">
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.js"></script>
<!-- Chart.js for minor charts if needed later -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ã®ä¸Šä½å¼·èª¿ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ç¸ï¼‰ */
  table.dataTable tbody tr.rank-gold { outline: 2px solid #d4af37; outline-offset: -2px; background: #fffaf0; }
  /* ç”»åƒã‚µãƒ ãƒï¼ˆè¡¨å†…ï¼‰ */
  .thumb { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; border:1px solid #eee; }
  /* ã‚¿ãƒ– */
  .tab-btn { padding: .5rem .9rem; border:1px solid #e5e7eb; border-radius: .5rem; background:#fff; transition: .2s; }
  .tab-btn.active { background:#fde68a; border-color:#f59e0b; }
  /* PRæ ï¼ˆæ¨ªé•·ï¼‰ */
  .pr-banner { border:1px dashed #f59e0b; background:#fffdf5; }
  /* ãƒ¢ãƒã‚¤ãƒ«ã§è¡¨ã‚’æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  .table-wrap { overflow-x:auto; }
</style>

<!-- â˜… GA4 / Clarity ã¯å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã«è²¼ã£ã¦ãã ã•ã„ï¼ˆè¨ˆæ¸¬IDå·®ã—æ›¿ãˆï¼‰ 
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XXXXXXX');</script>
<script type="text/javascript"> (function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "CLARITY_ID"); </script>
-->

</head>
<body class="bg-gray-50 text-gray-900">

<header class="text-center py-6 border-b border-gray-200 bg-white shadow-sm">
  <h1 class="text-3xl font-extrabold text-yellow-600">ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²</h1>
  <p class="text-sm text-gray-600 mt-1">éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œ</p>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- â‘  ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ -->
  <section class="mb-8">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold">ğŸ“Š æœ€æ–°æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <p class="text-xs text-gray-500 mt-1">â€»PRã‚’å«ã¿ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã—ã¾ã›ã‚“ã€‚</p>
      </div>
      <!-- â‘¡ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§çµã‚Šè¾¼ã¿ -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium text-gray-700">å›åç‡ï¼ˆROI%ï¼‰ç¯„å›²</label>
          <div id="roiSlider" class="mt-2"></div>
          <div class="text-xs text-gray-600 mt-1" id="roiLabel">100% ã€œ 200%</div>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">ç®±ä¾¡æ ¼ï¼ˆå††ï¼‰ç¯„å›²</label>
          <div id="priceSlider" class="mt-2"></div>
          <div class="text-xs text-gray-600 mt-1" id="priceLabel">3,000 ã€œ 15,000</div>
        </div>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚¿ãƒ–ï¼ˆâ‘¢ å…¨ãƒˆãƒ¬ã‚«ãƒ»ã‚·ãƒªãƒ¼ã‚ºåˆ‡æ›¿ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ -->
    <div class="flex flex-wrap gap-2 mt-4">
      <button class="tab-btn active" data-game="ALL">ã™ã¹ã¦</button>
      <button class="tab-btn" data-game="YGO">éŠæˆ¯ç‹</button>
      <button class="tab-btn" data-game="PKM">ãƒã‚±ã‚«</button>
      <button class="tab-btn" data-game="WS">ãƒ´ã‚¡ã‚¤ã‚¹</button>
      <button class="tab-btn" data-game="DM">ãƒ‡ãƒ¥ã‚¨ãƒ</button>
      <button class="tab-btn" data-game="MTG">MTG</button>
    </div>

    <div class="table-wrap mt-4 bg-white rounded shadow p-2">
      <table id="torekaTable" class="display w-full text-sm"></table>
    </div>

    <!-- â‘¤ ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒ»åºƒå‘Šæ ï¼ˆæ¨ªé•·PRãƒãƒŠãƒ¼ï¼‰ -->
    <div class="pr-banner mt-4 p-4 rounded">
      <p class="text-xs text-gray-500 mb-2">â€»PRï¼ˆã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ï¼‰</p>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <a href="#" target="_blank" class="block border bg-white rounded p-3 hover:shadow">
          <div class="font-medium text-gray-800">æ¥½å¤© | ãƒˆãƒ¬ã‚«BOXç‰¹é›†</div>
          <div class="text-xs text-gray-500 mt-1">äººæ°—ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯</div>
        </a>
        <a href="#" target="_blank" class="block border bg-white rounded p-3 hover:shadow">
          <div class="font-medium text-gray-800">Amazon | ãƒˆãƒ¬ã‚« æ–°ç€ãƒ»äºˆç´„</div>
          <div class="text-xs text-gray-500 mt-1">æ–°ä½œã‚„å†å…¥è·ã‚’ç¢ºèª</div>
        </a>
        <a href="#" target="_blank" class="block border bg-white rounded p-3 hover:shadow">
          <div class="font-medium text-gray-800">é§¿æ²³å±‹ | BOXåœ¨åº«</div>
          <div class="text-xs text-gray-500 mt-1">åœ¨åº«ã¨ä¾¡æ ¼ã‚’æ¯”è¼ƒ</div>
        </a>
      </div>
    </div>
  </section>

  <!-- â‘£ è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ  -->
  <section class="bg-white rounded-xl shadow p-6">
    <h2 class="text-xl font-semibold mb-3">ğŸ§® è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹</h2>
    <p class="text-sm text-gray-600 mb-4">ã€Œè²©å£²ä¾¡æ ¼ã€ã€Œå°å…¥æ•°ã€ã€Œå¹³å‡è²·å–ã€ã‚’èª¿æ•´ã™ã‚‹ã¨ã€ç®±ã®æœŸå¾…å€¤ãƒ»å›åç‡ãŒå³æ™‚è¨ˆç®—ã•ã‚Œã¾ã™ã€‚å…¥åŠ›ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆLocalStorageï¼‰ã€‚</p>
    <form id="calcForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <label class="text-sm">ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆå††ï¼‰
        <input type="number" id="packPrice" class="border p-2 w-full" value="200" min="0">
      </label>
      <label class="text-sm">ãƒ‘ãƒƒã‚¯æ•°ï¼ˆç®±ï¼‰
        <input type="number" id="packCount" class="border p-2 w-full" value="30" min="1">
      </label>

      <div class="sm:col-span-2 lg:col-span-3">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <label class="text-sm">ãƒ¬ã‚¢1 å¹³å‡è²·å–
            <input type="number" id="r1avg" class="border p-2 w-full" value="900" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢1 å°å…¥æ•°
            <input type="number" id="r1cpb" class="border p-2 w-full" value="3" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢2 å¹³å‡è²·å–
            <input type="number" id="r2avg" class="border p-2 w-full" value="450" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢2 å°å…¥æ•°
            <input type="number" id="r2cpb" class="border p-2 w-full" value="6" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢3 å¹³å‡è²·å–
            <input type="number" id="r3avg" class="border p-2 w-full" value="1800" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢3 å°å…¥æ•°
            <input type="number" id="r3cpb" class="border p-2 w-full" value="1" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢4 å¹³å‡è²·å–
            <input type="number" id="r4avg" class="border p-2 w-full" value="0" min="0">
          </label>
          <label class="text-sm">ãƒ¬ã‚¢4 å°å…¥æ•°
            <input type="number" id="r4cpb" class="border p-2 w-full" value="0" min="0">
          </label>
        </div>
      </div>
    </form>

    <div class="flex items-center gap-3 mt-4">
      <button id="calcBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">è¨ˆç®—ã™ã‚‹</button>
      <button id="saveBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">ã“ã®æ¡ä»¶ã‚’ä¿å­˜</button>
      <span id="calcSaved" class="text-xs text-green-600 hidden">ä¿å­˜ã—ã¾ã—ãŸ</span>
    </div>

    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2">ğŸ—‚ ä¿å­˜ã—ãŸæ¡ä»¶</h3>
      <div id="savedList" class="text-sm text-gray-700 space-y-1"></div>
    </div>
  </section>

  <!-- â‘¥ æ³•å‹™ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ -->
  <section class="mt-10 text-sm text-gray-700">
    <h2 class="text-lg font-semibold mb-2">åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h2>
    <div class="bg-white rounded p-4 shadow space-y-2">
      <p>æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾¡æ ¼ãƒ»åœ¨åº«ãƒ»ä»•æ§˜ã¯å„ã‚·ãƒ§ãƒƒãƒ—ã®å…¬è¡¨ã«åŸºã¥ãã¾ã™ãŒã€æœ€æ–°æ€§ãƒ»æ­£ç¢ºæ€§ã¯ä¿è¨¼ã—ã¾ã›ã‚“ã€‚è³¼å…¥ãƒ»å£²å´ç­‰ã®åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã«ã¦ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
      <p>å½“ã‚µã‚¤ãƒˆã«ã¯åºƒå‘Šï¼ˆã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ï¼‰ã‚’å«ã¿ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã®å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ã¯å„è²©å£²è€…ã¸ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
      <p>ã‚¢ã‚¯ã‚»ã‚¹è§£æã¨ã—ã¦ Google Analytics 4 ãŠã‚ˆã³ Microsoft Clarity ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚åé›†ã™ã‚‹æƒ…å ±ã¯ã‚µã‚¤ãƒˆæ”¹å–„ã®ãŸã‚ã«ç”¨ã„ã‚‰ã‚Œã€å€‹äººã‚’ç‰¹å®šã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <p>è‘—ä½œæ¨©ã¯å„æ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ã€‚æ³•ä»¤ãƒ»è¦ç´„ã«æŠµè§¦ã™ã‚‹è¡Œç‚ºãŒç¢ºèªã•ã‚ŒãŸå ´åˆã€æ²è¼‰å†…å®¹ã‚’äºˆå‘Šãªãä¿®æ­£ãƒ»å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>
  </section>

</main>

<footer class="text-center text-gray-600 text-sm py-6 border-t border-gray-200 bg-white mt-12">
  <p>Â© 2025 ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î² | ãƒ‡ãƒ¼ã‚¿å‚è€ƒ: CardRush / ãƒˆãƒ¬ã‚³ãƒ­ / Mercari / yugioh-starter.com</p>
</footer>

<script>
let dataTable;
let fullData = [];
let currentGame = "ALL";
let roiMin = 100, roiMax = 200;      // ROI% åˆæœŸè¡¨ç¤º
let priceMin = 3000, priceMax = 15000; // ä¾¡æ ¼ åˆæœŸè¡¨ç¤º

// JSON èª­ã¿è¾¼ã¿
fetch("data/torekadata.json")
  .then(r => r.json())
  .then(json => {
    // æ•°å€¤ä¸è¶³ã‚’è£œå®Œãƒ»roi/roi_pct ã‚’å†è¨ˆç®—ï¼ˆä¿å®ˆçš„ï¼‰
    fullData = json.map(x => {
      const boxPrice = num(x.boxPrice) || (num(x.packPrice) * num(x.packCount));
      const avgBuyTotal = num(x.avgBuyTotal);
      const packEV = avgBuyTotal && num(x.packCount) ? Math.round(avgBuyTotal / num(x.packCount)) : (x.packEV || 0);
      const roi = (boxPrice && avgBuyTotal) ? (avgBuyTotal / boxPrice) : (num(x.roi) || 0);
      const roi_pct = (roi ? (roi * 100) : 0).toFixed(1) + "%";
      return {
        ...x,
        boxPrice, avgBuyTotal, packEV, roi, roi_pct
      };
    });
    initFilters(fullData);
    initTable(fullData);
  })
  .catch(err => {
    console.error(err);
    $("#torekaTable").html("<tr><td>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>");
  });

function num(v){ const n = Number(v); return isNaN(n) ? 0 : n; }

// DataTables åˆæœŸåŒ–
function initTable(rows){
  const columns = [
    { title: "ã‚²ãƒ¼ãƒ ", data: "game" },
    { title: "ãƒœãƒƒã‚¯ã‚¹å", data: "boxName",
      render: (val, type, row) => {
        const img = row.affiliateImage ? `<img class="thumb mr-2" src="${row.affiliateImage}" alt="thumb">` : `<span class="mr-2 inline-block w-14 h-14 bg-gray-100 border rounded"></span>`;
        const link = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" class="text-yellow-700 underline">ã‚¢ãƒ•ã‚£ã‚’è¦‹ã‚‹</a>` : `<span class="text-gray-400">ãƒªãƒ³ã‚¯ãªã—</span>`;
        return `<div class="flex items-center">${img}<div><div class="font-medium">${escapeHtml(val||"-")}</div><div class="text-xs">${link}</div></div></div>`;
      }
    },
    { title: "ç™ºå£²æ—¥", data: "releaseDate" },
    { title: "ç®±ä¾¡æ ¼(å††)", data: "boxPrice", render: v => num(v).toLocaleString() },
    { title: "æœŸå¾…å€¤(å††)", data: "avgBuyTotal", render: v => num(v).toLocaleString() },
    { title: "1ãƒ‘ãƒƒã‚¯EV", data: "packEV", render: v => num(v).toLocaleString() },
    { title: "å›åç‡", data: "roi_pct" }
  ];

  dataTable = $("#torekaTable").DataTable({
    data: rows,
    columns,
    order: [[6, "desc"]], // ROIé™é †
    pageLength: 10,
    responsive: true,
    language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" },
    createdRow: function(row, data){
      if (data.roi >= 1.2) $(row).addClass("rank-gold");
    }
  });

  // æœ€åˆã®ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
  applyAllFilters();
}

// --- â‘¡ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
function initFilters(rows){
  // ROI% ã®ç¯„å›²ï¼ˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•æ¨å®šï¼‰
  const roiVals = rows.map(r => Math.round((r.roi||0)*100)).filter(v => isFinite(v));
  const rMin = roiVals.length ? Math.max(0, Math.min(...roiVals, 50)) : 50;
  const rMax = roiVals.length ? Math.max(...roiVals, 200) : 200;
  roiMin = rMin; roiMax = rMax;

  const priceVals = rows.map(r => r.boxPrice||0).filter(v => isFinite(v));
  const pMin = priceVals.length ? Math.max(0, Math.min(...priceVals)) : 1000;
  const pMax = priceVals.length ? Math.max(...priceVals) : 20000;
  priceMin = pMin; priceMax = pMax;

  const roiSlider = document.getElementById('roiSlider');
  noUiSlider.create(roiSlider, {
    start: [roiMin, roiMax],
    connect: true,
    step: 1,
    range: { 'min': Math.max(0, Math.min(roiMin, 50)), 'max': Math.max(roiMax, 200) },
    format: { to: v => Math.round(v), from: v => Number(v) }
  });
  roiSlider.noUiSlider.on('update', (values)=>{
    roiMin = Number(values[0]); roiMax = Number(values[1]);
    document.getElementById('roiLabel').textContent = `${roiMin}% ã€œ ${roiMax}%`;
  });
  roiSlider.noUiSlider.on('change', applyAllFilters);

  const priceSlider = document.getElementById('priceSlider');
  noUiSlider.create(priceSlider, {
    start: [priceMin, priceMax],
    connect: true,
    step: 100,
    range: { 'min': Math.max(0, Math.min(priceMin, 500)), 'max': Math.max(priceMax, 20000) },
    format: { to: v => Math.round(v), from: v => Number(v) }
  });
  priceSlider.noUiSlider.on('update', (values)=>{
    priceMin = Number(values[0]); priceMax = Number(values[1]);
    document.getElementById('priceLabel').textContent = `${priceMin.toLocaleString()} ã€œ ${priceMax.toLocaleString()}`;
  });
  priceSlider.noUiSlider.on('change', applyAllFilters);

  // â‘¢ ã‚²ãƒ¼ãƒ ã‚¿ãƒ–
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentGame = btn.getAttribute("data-game");
      applyAllFilters();
    });
  });
}

// ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
function applyAllFilters(){
  if(!dataTable) return;
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ«ã‚¿
  $.fn.dataTable.ext.search = [];
  $.fn.dataTable.ext.search.push((settings, data, dataIndex)=>{
    const row = dataTable.row(dataIndex).data();
    if(!row) return true;
    // ã‚²ãƒ¼ãƒ 
    if(currentGame !== "ALL" && (row.game||"") !== currentGame) return false;
    // ROI%
    const roiPctVal = Number(String(row.roi_pct||"0").replace("%",""));
    if(roiPctVal < roiMin || roiPctVal > roiMax) return false;
    // ä¾¡æ ¼
    const priceVal = Number(row.boxPrice || 0);
    if(priceVal < priceMin || priceVal > priceMax) return false;
    return true;
  });
  dataTable.draw();
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(str){
  return String(str||"").replace(/[&<>"']/g, s=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}

// â‘£ è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ï¼ˆLocalStorageå¯¾å¿œï¼‰
function getForm(){
  return {
    packPrice: num($("#packPrice").val()),
    packCount: num($("#packCount").val()),
    r1avg: num($("#r1avg").val()), r1cpb: num($("#r1cpb").val()),
    r2avg: num($("#r2avg").val()), r2cpb: num($("#r2cpb").val()),
    r3avg: num($("#r3avg").val()), r3cpb: num($("#r3cpb").val()),
    r4avg: num($("#r4avg").val()), r4cpb: num($("#r4cpb").val())
  };
}
function calcNow(){
  const f = getForm();
  const boxPrice = f.packPrice * f.packCount;
  const avgBuyTotal = f.r1avg*f.r1cpb + f.r2avg*f.r2cpb + f.r3avg*f.r3cpb + f.r4avg*f.r4cpb;
  const packEV = f.packCount ? Math.round(avgBuyTotal / f.packCount) : 0;
  const roi = boxPrice ? (avgBuyTotal / boxPrice) : 0;
  $("#calcResult").html(`ç®±ä¾¡æ ¼ï¼š<b>${boxPrice.toLocaleString()}å††</b> ï¼ æœŸå¾…å€¤ï¼š<b>${avgBuyTotal.toLocaleString()}å††</b> ï¼ 1ãƒ‘ãƒƒã‚¯EVï¼š<b>${packEV.toLocaleString()}å††</b> ï¼ ROIï¼š<b>${(roi*100).toFixed(1)}%</b>`);
}
$("#calcBtn").on("click", calcNow);

const LS_KEY = "toreka_calc_saved";
$("#saveBtn").on("click", ()=>{
  const f = getForm();
  const list = JSON.parse(localStorage.getItem(LS_KEY)||"[]");
  list.unshift({...f, ts: Date.now()});
  localStorage.setItem(LS_KEY, JSON.stringify(list.slice(0,20)));
  $("#calcSaved").removeClass("hidden");
  setTimeout(()=>$("#calcSaved").addClass("hidden"), 1200);
  renderSaved();
});
function renderSaved(){
  const list = JSON.parse(localStorage.getItem(LS_KEY)||"[]");
  const box = document.getElementById("savedList");
  if(!list.length){ box.innerHTML = '<div class="text-xs text-gray-400">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
  box.innerHTML = list.map((it,i)=>{
    const d = new Date(it.ts);
    return `<div class="flex items-center justify-between border rounded p-2">
      <div class="text-xs">${d.toLocaleString()} ï½œ å˜ä¾¡${it.packPrice}Ã—${it.packCount}ï¼r1:${it.r1avg}Ã—${it.r1cpb}ï¼r2:${it.r2avg}Ã—${it.r2cpb}</div>
      <button class="text-yellow-700 underline text-xs" onclick="loadSaved(${i})">èª­ã¿è¾¼ã‚€</button>
    </div>`;
  }).join("");
}
window.loadSaved = function(i){
  const list = JSON.parse(localStorage.getItem(LS_KEY)||"[]");
  const it = list[i]; if(!it) return;
  $("#packPrice").val(it.packPrice); $("#packCount").val(it.packCount);
  $("#r1avg").val(it.r1avg); $("#r1cpb").val(it.r1cpb);
  $("#r2avg").val(it.r2avg); $("#r2cpb").val(it.r2cpb);
  $("#r3avg").val(it.r3avg); $("#r3cpb").val(it.r3cpb);
  $("#r4avg").val(it.r4avg); $("#r4cpb").val(it.r4cpb);
  calcNow();
}
renderSaved();
</script>

</body>
</html>
