<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NJM338K4');</script>
<!-- End Google Tag Manager -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "u1pta894yu");
</script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«ã®æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
<meta name="description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒãªã©ä¸»è¦ãƒˆãƒ¬ã‚«ã®ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ã‚’è‡ªå‹•é›†è¨ˆã€‚å¹³å‡è²·å–ã‹ã‚‰å›åç‡ã¨1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’è¨ˆç®—ã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€‚">
<meta name="robots" content="index,follow">
<link rel="icon" href="assets/favicon.ico">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
  :root{ --brand:#2563eb; --brand-2:#60a5fa; --accent:#f59e0b; --bg:#f8fafc; --muted:#6b7280; }
  body{ background:var(--bg); color:#111827; }
  header{ background:linear-gradient(90deg,#fff 0%,#eaf2ff 40%,#fff7e6 100%); border-bottom:1px solid #e5e7eb; }
  .title-lg{ font-size:2rem; } @media(min-width:1024px){ .title-lg{ font-size:2.25rem; } }
  .h-icon{ display:inline-flex; align-items:center; gap:.5rem; }
  .h-dot{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); }
  .badge{ display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:#fff3cd; color:#92400e; font-size:.75rem; border:1px solid #ffe69c; }
  .thumb{ width:56px; height:56px; object-fit:cover; border-radius:.6rem; border:1px solid #e5e7eb; background:#f1f5f9; }
  .section{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1.25rem; }
  .dt-container .dataTables_filter input{ border:1px solid #cbd5e1; }
  table.dataTable thead th, table.dataTable tbody td{ white-space:nowrap; }
  .dt-container{ overflow-x:auto; }
  .is-top{ background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px var(--accent); }
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:60; }
  .modal-card{ width:min(560px,92vw); background:#fff; border-radius:14px; border:1px solid #e5e7eb; padding:1.25rem; }
</style>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJM338K4"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<header class="py-6">
  <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
    <div>
      <div class="h-icon"><span class="h-dot"></span><h1 class="title-lg font-extrabold">ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²</h1></div>
      <p class="mt-1 text-sm text-gray-600">å›åç‡ã¨1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’æ¯”è¼ƒï¼ˆéŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒï¼‰</p>
    </div>
    <span class="hidden lg:inline-block badge">PRã‚’å«ã¿ã¾ã™</span>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <section id="ranking" class="section mb-8">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#22c55e,#86efac)"></span>æœ€æ–°æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span></h2>
      <div class="flex gap-2">
        <a id="share-line" class="px-3 py-2 rounded text-white" style="background:#06C755">LINEã§å…±æœ‰</a>
        <a id="share-x" class="px-3 py-2 rounded text-white" style="background:#000">Xã§å…±æœ‰</a>
        <button id="share-img" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563)">ç”»åƒDL</button>
      </div>
    </div>
    <table id="rankingTable" class="stripe hover w-full text-sm"></table>
    <p class="text-xs text-gray-500 mt-2">â€» ãƒ‡ãƒ¼ã‚¿ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã—ã¾ã›ã‚“ã€‚ä¾¡æ ¼ã¯å¤‰å‹•ã—ã¾ã™ã€‚</p>
  </section>

  <!-- PRãƒ–ãƒ­ãƒƒã‚¯ -->
  <section class="section mb-10">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">ã€PRã€‘äººæ°—ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½å¤© / Amazonï¼‰</div>
        <div class="text-xs text-gray-500">ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™</div>
      </div>
      <div class="flex gap-3">
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#f59e0b,#fcd34d);">æ¥½å¤©</a>
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563);">Amazon</a>
      </div>
    </div>
  </section>

  <!-- å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ï¼ˆã‚¿ãƒ–ï¼‰ -->
  <section id="all" class="section mb-12">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#2563eb,#93c5fd)"></span>å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§</span></h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm"></table>
  </section>

  <!-- è‡ªåˆ†ã§è¨ˆç®—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¯¾å¿œï¼‰ -->
  <section id="calc" class="section mb-12">
    <h3 class="text-xl font-semibold mb-4"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#a855f7,#c084fc)"></span>è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¯ï¼‰</span></h3>
    <div class="grid md:grid-cols-3 gap-4">
      <label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰
        <input type="text" id="c_title" class="border p-2 w-full rounded" placeholder="ä¾‹ï¼šè‡ªåˆ†ç”¨ãƒ†ã‚¹ãƒˆè¨ˆç®—">
      </label>
      <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆå††ï¼‰
        <input type="number" id="c_packPrice" class="border p-2 w-full rounded" value="200" min="0">
      </label>
      <label>ãƒ‘ãƒƒã‚¯æ•°ï¼ˆç®±ï¼‰
        <input type="number" id="c_packCount" class="border p-2 w-full rounded" value="30" min="1">
      </label>
    </div>
    <div id="rarityRows" class="grid md:grid-cols-3 gap-4 mt-4"></div>
    <div class="mt-3 flex gap-2">
      <button id="addRarity" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">ï¼‹ ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¿½åŠ </button>
      <button id="calcBtn" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);">è¨ˆç®—ã™ã‚‹</button>
      <button id="saveCalc" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#2563eb,#60a5fa);">ä¿å­˜</button>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>

    <div class="mt-6">
      <h4 class="font-semibold mb-2">ğŸ’¾ ä¿å­˜å±¥æ­´</h4>
      <table id="historyTable" class="stripe hover w-full text-sm"></table>
    </div>
  </section>

  <!-- æ³•å‹™ï¼ˆè©³ç´°ç‰ˆï¼‰ -->
  <section id="legal" class="section">
    <h3 class="text-xl font-semibold mb-3"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#ef4444,#fca5a5)"></span>åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</span></h3>

    <details class="mb-2" open>
      <summary class="cursor-pointer font-medium">åˆ©ç”¨è¦ç´„ï¼ˆè¦æ—¨ï¼‰</summary>
      <ul class="ml-6 mt-2 list-disc text-sm text-gray-700 space-y-1">
        <li>æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã€æŠ•è³‡åŠ©è¨€ãƒ»å‹§èª˜ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
        <li>æ²è¼‰æƒ…å ±ã®æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ãƒ»æœ€æ–°æ€§ã¯ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ä¾¡æ ¼ãƒ»ç›¸å ´ã¯å¸¸ã«å¤‰å‹•ã—ã¾ã™ã€‚</li>
        <li>å½“ã‚µã‚¤ãƒˆã®æ•°å€¤ãƒ»APIãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ç¬¬ä¸‰è€…ã¸æä¾›ã™ã‚‹å ´åˆã¯ã€å‡ºå…¸ã¨ã—ã¦æœ¬ã‚µã‚¤ãƒˆåã¨URLã®æ˜ç¤ºãŒå¿…è¦ã§ã™ã€‚</li>
        <li>å•†ç”¨ã§ã®ç¶™ç¶šçš„åˆ©ç”¨ï¼ˆå†é…å¸ƒãƒ»æœ‰å„Ÿã‚µãƒ¼ãƒ“ã‚¹ç­‰ï¼‰ã¯äº‹å‰è¨±è«¾ãŒå¿…è¦ã§ã™ã€‚</li>
      </ul>
    </details>

    <details class="mb-2">
      <summary class="cursor-pointer font-medium">å…è²¬äº‹é …</summary>
      <ul class="ml-6 mt-2 list-disc text-sm text-gray-700 space-y-1">
        <li>å¤–éƒ¨ã‚µã‚¤ãƒˆã®ä»•æ§˜å¤‰æ›´ãƒ»é€šä¿¡éšœå®³ãƒ»æƒ…å ±é…å»¶ç­‰ã«èµ·å› ã™ã‚‹æå®³ã«ã¤ã„ã¦ã€å½“æ–¹ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
        <li>è©¦ç®—çµæœã¯æ¨è¨ˆå€¤ã§ã™ã€‚å®Ÿéš›ã®é–‹å°çµæœãƒ»è²·å–æ¡ä»¶ç­‰ã«ã‚ˆã‚Šä¹–é›¢ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆå°†æ¥æä¾›äºˆå®šï¼‰ã§ã®æŠ•ç¨¿å†…å®¹ã¯æŠ•ç¨¿è€…ã®è²¬ä»»ã§ã‚ã‚Šã€é•æ³•ãƒ»ç¬¬ä¸‰è€…ã®æ¨©åˆ©ä¾µå®³ãŒåˆ¤æ˜ã—ãŸå ´åˆã¯å‰Šé™¤ã—ã¾ã™ã€‚</li>
      </ul>
    </details>

    <details>
      <summary class="cursor-pointer font-medium">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</summary>
      <ul class="ml-6 mt-2 list-disc text-sm text-gray-700 space-y-1">
        <li>æœ¬ã‚µã‚¤ãƒˆã¯åˆ©ç”¨çŠ¶æ³ã®æŠŠæ¡ãƒ»ä¸æ­£é˜²æ­¢ã®ãŸã‚è§£æãƒ„ãƒ¼ãƒ«ï¼ˆCookieã‚’å«ã‚€ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        <li>Cookieã¯ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã«ã‚ˆã‚Šæ‹’å¦ã§ãã¾ã™ãŒã€ä¸€éƒ¨æ©Ÿèƒ½ï¼ˆä¿å­˜å±¥æ­´ãªã©ï¼‰ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        <li>å•ã„åˆã‚ã›ãƒ»æŠ•ç¨¿ç­‰ã§å–å¾—ã—ãŸå€‹äººæƒ…å ±ã¯ã€å›ç­”ãƒ»å“è³ªæ”¹å–„ãƒ»ä¸æ­£å¯¾ç­–ã®ç›®çš„ã«é™ã£ã¦å–ã‚Šæ‰±ã„ã¾ã™ã€‚</li>
        <li>APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ï¼ˆIPä¸€éƒ¨ãƒ»UserAgentç­‰ï¼‰ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»é‹ç”¨ç›®çš„ã§ä¸€å®šæœŸé–“ä¿å­˜ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
      </ul>
      <p class="ml-6 mt-2 text-xs text-gray-500">ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯åŸå‰‡ CC BY-NC 4.0ï¼ˆéå–¶åˆ©ã«é™ã‚Šå‡ºå…¸è¡¨ç¤ºã§åˆ©ç”¨å¯ï¼‰ã€‚å•†ç”¨åˆ©ç”¨ã¯è¦é€£çµ¡ã€‚</p>
    </details>
  </section>
</main>

<footer class="text-center text-gray-600 text-sm py-6 mt-12">
  <p>Â© 2025 ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î² | ãƒ‡ãƒ¼ã‚¿å‚è€ƒ: CardRush / ãƒˆãƒ¬ã‚³ãƒ­ / ãƒ¡ãƒ«ã‚«ãƒª / yugioh-starter.com</p>
  <p class="text-xs mt-2">æœ¬ãƒšãƒ¼ã‚¸ã«ã¯åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ï¼ˆPRï¼‰ã€‚</p>
</footer>

<!-- åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="consentModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <h4 class="text-lg font-semibold mb-2">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦ã®ãŠé¡˜ã„</h4>
    <p class="text-sm text-gray-700 mb-3">
      æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾¡æ ¼ã¯å¤‰å‹•ã—ã€å®Ÿéš›ã®ç›¸å ´ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚è§£æã‚„Cookieã‚’ç”¨ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    </p>
    <label class="text-sm inline-flex items-center gap-2 mb-3">
      <input type="checkbox" id="consentRemember" class="border"> æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰
    </label>
    <div class="flex justify-end gap-2">
      <button id="consentCancel" class="px-3 py-2 border rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="consentOK" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#10b981,#34d399);">åŒæ„ã—ã¦é€²ã‚€</button>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
(async function(){
  /* === è¨­å®šï¼šã‚ãªãŸã®Worker URLã«å¤‰æ›´ === */
  const WORKER_BASE = 'https://evchecker.crzydn.workers.dev';

  /* åŒæ„ */
  const MODAL_KEY='toreka_consent_v1', modal=document.getElementById('consentModal');
  if(localStorage.getItem(MODAL_KEY)!=='1'){ modal.style.display='flex'; }
  document.getElementById('consentOK').onclick=()=>{ if(document.getElementById('consentRemember').checked){localStorage.setItem(MODAL_KEY,'1');} modal.style.display='none';};
  document.getElementById('consentCancel').onclick=()=>{ modal.style.display='none'; };

  /* ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ */
  const rows = await fetch('<<https://script.google.com/macros/s/AKfycbx7RDcfaJ-K-QAywCmRI4p88ZtHwRHUahR381yOkWb3l048A1qFAuxztupA3MRKGMEN5w/exec>>',{cache:'no-store'}).then(r=>r.json());

  /* å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰ */
  const ttl=document.title; const topOG=`${WORKER_BASE}/og/box/top`;
  document.getElementById('share-line').href=`https://line.me/R/msg/text/?${encodeURIComponent(ttl+'\n'+location.href)}`;
  document.getElementById('share-x').href=`https://x.com/intent/tweet?text=${encodeURIComponent(ttl)}&url=${encodeURIComponent(location.href)}`;
  document.getElementById('share-img').onclick=()=> window.open(topOG,'_blank');

  /* ã‚µãƒ ãƒè‡ªå‹•ç”Ÿæˆ */
  function avatarFromText(text='-'){ const c=document.createElement('canvas'); c.width=112;c.height=112; const x=c.getContext('2d'); const cs=['#93c5fd','#86efac','#fcd34d','#fda4af','#c4b5fd','#a7f3d0']; x.fillStyle=cs[(text.length*7)%cs.length]; x.fillRect(0,0,112,112); x.fillStyle='#0f172a'; x.font='bold 34px system-ui'; x.textAlign='center'; x.textBaseline='middle'; const t=(text||'TC').replace(/[^A-Za-z0-9ä¸€-é¾¥ã-ã‚“ã‚¡-ãƒ¶]/g,'').slice(0,2).toUpperCase()||'TC'; x.fillText(t,56,56); return c.toDataURL('image/png'); }
  const gameMap={ygo:'éŠæˆ¯ç‹',YGO:'éŠæˆ¯ç‹',pkm:'ãƒã‚±ã‚«',PKM:'ãƒã‚±ã‚«',ws:'ãƒ´ã‚¡ã‚¤ã‚¹',WS:'ãƒ´ã‚¡ã‚¤ã‚¹',dm:'ãƒ‡ãƒ¥ã‚¨ãƒ',DM:'ãƒ‡ãƒ¥ã‚¨ãƒ',mtg:'MTG',MTG:'MTG'};
  function toSlug(s){ return (s||'').toLowerCase().trim().replace(/[^\wä¸€-é¾¥ã-ã‚“ã‚¡-ãƒ¶]+/g,'-').replace(/^-+|-+$/g,''); }

  const data = raw.filter(d=>d&&(d.boxName||'').trim()!=='').map(d=>{
    const n=x=>(x==null||x===''||isNaN(Number(x)))?0:Number(x);
    const roi=d.roi?Number(d.roi):((n(d.avgBuyTotal)&&n(d.boxPrice))?n(d.avgBuyTotal)/n(d.boxPrice):0);
    return {
      ...d,
      slug: d.slug || toSlug(d.boxName),
      game: gameMap[d.game] || (d.game||''),
      releaseDate: d.releaseDate||'',
      boxPrice:n(d.boxPrice), avgBuyTotal:n(d.avgBuyTotal), packEV:n(d.packEV),
      roi, roi_pct: d.roi_pct || (roi? (roi*100).toFixed(1)+'%':'' ),
      affiliateImage: d.affiliateImage || avatarFromText(d.boxName||'-'),
      affiliateUrl: d.affiliateUrl || ''
    };
  });

  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
  const rankCols=[
    { title:"å•†å“", data:null, render:(_,__,row)=>{
        const img=`<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
        const link=`<a href="/box.html?slug=${encodeURIComponent(row.slug)}" class="text-blue-700 underline">${row.boxName||'-'}</a>`;
        const pr=row.affiliateUrl?`<a class="badge ml-2" href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored">PR</a>`:'';
        const sub=`${row.game||''}${row.releaseDate?'ï½œ'+row.releaseDate:''}`;
        return `<div class="flex items-center gap-3">${img}<div><div class="font-medium">${link}${pr}</div><div class="text-xs text-gray-500">${sub}</div></div></div>`;
    }},
    { title:"ç™ºå£²", data:"releaseDate" },
    { title:"ç®±(å††)", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
    { title:"æœŸå¾…å€¤åˆè¨ˆ(å††)", data:"avgBuyTotal", render:v=>Number(v||0).toLocaleString() },
    { title:"1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data:"packEV", render:v=>Number(v||0).toLocaleString() },
    { title:"å›åç‡ï¼ˆï¼…ï¼‰", data:"roi_pct" },
    { title:"roi", data:"roi", visible:false }
  ];
  const rankingDT = $('#rankingTable').DataTable({
    data, columns:rankCols, order:[[6,"desc"]], pageLength:10, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function top3(){ $(rankingDT.rows().nodes()).removeClass('is-top'); rankingDT.rows({order:'applied'}).indexes().toArray().slice(0,3).forEach(i=>$(rankingDT.row(i).node()).addClass('is-top')); }
  rankingDT.on('draw', top3); top3();

  /* å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ã‚¿ãƒ– */
  const games = Array.from(new Set(data.map(d=>d.game).filter(Boolean)));
  const tabs=document.getElementById('gameTabs'); function mkBtn(t){const b=document.createElement('button'); b.className='px-3 py-1 rounded border text-sm bg-white'; b.textContent=t; b.onclick=()=>setFilter(t); return b;}
  tabs.appendChild(mkBtn('ã™ã¹ã¦')); games.forEach(g=>tabs.appendChild(mkBtn(g)));
  const allDT=$('#allTable').DataTable({
    data, columns:[
      { title:"ã‚²ãƒ¼ãƒ ", data:"game" },
      { title:"å•†å“", data:null, render:(_,__,row)=>{
          const img=`<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
          const link=`<a href="/box.html?slug=${encodeURIComponent(row.slug)}" class="text-blue-700 underline">${row.boxName||'-'}</a>`;
          const pr=row.affiliateUrl?`<a class="badge ml-2" href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored">PR</a>`:'';
          return `<div class="flex items-center gap-3">${img}<div><div class="font-medium">${link}${pr}</div><div class="text-xs text-gray-500">${row.releaseDate||''}</div></div></div>`;
      }},
      { title:"ç®±(å††)", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title:"æœŸå¾…å€¤åˆè¨ˆ(å††)", data:"avgBuyTotal", render:v=>Number(v||0).toLocaleString() },
      { title:"1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data:"packEV", render:v=>Number(v||0).toLocaleString() },
      { title:"å›åç‡ï¼ˆï¼…ï¼‰", data:"roi_pct" }
    ],
    order:[[0,'asc'],[5,'desc']], pageLength:10, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function setFilter(label){ if(label==='ã™ã¹ã¦'){ allDT.column(0).search('').draw(); }else{ allDT.column(0).search('^'+label+'$',true,false).draw(); } }
  setFilter('ã™ã¹ã¦');

  /* è‡ªåˆ†ã§è¨ˆç®— */
  const rarityRows=document.getElementById('rarityRows'); let rarityCount=0;
  function addRarity(avg=0, cpb=0){
    if(rarityCount>=6)return;
    rarityCount++;
    const wrap=document.createElement('div');
    wrap.className='border rounded p-3 bg-white';
    wrap.innerHTML=`
      <div class="font-medium mb-2">ãƒ¬ã‚¢${rarityCount}</div>
      <label class="block text-sm">å¹³å‡è²·å–ï¼ˆå††ï¼‰
        <input type="number" class="r-avg border p-2 w-full mt-1 rounded" value="${avg}">
      </label>
      <label class="block text-sm mt-2">å°å…¥æ•°ï¼ˆæšï¼‰
        <input type="number" class="r-cpb border p-2 w-full mt-1 rounded" value="${cpb}">
      </label>
      <button type="button" class="mt-2 text-xs text-red-600 underline remove">å‰Šé™¤</button>
    `;
    wrap.querySelector('.remove').addEventListener('click',()=>{ rarityRows.removeChild(wrap); rarityCount--; });
    rarityRows.appendChild(wrap);
  }
  addRarity(900,3); addRarity(450,6);
  document.getElementById('addRarity').onclick=()=>addRarity();

  function calcNow(){
    const n=v=> (v===''||v==null||isNaN(Number(v)))?0:Number(v);
    const price=n(document.getElementById('c_packPrice').value);
    const count=Math.max(1,n(document.getElementById('c_packCount').value));
    const box=price*count;
    let ev=0;
    rarityRows.querySelectorAll('.border').forEach(boxEl=>{
      ev += n(boxEl.querySelector('.r-avg').value) * n(boxEl.querySelector('.r-cpb').value);
    });
    const packEV=Math.round(ev/count);
    const roi=box?ev/box:0, roiPct=(roi*100).toFixed(1)+'%';
    document.getElementById('calcResult').textContent=`ç®±ä¾¡æ ¼ï¼š${box.toLocaleString()}å†† ï¼ æœŸå¾…å€¤åˆè¨ˆï¼š${ev.toLocaleString()}å†† ï¼ 1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ï¼š${packEV.toLocaleString()}å†† ï¼ å›åç‡ï¼š${roiPct}`;
    return {boxPrice:box, ev, packEV, roi, roiPct};
  }
  document.getElementById('calcBtn').onclick=calcNow;

  const STORAGE_KEY='toreka_calc_history_v1';
  const hisDT=$('#historyTable').DataTable({
    data:[], columns:[
      { title:"ã‚¿ã‚¤ãƒˆãƒ«", data:"title" },
      { title:"ç®±ä¾¡æ ¼", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title:"æœŸå¾…å€¤åˆè¨ˆ", data:"ev", render:v=>Number(v||0).toLocaleString() },
      { title:"1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data:"packEV", render:v=>Number(v||0).toLocaleString() },
      { title:"å›åç‡ï¼ˆï¼…ï¼‰", data:"roiPct" },
      { title:"ä¿å­˜æ—¥æ™‚", data:"savedAt" }
    ],
    pageLength:5, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function loadHistory(){ try{ const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); hisDT.clear().rows.add(arr).draw(); }catch{} }
  loadHistory();
  document.getElementById('saveCalc').onclick=()=>{
    const title=(document.getElementById('c_title').value||'æœªã‚¿ã‚¤ãƒˆãƒ«').trim();
    const now=calcNow();
    const rec={ title, boxPrice:now.boxPrice, ev:now.ev, packEV:now.packEV, roi:now.roi, roiPct:now.roiPct, savedAt:new Date().toLocaleString() };
    const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); arr.unshift(rec);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,100)));
    loadHistory(); alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰');
  };
})();
</script>
</body>
</html>





