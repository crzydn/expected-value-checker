<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>トレカ期待値チェッカー β｜主要トレカの期待値ランキング</title>
  <meta name="description" content="遊戯王・ポケカ・ヴァイス・デュエマなど主要トレカのボックス期待値を自動集計。平均買取から回収率と1パック期待値を計算してランキング表示。">
  <meta name="robots" content="index,follow">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    :root{ --brand:#2563eb; --brand2:#60a5fa; --accent:#f59e0b; --bg:#f8fafc; }
    body{ background:var(--bg); color:#111827; }
    header{ background:linear-gradient(90deg,#fff 0%,#eaf2ff 45%,#fff7e6 100%); border-bottom:1px solid #e5e7eb; }
    .h-dot{ width:26px; height:26px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand2)); display:inline-block; margin-right:.5rem; }
    .badge{ display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:#fff3cd; color:#92400e; font-size:.75rem; border:1px solid #ffe69c; }
    .thumb{ width:56px; height:56px; object-fit:cover; border-radius:.6rem; border:1px solid #e5e7eb; background:#f1f5f9; }
    .section{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1.25rem; }
    .dt-container{ overflow-x:auto; }
    .is-top{ background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px var(--accent); }
  </style>
</head>
<body>

<header class="py-6">
  <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
    <div>
      <h1 class="text-2xl lg:text-[28px] font-extrabold"><span class="h-dot"></span>トレカ期待値チェッカー β</h1>
      <p class="mt-1 text-sm text-gray-600">回収率と1パック期待値を比較（遊戯王・ポケカ・ヴァイス・デュエマ）</p>
    </div>
    <span class="hidden lg:inline-block badge">PRを含みます</span>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
  <!-- ランキング -->
  <section class="section mb-8">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold"><span class="h-dot" style="background:linear-gradient(135deg,#22c55e,#86efac)"></span>最新期待値ランキング</h2>
      <div class="flex gap-2">
        <a id="share-line" class="px-3 py-2 rounded text-white" style="background:#06C755">LINEで共有</a>
        <a id="share-x" class="px-3 py-2 rounded text-white" style="background:#000">Xで共有</a>
        <button id="share-img" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563)">画像DL</button>
      </div>
    </div>
    <table id="rankingTable" class="stripe hover w-full text-sm"></table>
    <p class="text-xs text-gray-500 mt-2">※ データは参考値であり、投資助言を目的としません。価格は変動します。</p>
  </section>

  <!-- PR -->
  <section class="section mb-10">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">【PR】人気ボックスをチェック（楽天 / Amazon）</div>
        <div class="text-xs text-gray-500">アフィリエイトリンクを含みます</div>
      </div>
      <div class="flex gap-3">
        <a href="https://a.r10.to/hRBtGE" target="_blank" rel="nofollow noopener sponsored"
           class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#f59e0b,#fcd34d);">楽天</a>
        <a href="https://amzn.asia/d/dlhRiS7" target="_blank" rel="nofollow noopener sponsored"
           class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563);">Amazon</a>
      </div>
    </div>
  </section>

  <!-- 全一覧 -->
  <section class="section mb-12">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-semibold"><span class="h-dot" style="background:linear-gradient(135deg,#2563eb,#93c5fd)"></span>全トレカ一覧</h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm"></table>
  </section>
</main>

<footer class="text-center text-gray-600 text-sm py-6 mt-12">
  <p>© 2025 トレカ期待値チェッカー β | データ参考: CardRush / トレコロ / メルカリ / yugioh-starter.com</p>
  <p class="text-xs mt-2">本ページには広告・アフィリエイトリンクを含みます（PR）。</p>
</footer>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
(async function(){
  // === 設定 ===
  const GAS_PROXY = 'https://evchecker.crzydn.workers.dev/gas'; // ← あなたのWorker
  const SHEET_NAME = 'トレカ期待値入力';
  const WORKER_BASE = 'https://evchecker.crzydn.workers.dev';

  // 共有ボタン
  const ttl = document.title;
  document.getElementById('share-line').href = `https://line.me/R/msg/text/?${encodeURIComponent(ttl + '\\n' + location.href)}`;
  document.getElementById('share-x').href    = `https://x.com/intent/tweet?text=${encodeURIComponent(ttl)}&url=${encodeURIComponent(location.href)}`;
  document.getElementById('share-img').onclick = () => window.open(`${WORKER_BASE}/og/box/top`, '_blank');

  // Helper
  const gameMap = { ygo:'遊戯王', YGO:'遊戯王', pkm:'ポケカ', PKM:'ポケカ', ws:'ヴァイス', WS:'ヴァイス', dm:'デュエマ', DM:'デュエマ', mtg:'MTG', MTG:'MTG' };
  const n = v => {
    if (v === null || v === undefined) return 0;
    if (typeof v === 'number') return v;
    return Number(String(v).replace(/[¥,]/g,'').trim()) || 0;
  };
  const toSlug = s => (s||'').toLowerCase().trim().replace(/[^\w一-龥ぁ-んァ-ヶ]+/g,'-').replace(/^-+|-+$/g,'');

  // 取得
  const url = `${GAS_PROXY}?sheet=${encodeURIComponent(SHEET_NAME)}&ts=${Date.now()}`;
  const json = await fetch(url, { cache:'no-store' }).then(r => r.json()).catch(e => (alert('データ取得に失敗しました'), {data:[]}));
  const raw = json.data || [];

  // 整形
  const rows = raw.filter(r => (r.boxName||'').trim() !== '').map(r => {
    const boxPrice = n(r.boxPrice);
    const avgBuyTotal = n(r.avgBuyTotal);
    const packCount = n(r.packCount) || 1;
    const packEV = r.packEV ? n(r.packEV) : Math.round(avgBuyTotal / packCount);
    const roi = r.roi ? Number(r.roi) : (boxPrice ? avgBuyTotal / boxPrice : 0);
    const roi_pct = r.roi_pct || (roi ? (roi*100).toFixed(1)+'%' : '');
    const slug = r.slug || toSlug(r.boxName);
    const game = gameMap[r.game] || (r.game || '');
    const affiliateImage = r.affiliateImage || `https://dummyimage.com/112x112/e5e7eb/111827.png&text=${encodeURIComponent((r.boxName||'TC').slice(0,2))}`;
    return { ...r, slug, game, boxPrice, avgBuyTotal, packEV, roi, roi_pct, affiliateImage };
  });

  // ランキング
  const rankCols = [
    { title:"商品", data:null, render:(_,__,row)=>{
        const img = `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
        const link = `<a href="box.html?slug=${encodeURIComponent(row.slug)}" class="text-blue-700 underline">${row.boxName||'-'}</a>`;
        const pr   = row.affiliateUrl ? `<a class="badge ml-2" href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored">PR</a>`:'';
        const sub  = `${row.game||''}${row.releaseDate?'｜'+row.releaseDate:''}`;
        return `<div class="flex items-center gap-3">${img}<div><div class="font-medium">${link}${pr}</div><div class="text-xs text-gray-500">${sub}</div></div></div>`;
    }},
    { title:"発売", data:"releaseDate" },
    { title:"箱(円)", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
    { title:"期待値合計(円)", data:"avgBuyTotal", render:v=>Number(v||0).toLocaleString() },
    { title:"1パック期待値", data:"packEV", render:v=>Number(v||0).toLocaleString() },
    { title:"回収率（％）", data:"roi_pct" },
    { title:"_roi", data:"roi", visible:false }
  ];
  const rankingDT = $('#rankingTable').DataTable({
    data: rows, columns: rankCols, order:[[6,'desc']], pageLength:10, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function top3(){ $(rankingDT.rows().nodes()).removeClass('is-top'); rankingDT.rows({order:'applied'}).indexes().toArray().slice(0,3).forEach(i=>$(rankingDT.row(i).node()).addClass('is-top')); }
  rankingDT.on('draw', top3); top3();

  // 全一覧（タブ）
  const games = Array.from(new Set(rows.map(r => r.game).filter(Boolean)));
  const tabs = document.getElementById('gameTabs');
  function mkBtn(label){ const b=document.createElement('button'); b.className='px-3 py-1 rounded border text-sm bg-white'; b.textContent=label; b.onclick=()=>setFilter(label); return b; }
  tabs.appendChild(mkBtn('すべて')); games.forEach(g=>tabs.appendChild(mkBtn(g)));

  const allDT = $('#allTable').DataTable({
    data: rows,
    columns:[
      { title:"ゲーム", data:"game" },
      { title:"商品", data:null, render:(_,__,row)=>{
          const img=`<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
          const link=`<a href="box.html?slug=${encodeURIComponent(row.slug)}" class="text-blue-700 underline">${row.boxName||'-'}</a>`;
          const pr=row.affiliateUrl?`<a class="badge ml-2" href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored">PR</a>`:'';
          return `<div class="flex items-center gap-3">${img}<div><div class="font-medium">${link}${pr}</div><div class="text-xs text-gray-500">${row.releaseDate||''}</div></div></div>`;
      }},
      { title:"箱(円)", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title:"期待値合計(円)", data:"avgBuyTotal", render:v=>Number(v||0).toLocaleString() },
      { title:"1パック期待値", data:"packEV", render:v=>Number(v||0).toLocaleString() },
      { title:"回収率（％）", data:"roi_pct" }
    ],
    order:[[0,'asc'],[5,'desc']], pageLength:10, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function setFilter(label){ if(label==='すべて'){ allDT.column(0).search('').draw(); } else { allDT.column(0).search('^'+label+'$', true, false).draw(); } }
  setFilter('すべて');
})();
</script>
</body>
</html>
