<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«ã®æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
<meta name="description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒãªã©ä¸»è¦ãƒˆãƒ¬ã‚«ã®ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ã‚’è‡ªå‹•é›†è¨ˆã€‚å¹³å‡è²·å–ã‹ã‚‰å›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’è¨ˆç®—ã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€‚">
<meta name="robots" content="index,follow">
<link rel="icon" href="assets/favicon.ico">

<!-- Tailwind / DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
  :root{
    --brand:#2563eb; --brand-2:#60a5fa; --accent:#f59e0b; --bg:#f8fafc; --muted:#6b7280;
  }
  body{ background:var(--bg); color:#111827; }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè‰²å‘³ãƒ»è¦–èªæ€§UPï¼‰ */
  header{ background:linear-gradient(90deg,#fff 0%,#eaf2ff 40%,#fff7e6 100%); border-bottom:1px solid #e5e7eb; }
  .title-lg{ font-size:2rem; } @media(min-width:1024px){ .title-lg{ font-size:2.25rem; } }
  .h-icon{ display:inline-flex; align-items:center; gap:.5rem; }
  .h-dot{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); }

  /* ãƒãƒƒã‚¸ãƒ»ã‚µãƒ ãƒ */
  .badge{ display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:#fff3cd; color:#92400e; font-size:.75rem; border:1px solid #ffe69c; }
  .thumb{ width:56px; height:56px; object-fit:cover; border-radius:.6rem; border:1px solid #e5e7eb; background:#f1f5f9; }

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ */
  .section{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1.25rem; }

  /* DataTables èª¿æ•´ */
  .dt-container .dataTables_filter input{ border:1px solid #cbd5e1; }
  table.dataTable thead th, table.dataTable tbody td{ white-space:nowrap; }
  .dt-container{ overflow-x:auto; }
  .is-top{ background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px var(--accent); }

  /* åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:60; }
  .modal-card{ width:min(560px,92vw); background:#fff; border-radius:14px; border:1px solid #e5e7eb; padding:1.25rem; }
</style>
</head>

<body>
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="py-6">
  <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
    <div>
      <div class="h-icon">
        <span class="h-dot"></span>
        <h1 class="title-lg font-extrabold text-gray-900 tracking-tight">ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²</h1>
      </div>
      <p class="mt-1 text-sm text-gray-600">éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œï½œå›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’æ¯”è¼ƒ</p>
    </div>
    <span class="hidden lg:inline-block badge">PRã‚’å«ã¿ã¾ã™</span>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- â‘  ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç„¡ã—ï¼‰ -->
  <section id="ranking" class="section mb-8">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#22c55e,#86efac)"></span>æœ€æ–°æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span></h2>
      <span class="badge">åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ã‚’å«ã¿ã¾ã™</span>
    </div>
    <table id="rankingTable" class="stripe hover w-full text-sm"></table>
    <p class="text-xs text-gray-500 mt-2">â€» ãƒ‡ãƒ¼ã‚¿ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã—ã¾ã›ã‚“ã€‚ä¾¡æ ¼ã¯å¤‰å‹•ã—ã¾ã™ã€‚</p>
  </section>

  <!-- â‘¤ PRæ  -->
  <section class="section mb-10">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">ã€PRã€‘äººæ°—ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½å¤© / Amazonï¼‰</div>
        <div class="text-xs text-gray-500">ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™</div>
      </div>
      <div class="flex gap-3">
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#f59e0b,#fcd34d);">æ¥½å¤©</a>
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563);">Amazon</a>
      </div>
    </div>
  </section>

  <!-- â‘¢ å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ï¼ˆã‚¿ãƒ–åˆ‡æ›¿ï¼‰ -->
  <section id="all" class="section mb-12">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#2563eb,#93c5fd)"></span>å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§</span></h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm"></table>
  </section>

  <!-- â‘£ è‡ªåˆ†ã§è¨ˆç®— -->
  <section id="calc" class="section mb-12">
    <h3 class="text-xl font-semibold mb-4"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#a855f7,#c084fc)"></span>è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¯ï¼‰</span></h3>
    <div class="grid md:grid-cols-3 gap-4">
      <label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰
        <input type="text" id="c_title" class="border p-2 w-full rounded" placeholder="ä¾‹ï¼šè‡ªåˆ†ç”¨ãƒ†ã‚¹ãƒˆè¨ˆç®—">
      </label>
      <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆå††ï¼‰
        <input type="number" id="c_packPrice" class="border p-2 w-full rounded" value="200" min="0">
      </label>
      <label>ãƒ‘ãƒƒã‚¯æ•°ï¼ˆç®±ï¼‰
        <input type="number" id="c_packCount" class="border p-2 w-full rounded" value="30" min="1">
      </label>
    </div>
    <div id="rarityRows" class="grid md:grid-cols-3 gap-4 mt-4"></div>
    <div class="mt-3 flex gap-2">
      <button id="addRarity" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">ï¼‹ ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¿½åŠ </button>
      <button id="calcBtn" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);">è¨ˆç®—ã™ã‚‹</button>
      <button id="saveCalc" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#2563eb,#60a5fa);">ä¿å­˜</button>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>

    <div class="mt-6">
      <h4 class="font-semibold mb-2">ğŸ’¾ ä¿å­˜å±¥æ­´</h4>
      <table id="historyTable" class="stripe hover w-full text-sm"></table>
    </div>
  </section>

  <!-- â‘¥ åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ -->
  <section id="legal" class="section">
    <h3 class="text-xl font-semibold mb-3"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#ef4444,#fca5a5)"></span>åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</span></h3>
    <details class="mb-2" open>
      <summary class="cursor-pointer font-medium">åˆ©ç”¨è¦ç´„ï¼ˆè¦æ—¨ï¼‰</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€æŠ•è³‡åŠ©è¨€ç­‰ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ²è¼‰æƒ…å ±ã®æ­£ç¢ºæ€§ãƒ»å®Œå…¨æ€§ãƒ»æœ€æ–°æ€§ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ã”åˆ©ç”¨ã¯è‡ªå·±è²¬ä»»ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
      </p>
    </details>
    <details class="mb-2">
      <summary class="cursor-pointer font-medium">å…è²¬äº‹é …</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        ä¾¡æ ¼ãƒ»ç›¸å ´ã¯å¤‰å‹•ã—ã¾ã™ã€‚å¤–éƒ¨ã‚µã‚¤ãƒˆã®ä»•æ§˜å¤‰æ›´ãƒ»ã‚¢ã‚¯ã‚»ã‚¹éšœå®³ãƒ»æƒ…å ±é…å»¶ç­‰ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚å½“æ–¹ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
      </p>
    </details>
    <details>
      <summary class="cursor-pointer font-medium">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        æœ¬ã‚µã‚¤ãƒˆã¯åˆ©ç”¨çŠ¶æ³æŠŠæ¡ã®ãŸã‚è§£æãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚Cookieç­‰ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã€åŒæ„ã®ä¸Šã”åˆ©ç”¨ãã ã•ã„ã€‚æŠ•ç¨¿æ©Ÿèƒ½ï¼ˆå°†æ¥æä¾›äºˆå®šï¼‰ã§ã¯ã€æŠ•ç¨¿è€…ã®åŒæ„ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šæ‰±ã„ã¾ã™ã€‚
      </p>
    </details>
  </section>

</main>

<footer class="text-center text-gray-600 text-sm py-6 mt-12">
  <p>Â© 2025 ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î² | ãƒ‡ãƒ¼ã‚¿å‚è€ƒ: CardRush / ãƒˆãƒ¬ã‚³ãƒ­ / ãƒ¡ãƒ«ã‚«ãƒª / yugioh-starter.com</p>
  <p class="text-xs mt-2">æœ¬ãƒšãƒ¼ã‚¸ã«ã¯åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ï¼ˆPRï¼‰ã€‚</p>
</footer>

<!-- åŒæ„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆåˆå›è¡¨ç¤ºï¼‰ -->
<div id="consentModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <h4 class="text-lg font-semibold mb-2">ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦ã®ãŠé¡˜ã„</h4>
    <p class="text-sm text-gray-700 mb-3">
      æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾¡æ ¼ã¯å¤‰å‹•ã—ã€å®Ÿéš›ã®ç›¸å ´ã¨ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚è§£æã‚„Cookieã‚’ç”¨ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    </p>
    <label class="text-sm inline-flex items-center gap-2 mb-3">
      <input type="checkbox" id="consentRemember" class="border"> æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰
    </label>
    <div class="flex justify-end gap-2">
      <button id="consentCancel" class="px-3 py-2 border rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="consentOK" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#10b981,#34d399);">åŒæ„ã—ã¦é€²ã‚€</button>
    </div>
  </div>
</div>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
(async function(){
  /* ---------- åˆå›åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« ---------- */
  const MODAL_KEY = 'toreka_consent_v1';
  const modal = document.getElementById('consentModal');
  const remembered = localStorage.getItem(MODAL_KEY)==='1';
  if(!remembered){ modal.style.display='flex'; }
  document.getElementById('consentOK').onclick = ()=> {
    if(document.getElementById('consentRemember').checked){ localStorage.setItem(MODAL_KEY,'1'); }
    modal.style.display='none';
  };
  document.getElementById('consentCancel').onclick = ()=> { modal.style.display='none'; };

  /* ---------- JSONèª­ã¿è¾¼ã¿ ---------- */
  let raw = [];
  try{
    const r = await fetch('torekadata.json', {cache:'no-store'});
    raw = await r.json();
  }catch(e){
    console.error(e);
    alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚/data/torekadata.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  /* ---------- ã‚µãƒ ãƒè‡ªå‹•ç”Ÿæˆï¼ˆç”»åƒURLãŒç„¡ã„å ´åˆï¼‰ ---------- */
  function avatarFromText(text='-'){
    const c = document.createElement('canvas'); c.width=112; c.height=112;
    const ctx = c.getContext('2d');
    const colors = ['#93c5fd','#86efac','#fcd34d','#fda4af','#c4b5fd','#a7f3d0'];
    ctx.fillStyle = colors[(text.length*7)%colors.length]; ctx.fillRect(0,0,112,112);
    ctx.fillStyle = '#0f172a'; ctx.font = 'bold 34px system-ui, -apple-system, Segoe UI, Roboto';
    ctx.textAlign = 'center'; ctx.textBaseline='middle';
    const initials = (text||'TC').replace(/[^A-Za-z0-9ä¸€-é¾¥ã-ã‚“ã‚¡-ãƒ¶]/g,'').slice(0,2).toUpperCase() || 'TC';
    ctx.fillText(initials, 56, 56);
    return c.toDataURL('image/png');
  }

  /* ---------- ã‚²ãƒ¼ãƒ åãƒãƒƒãƒ”ãƒ³ã‚° / ç©ºè¡Œãƒ»OTHæŠ‘æ­¢ ---------- */
  const gameMap = {
    'ygo':'éŠæˆ¯ç‹','YGO':'éŠæˆ¯ç‹',
    'pkm':'ãƒã‚±ã‚«','PKM':'ãƒã‚±ã‚«',
    'ws':'ãƒ´ã‚¡ã‚¤ã‚¹','WS':'ãƒ´ã‚¡ã‚¤ã‚¹',
    'dm':'ãƒ‡ãƒ¥ã‚¨ãƒ','DM':'ãƒ‡ãƒ¥ã‚¨ãƒ',
    'mtg':'MTG','MTG':'MTG'
  };

  const data = raw
    .filter(d => d && (d.boxName||'').toString().trim() !== '') // ç©ºè¡Œé™¤å¤–
    .map(d => {
      const n = x => (x===null||x===undefined||x===''||isNaN(Number(x)))?0:Number(x);
      const roiNum = d.roi ? Number(d.roi) : ((n(d.avgBuyTotal)&&n(d.boxPrice)) ? n(d.avgBuyTotal)/n(d.boxPrice) : 0);
      const gameLabel = gameMap[d.game] || (d.game ? d.game : ''); // æœªå…¥åŠ›ã¯ç©º
      return {
        ...d,
        game: gameLabel,
        releaseDate: d.releaseDate || '',
        boxPrice: n(d.boxPrice),
        avgBuyTotal: n(d.avgBuyTotal),
        packEV: n(d.packEV),
        roi: roiNum,
        roi_pct: d.roi_pct || (roiNum ? (roiNum*100).toFixed(1)+'%' : ''),
        affiliateImage: d.affiliateImage || avatarFromText(d.boxName||'-'),
        affiliateUrl: d.affiliateUrl || ''
      };
    });

  /* ================= â‘  ãƒ©ãƒ³ã‚­ãƒ³ã‚° ================= */
  const rankingColumns = [
    {
      title: "å•†å“",
      data: null,
      render: function(_, __, row){
        const img = `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        const sub = `${row.game||''} ${row.releaseDate? 'ï½œ'+row.releaseDate : ''}`;
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${row.boxName||'-'}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${sub}</div>
                  </div>
                </div>`;
      }
    },
    { title: "ç™ºå£²", data: "releaseDate" },
    { title: "ç®±(å††)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "æœŸå¾…å€¤åˆè¨ˆ(å††)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "å›åç‡ï¼ˆï¼…ï¼‰", data: "roi_pct" },
    { title: "roiNum", data: "roi", visible: false }
  ];

  const rankingDT = $('#rankingTable').DataTable({
    data,
    columns: rankingColumns,
    order: [[6, "desc"]],
    pageLength: 10,
    autoWidth:false,
    scrollX:true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  function highlightTop3(){
    $(rankingDT.rows().nodes()).removeClass('is-top');
    const idx = rankingDT.rows({search:'applied', order:'applied'}).indexes().toArray().slice(0,3);
    idx.forEach(i => $(rankingDT.row(i).node()).addClass('is-top'));
  }
  rankingDT.on('draw', highlightTop3); highlightTop3();

  /* ================= â‘¢ å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ï¼ˆã‚¿ãƒ–åˆ‡æ›¿ï¼‰ ================= */
  const games = Array.from(new Set(data.map(d=>d.game).filter(Boolean)));
  const tabsWrap = document.getElementById('gameTabs');
  const makeBtn = (label) => {
    const b = document.createElement('button');
    b.className = 'px-3 py-1 rounded border text-sm bg-white';
    b.textContent = label;
    b.addEventListener('click', ()=> setGameFilter(label));
    return b;
  };
  tabsWrap.appendChild(makeBtn('ã™ã¹ã¦'));
  games.forEach(g => tabsWrap.appendChild(makeBtn(g)));

  const allColumns = [
    { title: "ã‚²ãƒ¼ãƒ ", data: "game" },
    {
      title: "å•†å“",
      data: null,
      render: function(_, __, row){
        const img = `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${row.boxName||'-'}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${row.releaseDate||''}</div>
                  </div>
                </div>`;
      }
    },
    { title: "ç®±(å††)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "æœŸå¾…å€¤åˆè¨ˆ(å††)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "å›åç‡ï¼ˆï¼…ï¼‰", data: "roi_pct" }
  ];

  const allDT = $('#allTable').DataTable({
    data,
    columns: allColumns,
    order: [[0,'asc'],[5,'desc']],
    pageLength: 10,
    autoWidth:false,
    scrollX:true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  function setGameFilter(label){
    if (label === 'ã™ã¹ã¦') { allDT.column(0).search('').draw(); }
    else { allDT.column(0).search('^'+label+'$', true, false).draw(); }
  }
  setGameFilter('ã™ã¹ã¦');

  /* ================= â‘£ è‡ªåˆ†ã§è¨ˆç®—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ ================= */
  const rarityRows = document.getElementById('rarityRows');
  let rarityCount = 0;
  function addRarity(avg=0, cpb=0){
    if (rarityCount >= 6) return;
    rarityCount++;
    const wrap = document.createElement('div');
    wrap.className = 'border rounded p-3 bg-white';
    wrap.innerHTML = `
      <div class="font-medium mb-2">ãƒ¬ã‚¢${rarityCount}</div>
      <label class="block text-sm">å¹³å‡è²·å–ï¼ˆå††ï¼‰
        <input type="number" class="r-avg border p-2 w-full mt-1 rounded" value="${avg}">
      </label>
      <label class="block text-sm mt-2">å°å…¥æ•°ï¼ˆæšï¼‰
        <input type="number" class="r-cpb border p-2 w-full mt-1 rounded" value="${cpb}">
      </label>
      <button type="button" class="mt-2 text-xs text-red-600 underline remove">å‰Šé™¤</button>
    `;
    wrap.querySelector('.remove').addEventListener('click', ()=>{ rarityRows.removeChild(wrap); rarityCount--; });
    rarityRows.appendChild(wrap);
  }
  addRarity(900,3); addRarity(450,6);
  document.getElementById('addRarity').addEventListener('click', ()=> addRarity());

  function calcNow(){
    const n = v => (v===''||v===null||isNaN(Number(v)))?0:Number(v);
    const packPrice = n(document.getElementById('c_packPrice').value);
    const packCount = Math.max(1, n(document.getElementById('c_packCount').value));
    const boxPrice = packPrice * packCount;
    let ev = 0;
    rarityRows.querySelectorAll('.border').forEach(box=>{
      ev += n(box.querySelector('.r-avg').value) * n(box.querySelector('.r-cpb').value);
    });
    const packEV = Math.round(ev/packCount);
    const roi = boxPrice? (ev/boxPrice):0;
    const roiPct = (roi*100).toFixed(1)+'%';
    document.getElementById('calcResult').textContent =
      `ç®±ä¾¡æ ¼ï¼š${boxPrice.toLocaleString()}å†† ï¼ æœŸå¾…å€¤åˆè¨ˆï¼š${ev.toLocaleString()}å†† ï¼ 1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ï¼š${packEV.toLocaleString()}å†† ï¼ å›åç‡ï¼š${roiPct}`;
    return {boxPrice, ev, packEV, roi, roiPct};
  }
  document.getElementById('calcBtn').addEventListener('click', calcNow);

  const STORAGE_KEY = 'toreka_calc_history_v1';
  const hisDT = $('#historyTable').DataTable({
    data: [],
    columns: [
      { title: "ã‚¿ã‚¤ãƒˆãƒ«", data: "title" },
      { title: "ç®±ä¾¡æ ¼", data: "boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title: "æœŸå¾…å€¤åˆè¨ˆ", data: "ev", render:v=>Number(v||0).toLocaleString() },
      { title: "1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data: "packEV", render:v=>Number(v||0).toLocaleString() },
      { title: "å›åç‡ï¼ˆï¼…ï¼‰", data: "roiPct" },
      { title: "ä¿å­˜æ—¥æ™‚", data: "savedAt" }
    ],
    pageLength: 5,
    autoWidth:false,
    scrollX:true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  function loadHistory(){
    try{
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      hisDT.clear().rows.add(arr).draw();
    }catch(e){}
  }
  loadHistory();

  document.getElementById('saveCalc').addEventListener('click', ()=>{
    const title = (document.getElementById('c_title').value || 'æœªã‚¿ã‚¤ãƒˆãƒ«').trim();
    const now = calcNow();
    const rec = { title, boxPrice: now.boxPrice, ev: now.ev, packEV: now.packEV, roi: now.roi, roiPct: now.roiPct, savedAt: new Date().toLocaleString() };
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    arr.unshift(rec);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,100)));
    loadHistory();
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰');
  });

})();
</script>
</body>
</html>