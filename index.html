<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>トレカ期待値チェッカー β｜主要トレカの期待値ランキング</title>
<meta name="description" content="遊戯王・ポケカ・ヴァイス・デュエマなど主要トレカのボックス期待値を自動集計。平均買取から回収率・1パックEVを計算してランキング表示。">
<meta name="keywords" content="遊戯王,ポケカ,トレカ,期待値,回収率,ボックス,相場,買取,ランキング">
<meta name="robots" content="index,follow">
<meta name="geo.region" content="JP">
<meta name="geo.placename" content="Japan">
<meta property="og:title" content="トレカ期待値チェッカー β｜主要トレカの期待値ランキング">
<meta property="og:description" content="遊戯王・ポケカ・ヴァイス・デュエマ対応。回収率・1パック期待値を見やすく比較できます。">
<meta property="og:type" content="website">
<link rel="icon" href="assets/favicon.ico">

<!-- Tailwind / DataTables / noUiSlider -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css">

<style>
  /* 共通 */
  .badge { display:inline-block; padding:0.1rem .4rem; border-radius:.25rem; background:#fde68a; color:#92400e; font-size:.75rem; }
  .thumb { width:56px; height:56px; object-fit:cover; border-radius:.5rem; border:1px solid #e5e7eb; }
  .tab-btn { padding:.45rem .8rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
  .tab-btn.active { background:#fef3c7; border-color:#f59e0b; color:#92400e; }
  .range-pill { background:#111827; color:#fff; border-radius:9999px; padding:.2rem .6rem; font-size:.75rem; }
  .pr-card { border:1px solid #fcd34d; border-radius:.75rem; background:#fffbea; }
  .is-top { background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px #fbbf24; }

  /* DataTables 調整 */
  .dt-container .dataTables_filter input { border:1px solid #cbd5e1; }
  table.dataTable thead th, table.dataTable tbody td { white-space:nowrap; }
  .dt-container { overflow-x:auto; }

  /* スライダー重なり対策 */
  .filter-bar { position:relative; z-index:10; }
  #rankingTable { position:relative; z-index:1; }

  /* PCレイアウトのメリハリ */
  @media (min-width:1024px){
    header .title-lg { font-size:2.25rem; }  /* 36px */
    header .sub-lg { font-size:1rem; color:#6b7280; }
    main .section { padding:1.25rem 1.5rem; border-radius:14px; }
    #rankingTable_wrapper { padding-top:.75rem; }
    .filter-grid { display:grid; grid-template-columns: 1fr 1fr auto; gap:1.25rem; align-items:end; }
    .filter-card { padding:1rem; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
  }
</style>

<!-- GA4 / Clarity は必要時に有効化
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XXXXXXX');</script>
<script>(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window,document,"clarity","script","CLARITY-ID");</script>
-->
</head>

<body class="bg-gray-50 text-gray-900">

<!-- ヘッダー -->
<header class="py-6 border-b border-gray-200 bg-white shadow-sm">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="title-lg font-extrabold text-yellow-600 tracking-tight">トレカ期待値チェッカー β</h1>
        <p class="sub-lg mt-1">遊戯王・ポケカ・ヴァイス・デュエマ対応｜回収率・1パックEVを比較</p>
      </div>
      <span class="hidden lg:inline-block badge">PRを含みます</span>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- ① ランキング -->
  <section id="ranking" class="mb-8">
    <div class="flex items-end justify-between">
      <h2 class="text-2xl font-semibold mb-3">📊 最新期待値ランキング</h2>
    </div>

    <!-- スライダー群（独立バー） -->
    <div class="filter-bar mb-4">
      <div class="filter-grid">
        <div class="filter-card">
          <div class="flex items-center justify-between mb-2">
            <label class="font-medium">回収率（ROI %）</label>
            <span id="roiRange" class="range-pill">—</span>
          </div>
          <div id="roiSlider"></div>
        </div>
        <div class="filter-card">
          <div class="flex items-center justify-between mb-2">
            <label class="font-medium">箱価格（円）</label>
            <span id="priceRange" class="range-pill">—</span>
          </div>
          <div id="priceSlider"></div>
        </div>
        <div class="hidden lg:block text-right">
          <div class="text-xs text-gray-500 mb-1">表示件数</div>
          <select id="pageSize" class="border rounded p-2">
            <option>10</option><option>25</option><option>50</option>
          </select>
        </div>
      </div>
    </div>

    <table id="rankingTable" class="stripe hover w-full text-sm bg-white rounded shadow"></table>
    <p class="text-xs text-gray-500 mt-2">※ データは参考値であり、投資助言を目的としません。価格は変動します。</p>
  </section>

  <!-- ⑤ PR枠 -->
  <section class="mb-10">
    <div class="pr-card p-4 flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">【PR】人気ボックスをチェック（楽天 / Amazon）</div>
        <div class="text-xs text-gray-500">アフィリエイトリンクを含みます</div>
      </div>
      <div class="flex gap-3">
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 bg-yellow-400 hover:bg-yellow-500 text-white rounded">楽天</a>
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 bg-gray-800 hover:bg-black text-white rounded">Amazon</a>
      </div>
    </div>
  </section>

  <!-- ③ 全トレカ一覧（タブ切替） -->
  <section id="all" class="mb-12">
    <div class="flex items-end justify-between mb-3">
      <h3 class="text-2xl font-semibold">📚 全トレカ一覧</h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm bg-white rounded shadow"></table>
  </section>

  <!-- ④ 自分で計算 -->
  <section id="calc" class="bg-white rounded-xl shadow p-6 mb-12">
    <h3 class="text-xl font-semibold mb-4">🧮 自分で計算してみる（ローカル保存可）</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <label>タイトル（任意）
        <input type="text" id="c_title" class="border p-2 w-full" placeholder="例：自分用テスト計算">
      </label>
      <label>パック単価（円）
        <input type="number" id="c_packPrice" class="border p-2 w-full" value="200" min="0">
      </label>
      <label>パック数（箱）
        <input type="number" id="c_packCount" class="border p-2 w-full" value="30" min="1">
      </label>
    </div>
    <div id="rarityRows" class="grid md:grid-cols-3 gap-4 mt-4"></div>
    <div class="mt-3">
      <button id="addRarity" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">＋ レアリティ追加</button>
      <button id="calcBtn" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded ml-2">計算する</button>
      <button id="saveCalc" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded ml-2">保存</button>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>
    <div class="mt-6">
      <h4 class="font-semibold mb-2">💾 保存履歴</h4>
      <table id="historyTable" class="stripe hover w-full text-sm bg-white rounded shadow"></table>
    </div>
  </section>

  <!-- ⑥ 利用規約・免責・プライバシー -->
  <section id="legal" class="bg-gray-100 rounded-xl p-6">
    <h3 class="text-xl font-semibold mb-3">📜 利用規約・免責・プライバシーポリシー</h3>
    <details class="mb-2" open>
      <summary class="cursor-pointer font-medium">利用規約（要旨）</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        本サイトは参考情報の提供を目的としており、投資助言等を行うものではありません。掲載情報の正確性・完全性・最新性を保証しません。ご利用は自己責任でお願いします。
      </p>
    </details>
    <details class="mb-2">
      <summary class="cursor-pointer font-medium">免責事項</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        価格・相場は変動します。外部サイトの仕様変更・アクセス障害・情報遅延等により生じたいかなる損害についても当方は責任を負いません。
      </p>
    </details>
    <details>
      <summary class="cursor-pointer font-medium">プライバシーポリシー</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        本サイトは利用状況の把握のため解析ツールを使用する場合があります。Cookie等が利用されることがあり、同意の上ご利用ください。投稿機能（将来提供予定）では、投稿者の同意に基づきデータを取り扱います。
      </p>
    </details>
  </section>

</main>

<footer class="text-center text-gray-600 text-sm py-6 border-t border-gray-200 bg-white mt-12">
  <p>© 2025 トレカ期待値チェッカー β | データ参考: CardRush / トレコロ / メルカリ / yugioh-starter.com</p>
  <p class="text-xs mt-2">本ページには広告・アフィリエイトリンクを含みます（PR）。</p>
</footer>

<!-- ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

<script>
(async function(){
  // JSON読み込み
  let data = [];
  try {
    const r = await fetch('torekadata.json', {cache:'no-store'});
    data = await r.json();
  } catch(e){
    console.error(e);
    alert('データを読み込めませんでした。/data/torekadata.json を確認してください。');
    return;
  }

  // 整形：数値化＆補完
  data = data.map(d => {
    const n = x => (x === null || x === undefined || x === '' || isNaN(Number(x))) ? 0 : Number(x);
    const roiNum = d.roi ? Number(d.roi) : ( (n(d.avgBuyTotal) && n(d.boxPrice)) ? (n(d.avgBuyTotal)/n(d.boxPrice)) : 0 );
    return {
      ...d,
      game: d.game || 'OTH',
      releaseDate: d.releaseDate || '',
      boxPrice: n(d.boxPrice),
      avgBuyTotal: n(d.avgBuyTotal),
      packEV: n(d.packEV),
      roi: roiNum,
      roi_pct: d.roi_pct || (roiNum ? (roiNum*100).toFixed(1)+'%' : ''),
      affiliateImage: d.affiliateImage || '',
      affiliateUrl: d.affiliateUrl || ''
    };
  });

  /* ================= ① ランキング ================= */
  const rankingColumns = [
    { title: "ゲーム", data: "game", visible:false },
    {
      title: "商品",
      data: null,
      render: function(_, __, row){
        const img = row.affiliateImage ?
          `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">` :
          `<div class="thumb bg-gray-100"></div>`;
        const name = row.boxName || "-";
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        const sub = `${row.game}｜${row.releaseDate || ''}`;
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${name}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${sub}</div>
                  </div>
                </div>`;
      }
    },
    { title: "発売", data: "releaseDate" },
    { title: "箱(円)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "期待(円)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1P EV", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "ROI", data: "roi_pct" },
    { title: "roiNum", data: "roi", visible: false }
  ];

  const rankingDT = $('#rankingTable').DataTable({
    data,
    columns: rankingColumns,
    order: [[7, "desc"]],
    pageLength: 10,
    autoWidth: false,
    scrollX: true,
    fixedHeader: true,
    columnDefs: [
      { targets: 2, width: 96 },
      { targets: 3, width: 110 },
      { targets: 4, width: 110 },
      { targets: 5, width: 100 },
      { targets: 6, width: 85 }
    ],
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  // Top3強調
  function highlightTop3(){
    $(rankingDT.rows().nodes()).removeClass('is-top');
    const idx = rankingDT.rows({search:'applied', order:'applied'}).indexes().toArray().slice(0,3);
    idx.forEach(i => $(rankingDT.row(i).node()).addClass('is-top'));
  }
  rankingDT.on('draw', highlightTop3);
  highlightTop3();

  /* =============== ② スライダー（ROI/価格） =============== */
  const roiVals = data.map(d=>Math.round((d.roi||0)*100)).filter(x=>isFinite(x));
  const priceVals = data.map(d=>Number(d.boxPrice||0)).filter(x=>isFinite(x));

  const roiMin = roiVals.length? Math.min(...roiVals):0;
  const roiMax = roiVals.length? Math.max(...roiVals):200;
  const priceMin = priceVals.length? Math.min(...priceVals):0;
  const priceMax = priceVals.length? Math.max(...priceVals):15000;

  function percentile(arr, p){
    if (!arr.length) return 0;
    const s=[...arr].sort((a,b)=>a-b);
    const idx=Math.min(s.length-1,Math.max(0,Math.round((p/100)*(s.length-1))));
    return s[idx];
  }
  const roiStart = [ Math.floor(percentile(roiVals,10)), Math.ceil(percentile(roiVals,90)) ];
  const priceStart = [ Math.floor(percentile(priceVals,10)), Math.ceil(percentile(priceVals,90)) ];

  const roiSlider = document.getElementById('roiSlider');
  const priceSlider = document.getElementById('priceSlider');
  noUiSlider.create(roiSlider,{ start: roiStart, connect:true, step:1, range:{min:0,max:Math.max(200,roiMax)} });
  noUiSlider.create(priceSlider,{ start: priceStart, connect:true, step:100, range:{min:0,max:Math.max(20000,priceMax)} });

  const roiRangeEl = document.getElementById('roiRange');
  const priceRangeEl = document.getElementById('priceRange');

  function applyFilters(){
    const [rMin, rMax] = roiSlider.noUiSlider.get().map(Number);
    const [pMin, pMax] = priceSlider.noUiSlider.get().map(Number);
    roiRangeEl.textContent = `${Math.round(rMin)}% 〜 ${Math.round(rMax)}%`;
    priceRangeEl.textContent = `${Math.round(pMin).toLocaleString()}円 〜 ${Math.round(pMax).toLocaleString()}円`;

    $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(f => !f.__isTorekaFilter);
    $.fn.dataTable.ext.search.push(function(settings, dataArr, dataIndex){
      if (settings.nTable.id !== 'rankingTable') return true;
      const roiNum = Number(rankingDT.row(dataIndex).data().roi||0)*100;
      const price = Number(rankingDT.row(dataIndex).data().boxPrice||0);
      return (roiNum >= rMin && roiNum <= rMax && price >= pMin && price <= pMax);
    });
    $.fn.dataTable.ext.search[$.fn.dataTable.ext.search.length-1].__isTorekaFilter = true;
    rankingDT.draw();
  }
  roiSlider.noUiSlider.on('update', applyFilters);
  priceSlider.noUiSlider.on('update', applyFilters);
  $('#pageSize').on('change', function(){ rankingDT.page.len(Number(this.value)).draw(); });
  applyFilters();

  /* =============== ③ 全トレカ一覧（タブ切替） =============== */
  const games = Array.from(new Set(data.map(d=>d.game||'OTH')));
  const tabsWrap = document.getElementById('gameTabs');
  const makeBtn = (label) => {
    const b = document.createElement('button');
    b.className = 'tab-btn'; b.textContent = label; b.dataset.game = label;
    b.addEventListener('click', ()=> setGameFilter(label));
    return b;
  };
  tabsWrap.appendChild(makeBtn('ALL'));
  games.forEach(g => tabsWrap.appendChild(makeBtn(g)));
  function activateTab(label){ [...tabsWrap.children].forEach(el => el.classList.toggle('active', el.textContent === label)); }

  const allColumns = [
    { title: "ゲーム", data: "game" },
    {
      title: "商品",
      data: null,
      render: function(_, __, row){
        const img = row.affiliateImage ? `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">` : `<div class="thumb bg-gray-100"></div>`;
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${row.boxName||'-'}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${row.releaseDate||''}</div>
                  </div>
                </div>`;
      }
    },
    { title: "箱(円)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "期待(円)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1P EV", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "ROI", data: "roi_pct" },
  ];

  const allDT = $('#allTable').DataTable({
    data,
    columns: allColumns,
    order: [[0,'asc'],[5,'desc']],
    pageLength: 10,
    autoWidth:false,
    scrollX:true
  });

  function setGameFilter(label){
    activateTab(label);
    if (label === 'ALL') { allDT.column(0).search('').draw(); }
    else { allDT.column(0).search('^'+label+'$', true, false).draw(); }
  }
  setGameFilter('ALL');

  /* =============== ④ 自分で計算（LocalStorage） =============== */
  const rarityRows = document.getElementById('rarityRows');
  let rarityCount = 0;
  function addRarity(avg=0, cpb=0){
    if (rarityCount >= 6) return;
    rarityCount++;
    const wrap = document.createElement('div');
    wrap.className = 'border rounded p-3 bg-white';
    wrap.innerHTML = `
      <div class="font-medium mb-2">レア${rarityCount}</div>
      <label class="block text-sm">平均買取（円）
        <input type="number" class="r-avg border p-2 w-full mt-1" value="${avg}">
      </label>
      <label class="block text-sm mt-2">封入数（枚）
        <input type="number" class="r-cpb border p-2 w-full mt-1" value="${cpb}">
      </label>
      <button type="button" class="mt-2 text-xs text-red-600 underline remove">削除</button>
    `;
    wrap.querySelector('.remove').addEventListener('click', ()=>{ rarityRows.removeChild(wrap); rarityCount--; });
    rarityRows.appendChild(wrap);
  }
  addRarity(900,3); addRarity(450,6);
  document.getElementById('addRarity').addEventListener('click', ()=> addRarity());

  function calcNow(){
    const n = v => (v===''||v===null||isNaN(Number(v)))?0:Number(v);
    const packPrice = n(document.getElementById('c_packPrice').value);
    const packCount = Math.max(1, n(document.getElementById('c_packCount').value));
    const boxPrice = packPrice * packCount;
    let ev = 0;
    rarityRows.querySelectorAll('.border').forEach(box=>{
      ev += n(box.querySelector('.r-avg').value) * n(box.querySelector('.r-cpb').value);
    });
    const packEV = Math.round(ev/packCount);
    const roi = boxPrice? (ev/boxPrice):0;
    const roiPct = (roi*100).toFixed(1)+'%';
    document.getElementById('calcResult').textContent =
      `箱価格：${boxPrice.toLocaleString()}円 ／ 期待値：${ev.toLocaleString()}円 ／ 1パックEV：${packEV.toLocaleString()}円 ／ ROI：${roiPct}`;
    return {boxPrice, ev, packEV, roi, roiPct};
  }
  document.getElementById('calcBtn').addEventListener('click', calcNow);

  const STORAGE_KEY = 'toreka_calc_history_v1';
  const hisDT = $('#historyTable').DataTable({
    data: [],
    columns: [
      { title: "タイトル", data: "title" },
      { title: "箱価格", data: "boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title: "期待値", data: "ev", render:v=>Number(v||0).toLocaleString() },
      { title: "1P EV", data: "packEV", render:v=>Number(v||0).toLocaleString() },
      { title: "ROI", data: "roiPct" },
      { title: "保存日時", data: "savedAt" }
    ],
    pageLength: 5,
    autoWidth:false,
    scrollX:true
  });

  function loadHistory(){
    try{
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      hisDT.clear().rows.add(arr).draw();
    }catch(e){}
  }
  loadHistory();

  document.getElementById('saveCalc').addEventListener('click', ()=>{
    const title = (document.getElementById('c_title').value || '未タイトル').trim();
    const now = calcNow();
    const rec = { title, boxPrice: now.boxPrice, ev: now.ev, packEV: now.packEV, roi: now.roi, roiPct: now.roiPct, savedAt: new Date().toLocaleString() };
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    arr.unshift(rec);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,100)));
    loadHistory();
    alert('保存しました（この端末のブラウザに保存されます）');
  });

})();
</script>
</body>
</html>

