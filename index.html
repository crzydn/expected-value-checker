<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>トレカ期待値チェッカー β｜主要トレカの期待値ランキング</title>
<meta name="description" content="遊戯王・ポケカ・ヴァイス・デュエマなど主要トレカのボックス期待値を自動集計。平均買取から回収率・1パック期待値を計算してランキング表示。">
<meta name="robots" content="index,follow">
<link rel="icon" href="assets/favicon.ico">

<!-- Tailwind / DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<style>
  :root{
    --brand:#2563eb; --brand-2:#60a5fa; --accent:#f59e0b; --bg:#f8fafc; --muted:#6b7280;
  }
  body{ background:var(--bg); color:#111827; }

  /* ヘッダー（色味・視認性UP） */
  header{ background:linear-gradient(90deg,#fff 0%,#eaf2ff 40%,#fff7e6 100%); border-bottom:1px solid #e5e7eb; }
  .title-lg{ font-size:2rem; } @media(min-width:1024px){ .title-lg{ font-size:2.25rem; } }
  .h-icon{ display:inline-flex; align-items:center; gap:.5rem; }
  .h-dot{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); }

  /* バッジ・サムネ */
  .badge{ display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:#fff3cd; color:#92400e; font-size:.75rem; border:1px solid #ffe69c; }
  .thumb{ width:56px; height:56px; object-fit:cover; border-radius:.6rem; border:1px solid #e5e7eb; background:#f1f5f9; }

  /* セクションカード */
  .section{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1.25rem; }

  /* DataTables 調整 */
  .dt-container .dataTables_filter input{ border:1px solid #cbd5e1; }
  table.dataTable thead th, table.dataTable tbody td{ white-space:nowrap; }
  .dt-container{ overflow-x:auto; }
  .is-top{ background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px var(--accent); }

  /* 同意モーダル */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:60; }
  .modal-card{ width:min(560px,92vw); background:#fff; border-radius:14px; border:1px solid #e5e7eb; padding:1.25rem; }
</style>
</head>

<body>
<!-- ヘッダー -->
<header class="py-6">
  <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
    <div>
      <div class="h-icon">
        <span class="h-dot"></span>
        <h1 class="title-lg font-extrabold text-gray-900 tracking-tight">トレカ期待値チェッカー β</h1>
      </div>
      <p class="mt-1 text-sm text-gray-600">遊戯王・ポケカ・ヴァイス・デュエマ対応｜回収率・1パック期待値を比較</p>
    </div>
    <span class="hidden lg:inline-block badge">PRを含みます</span>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- ① ランキング（スライダー無し） -->
  <section id="ranking" class="section mb-8">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#22c55e,#86efac)"></span>最新期待値ランキング</span></h2>
      <span class="badge">広告・アフィを含みます</span>
    </div>
    <table id="rankingTable" class="stripe hover w-full text-sm"></table>
    <p class="text-xs text-gray-500 mt-2">※ データは参考値であり、投資助言を目的としません。価格は変動します。</p>
  </section>

  <!-- ⑤ PR枠 -->
  <section class="section mb-10">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">【PR】人気ボックスをチェック（楽天 / Amazon）</div>
        <div class="text-xs text-gray-500">アフィリエイトリンクを含みます</div>
      </div>
      <div class="flex gap-3">
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#f59e0b,#fcd34d);">楽天</a>
        <a href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563);">Amazon</a>
      </div>
    </div>
  </section>

  <!-- ③ 全トレカ一覧（タブ切替） -->
  <section id="all" class="section mb-12">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#2563eb,#93c5fd)"></span>全トレカ一覧</span></h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm"></table>
  </section>

  <!-- ④ 自分で計算 -->
  <section id="calc" class="section mb-12">
    <h3 class="text-xl font-semibold mb-4"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#a855f7,#c084fc)"></span>自分で計算する（ローカル保存可）</span></h3>
    <div class="grid md:grid-cols-3 gap-4">
      <label>タイトル（任意）
        <input type="text" id="c_title" class="border p-2 w-full rounded" placeholder="例：自分用テスト計算">
      </label>
      <label>パック単価（円）
        <input type="number" id="c_packPrice" class="border p-2 w-full rounded" value="200" min="0">
      </label>
      <label>パック数（箱）
        <input type="number" id="c_packCount" class="border p-2 w-full rounded" value="30" min="1">
      </label>
    </div>
    <div id="rarityRows" class="grid md:grid-cols-3 gap-4 mt-4"></div>
    <div class="mt-3 flex gap-2">
      <button id="addRarity" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">＋ レアリティ追加</button>
      <button id="calcBtn" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);">計算する</button>
      <button id="saveCalc" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#2563eb,#60a5fa);">保存</button>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>

    <div class="mt-6">
      <h4 class="font-semibold mb-2">💾 保存履歴</h4>
      <table id="historyTable" class="stripe hover w-full text-sm"></table>
    </div>
  </section>

  <!-- ⑥ 利用規約・免責・プライバシー -->
  <section id="legal" class="section">
    <h3 class="text-xl font-semibold mb-3"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#ef4444,#fca5a5)"></span>利用規約・免責・プライバシーポリシー</span></h3>
    <details class="mb-2" open>
      <summary class="cursor-pointer font-medium">利用規約（要旨）</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        本サイトは参考情報の提供を目的としており、投資助言等を行うものではありません。掲載情報の正確性・完全性・最新性を保証しません。ご利用は自己責任でお願いします。
      </p>
    </details>
    <details class="mb-2">
      <summary class="cursor-pointer font-medium">免責事項</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        価格・相場は変動します。外部サイトの仕様変更・アクセス障害・情報遅延等により生じたいかなる損害についても当方は責任を負いません。
      </p>
    </details>
    <details>
      <summary class="cursor-pointer font-medium">プライバシーポリシー</summary>
      <p class="ml-4 mt-1 text-sm text-gray-700">
        本サイトは利用状況把握のため解析ツールを使用する場合があります。Cookie等が利用されることがあり、同意の上ご利用ください。投稿機能（将来提供予定）では、投稿者の同意に基づきデータを取り扱います。
      </p>
    </details>
  </section>

</main>

<footer class="text-center text-gray-600 text-sm py-6 mt-12">
  <p>© 2025 トレカ期待値チェッカー β | データ参考: CardRush / トレコロ / メルカリ / yugioh-starter.com</p>
  <p class="text-xs mt-2">本ページには広告・アフィリエイトリンクを含みます（PR）。</p>
</footer>

<!-- 同意ポップアップ（初回表示） -->
<div id="consentModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <h4 class="text-lg font-semibold mb-2">ご利用にあたってのお願い</h4>
    <p class="text-sm text-gray-700 mb-3">
      本サイトは参考情報の提供を目的としており、投資助言を行うものではありません。価格は変動し、実際の相場と異なる場合があります。解析やCookieを用いることがあります。
    </p>
    <label class="text-sm inline-flex items-center gap-2 mb-3">
      <input type="checkbox" id="consentRemember" class="border"> 次回から表示しない（この端末に保存）
    </label>
    <div class="flex justify-end gap-2">
      <button id="consentCancel" class="px-3 py-2 border rounded">キャンセル</button>
      <button id="consentOK" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#10b981,#34d399);">同意して進む</button>
    </div>
  </div>
</div>

<!-- ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
(async function(){
  /* ---------- 初回同意モーダル ---------- */
  const MODAL_KEY = 'toreka_consent_v1';
  const modal = document.getElementById('consentModal');
  const remembered = localStorage.getItem(MODAL_KEY)==='1';
  if(!remembered){ modal.style.display='flex'; }
  document.getElementById('consentOK').onclick = ()=> {
    if(document.getElementById('consentRemember').checked){ localStorage.setItem(MODAL_KEY,'1'); }
    modal.style.display='none';
  };
  document.getElementById('consentCancel').onclick = ()=> { modal.style.display='none'; };

  /* ---------- JSON読み込み ---------- */
  let raw = [];
  try{
    const r = await fetch('torekadata.json', {cache:'no-store'});
    raw = await r.json();
  }catch(e){
    console.error(e);
    alert('データを読み込めませんでした。/data/torekadata.json を確認してください。');
    return;
  }

  /* ---------- サムネ自動生成（画像URLが無い場合） ---------- */
  function avatarFromText(text='-'){
    const c = document.createElement('canvas'); c.width=112; c.height=112;
    const ctx = c.getContext('2d');
    const colors = ['#93c5fd','#86efac','#fcd34d','#fda4af','#c4b5fd','#a7f3d0'];
    ctx.fillStyle = colors[(text.length*7)%colors.length]; ctx.fillRect(0,0,112,112);
    ctx.fillStyle = '#0f172a'; ctx.font = 'bold 34px system-ui, -apple-system, Segoe UI, Roboto';
    ctx.textAlign = 'center'; ctx.textBaseline='middle';
    const initials = (text||'TC').replace(/[^A-Za-z0-9一-龥ぁ-んァ-ヶ]/g,'').slice(0,2).toUpperCase() || 'TC';
    ctx.fillText(initials, 56, 56);
    return c.toDataURL('image/png');
  }

  /* ---------- ゲーム名マッピング / 空行・OTH抑止 ---------- */
  const gameMap = {
    'ygo':'遊戯王','YGO':'遊戯王',
    'pkm':'ポケカ','PKM':'ポケカ',
    'ws':'ヴァイス','WS':'ヴァイス',
    'dm':'デュエマ','DM':'デュエマ',
    'mtg':'MTG','MTG':'MTG'
  };

  const data = raw
    .filter(d => d && (d.boxName||'').toString().trim() !== '') // 空行除外
    .map(d => {
      const n = x => (x===null||x===undefined||x===''||isNaN(Number(x)))?0:Number(x);
      const roiNum = d.roi ? Number(d.roi) : ((n(d.avgBuyTotal)&&n(d.boxPrice)) ? n(d.avgBuyTotal)/n(d.boxPrice) : 0);
      const gameLabel = gameMap[d.game] || (d.game ? d.game : ''); // 未入力は空
      return {
        ...d,
        game: gameLabel,
        releaseDate: d.releaseDate || '',
        boxPrice: n(d.boxPrice),
        avgBuyTotal: n(d.avgBuyTotal),
        packEV: n(d.packEV),
        roi: roiNum,
        roi_pct: d.roi_pct || (roiNum ? (roiNum*100).toFixed(1)+'%' : ''),
        affiliateImage: d.affiliateImage || avatarFromText(d.boxName||'-'),
        affiliateUrl: d.affiliateUrl || ''
      };
    });

  /* ================= ① ランキング ================= */
  const rankingColumns = [
    {
      title: "商品",
      data: null,
      render: function(_, __, row){
        const img = `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        const sub = `${row.game||''} ${row.releaseDate? '｜'+row.releaseDate : ''}`;
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${row.boxName||'-'}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${sub}</div>
                  </div>
                </div>`;
      }
    },
    { title: "発売", data: "releaseDate" },
    { title: "箱(円)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "期待値合計(円)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1パック期待値", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "回収率（％）", data: "roi_pct" },
    { title: "roiNum", data: "roi", visible: false }
  ];

  const rankingDT = $('#rankingTable').DataTable({
    data,
    columns: rankingColumns,
    order: [[6, "desc"]],
    pageLength: 10,
    autoWidth:false,
    scrollX:true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  function highlightTop3(){
    $(rankingDT.rows().nodes()).removeClass('is-top');
    const idx = rankingDT.rows({search:'applied', order:'applied'}).indexes().toArray().slice(0,3);
    idx.forEach(i => $(rankingDT.row(i).node()).addClass('is-top'));
  }
  rankingDT.on('draw', highlightTop3); highlightTop3();

  /* ================= ③ 全トレカ一覧（タブ切替） ================= */
  const games = Array.from(new Set(data.map(d=>d.game).filter(Boolean)));
  const tabsWrap = document.getElementById('gameTabs');
  const makeBtn = (label) => {
    const b = document.createElement('button');
    b.className = 'px-3 py-1 rounded border text-sm bg-white';
    b.textContent = label;
    b.addEventListener('click', ()=> setGameFilter(label));
    return b;
  };
  tabsWrap.appendChild(makeBtn('すべて'));
  games.forEach(g => tabsWrap.appendChild(makeBtn(g)));

  const allColumns = [
    { title: "ゲーム", data: "game" },
    {
      title: "商品",
      data: null,
      render: function(_, __, row){
        const img = `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`;
        const linkOpen = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored" class="text-blue-700 underline">` : `<span>`;
        const linkClose = row.affiliateUrl ? `</a>` : `</span>`;
        const pr = row.affiliateUrl ? `<span class="badge ml-2">PR</span>` : '';
        return `<div class="flex items-center gap-3">
                  ${img}
                  <div>
                    <div class="font-medium">${linkOpen}${row.boxName||'-'}${linkClose}${pr}</div>
                    <div class="text-xs text-gray-500">${row.releaseDate||''}</div>
                  </div>
                </div>`;
      }
    },
    { title: "箱(円)", data: "boxPrice", render: v => Number(v||0).toLocaleString() },
    { title: "期待値合計(円)", data: "avgBuyTotal", render: v => Number(v||0).toLocaleString() },
    { title: "1パック期待値", data: "packEV", render: v => Number(v||0).toLocaleString() },
    { title: "回収率（％）", data: "roi_pct" }
  ];

  const allDT = $('#allTable').DataTable({
    data,
    columns: allColumns,
    order: [[0,'asc'],[5,'desc']],
    pageLength: 10,
    autoWidth:false,
    scrollX:true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  function setGameFilter(label){
    if (label === 'すべて') { allDT.column(0).search('').draw(); }
    else { allDT.column(0).search('^'+label+'$', true, false).draw(); }
  }
  setGameFilter('すべて');

  /* ================= ④ 自分で計算（ローカル保存） ================= */
  const rarityRows = document.getElementById('rarityRows');
  let rarityCount = 0;
  function addRarity(avg=0, cpb=0){
    if (rarityCount >= 6) return;
    rarityCount++;
    const wrap = document.createElement('div');
    wrap.className = 'border rounded p-3 bg-white';
    wrap.innerHTML = `
      <div class="font-medium mb-2">レア${rarityCount}</div>
      <label class="block text-sm">平均買取（円）
        <input type="number" class="r-avg border p-2 w-full mt-1 rounded" value="${avg}">
      </label>
      <label class="block text-sm mt-2">封入数（枚）
        <input type="number" class="r-cpb border p-2 w-full mt-1 rounded" value="${cpb}">
      </label>
      <button type="button" class="mt-2 text-xs text-red-600 underline remove">削除</button>
    `;
    wrap.querySelector('.remove').addEventListener('click', ()=>{ rarityRows.removeChild(wrap); rarityCount--; });
    rarityRows.appendChild(wrap);
  }
  addRarity(900,3); addRarity(450,6);
  document.getElementById('addRarity').addEventListener('click', ()=> addRarity());

  function calcNow(){
    const n = v => (v===''||v===null||isNaN(Number(v)))?0:Number(v);
    const packPrice = n(document.getElementById('c_packPrice').value);
    const packCount = Math.max(1, n(document.getElementById('c_packCount').value));
    const boxPrice = packPrice * packCount;
    let ev = 0;
    rarityRows.querySelectorAll('.border').forEach(box=>{
      ev += n(box.querySelector('.r-avg').value) * n(box.querySelector('.r-cpb').value);
    });
    const packEV = Math.round(ev/packCount);
    const roi = boxPrice? (ev/boxPrice):0;
    const roiPct = (roi*100).toFixed(1)+'%';
    document.getElementById('calcResult').textContent =
      `箱価格：${boxPrice.toLocaleString()}円 ／ 期待値合計：${ev.toLocaleString()}円 ／ 1パック期待値：${packEV.toLocaleString()}円 ／ 回収率：${roiPct}`;
    return {boxPrice, ev, packEV, roi, roiPct};
  }
  document.getElementById('calcBtn').addEventListener('click', calcNow);

  const STORAGE_KEY = 'toreka_calc_history_v1';
  const hisDT = $('#historyTable').DataTable({
    data: [],
    columns: [
      { title: "タイトル", data: "title" },
      { title: "箱価格", data: "boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title: "期待値合計", data: "ev", render:v=>Number(v||0).toLocaleString() },
      { title: "1パック期待値", data: "packEV", render:v=>Number(v||0).toLocaleString() },
      { title: "回収率（％）", data: "roiPct" },
      { title: "保存日時", data: "savedAt" }
    ],
    pageLength: 5,
    autoWidth:false,
    scrollX:true,
    language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });

  function loadHistory(){
    try{
      const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      hisDT.clear().rows.add(arr).draw();
    }catch(e){}
  }
  loadHistory();

  document.getElementById('saveCalc').addEventListener('click', ()=>{
    const title = (document.getElementById('c_title').value || '未タイトル').trim();
    const now = calcNow();
    const rec = { title, boxPrice: now.boxPrice, ev: now.ev, packEV: now.packEV, roi: now.roi, roiPct: now.roiPct, savedAt: new Date().toLocaleString() };
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    arr.unshift(rec);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,100)));
    loadHistory();
    alert('保存しました（この端末のブラウザに保存されます）');
  });

})();
</script>
</body>
</html>