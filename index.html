<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œéŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒ</title>
<meta name="description" content="ä¸»è¦ãƒˆãƒ¬ã‚«ã®ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ã‚’è‡ªå‹•é›†è¨ˆã€‚å¹³å‡è²·å–ã‹ã‚‰å›åç‡ãƒ»1ãƒ‘ãƒƒã‚¯EVã‚’å¯è¦–åŒ–ã—ã¦æ¯”è¼ƒã§ãã¾ã™ã€‚">
<meta name="keywords" content="éŠæˆ¯ç‹,ãƒã‚±ã‚«,ãƒ´ã‚¡ã‚¤ã‚¹,ãƒ‡ãƒ¥ã‚¨ãƒ,MTG,ãƒˆãƒ¬ã‚«,æœŸå¾…å€¤,ãƒœãƒƒã‚¯ã‚¹,è²·å–,å›åç‡,ç›¸å ´,ã‚«ãƒ¼ãƒ‰ãƒ©ãƒƒã‚·ãƒ¥,ãƒˆãƒ¬ã‚³ãƒ­,ãƒ¡ãƒ«ã‚«ãƒª">
<meta name="robots" content="index,follow">
<meta name="geo.region" content="JP"><meta name="geo.placename" content="Japan">
<meta property="og:title" content="ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°">
<meta property="og:description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œã®æœŸå¾…å€¤æ¯”è¼ƒã‚µã‚¤ãƒˆã€‚ROIãƒ»1ãƒ‘ãƒƒã‚¯EVã‚’è‡ªå‹•è¨ˆç®—ã€‚">
<meta property="og:type" content="website">
<meta property="og:image" content="assets/ogp.jpg">
<link rel="icon" href="assets/favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css">
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --gold:#d4af37; --gold-soft:#f7e9b6; --ink:#0f172a; --card:#ffffff; --bg:#f7f7fb;
  }
  body{ font-family: Inter, 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; }
  .hero {
    background: radial-gradient(1200px 400px at 50% -200px, rgba(212,175,55,.18), transparent 70%),
                linear-gradient(180deg, #fff, #fafafa);
  }
  .card { background:var(--card); border:1px solid #eee; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.04); }
  .gold-title { color: var(--gold); letter-spacing:.3px; }
  .rank-gold { box-shadow: inset 0 0 0 2px var(--gold); background: #fffdf5 !important; }
  .thumb { width:56px; height:56px; object-fit:cover; border-radius:10px; border:1px solid #eee; }
  .tab-btn { padding:.5rem .9rem; border:1px solid #e5e7eb; border-radius:9999px; background:#fff; transition:.2s; font-weight:600 }
  .tab-btn.active { background:var(--gold-soft); border-color:var(--gold); color:#7a5b00; }
  .table-wrap { overflow-x:auto; }
  .controls-bar { display:flex; flex-wrap:wrap; gap:16px; align-items:center; }
  .ctrl { min-width:260px; }
  .ctrl .label { font-size:12px; color:#64748b; font-weight:600; }
  .pr-banner { border:1px dashed var(--gold); background: #fffdf8; border-radius:12px; }
  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-mask{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal{ width:min(720px,92vw); background:#fff; border-radius:16px; box-shadow:0 30px 60px rgba(0,0,0,.2); overflow:hidden; }
  .modal header{ padding:16px 20px; border-bottom:1px solid #eee; }
  .modal main{ padding:16px 20px; max-height:55vh; overflow:auto; }
  .modal footer{ padding:14px 20px; border-top:1px solid #eee; display:flex; gap:10px; justify-content:flex-end; }
  .btn { padding:.6rem 1rem; border-radius:10px; font-weight:700; }
  .btn-primary{ background:var(--gold); color:#1f2937; }
  .btn-ghost{ background:#f3f4f6; color:#374151; }
</style>

<!-- è§£æã‚¿ã‚°ï¼ˆå¿…è¦æ™‚ã«IDå·®ã—æ›¿ãˆï¼‰
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXX"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XXXXXXX');</script>
<script>(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window,document,"clarity","script","CLARITY_ID");</script>
-->
</head>
<body class="bg-gray-50 text-gray-900">

<header class="hero text-center py-8 border-b border-gray-200">
  <h1 class="text-4xl md:text-5xl font-extrabold gold-title">ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²</h1>
  <p class="text-sm text-gray-600 mt-2">éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒå¯¾å¿œï½œROIã¨1ãƒ‘ãƒƒã‚¯EVã‚’æ¯”è¼ƒ</p>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ -->
  <section class="card p-5 mb-8">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold">ğŸ“Š æœ€æ–°æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <p class="text-xs text-gray-500 mt-1">â€»PRã‚’å«ã¿ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã—ã¾ã›ã‚“ã€‚</p>
      </div>

      <!-- ã‚¿ãƒ–ï¼ˆã‚²ãƒ¼ãƒ åˆ‡æ›¿ï¼‰ -->
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn active" data-game-code="all">ã™ã¹ã¦</button>
        <button class="tab-btn" data-game-code="ygo">éŠæˆ¯ç‹</button>
        <button class="tab-btn" data-game-code="pkm">ãƒã‚±ã‚«</button>
        <button class="tab-btn" data-game-code="ws">ãƒ´ã‚¡ã‚¤ã‚¹</button>
        <button class="tab-btn" data-game-code="dm">ãƒ‡ãƒ¥ã‚¨ãƒ</button>
        <button class="tab-btn" data-game-code="mtg">MTG</button>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å†…ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼çµ±åˆï¼‰ -->
    <div class="controls-bar mt-4">
      <div class="ctrl">
        <div class="label">å›åç‡ï¼ˆROI%ï¼‰</div>
        <div id="roiSlider" class="mt-2"></div>
        <div class="text-xs text-gray-600 mt-1" id="roiLabel">100% ã€œ 200%</div>
      </div>
      <div class="ctrl">
        <div class="label">ç®±ä¾¡æ ¼ï¼ˆå††ï¼‰</div>
        <div id="priceSlider" class="mt-2"></div>
        <div class="text-xs text-gray-600 mt-1" id="priceLabel">3,000 ã€œ 15,000</div>
      </div>
    </div>

    <div class="table-wrap mt-4">
      <table id="torekaTable" class="display w-full text-sm"></table>
    </div>

    <!-- PRæ¨ªé•· -->
    <div class="pr-banner mt-4 p-4">
      <p class="text-xs text-gray-500 mb-2">â€»PRï¼ˆã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ï¼‰</p>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <a href="#" target="_blank" class="block border bg-white rounded p-3 hover:shadow">
          <div class="font-semibold text-gray-800">æ¥½å¤© | ãƒˆãƒ¬ã‚«BOXç‰¹é›†</div>
          <div class="text-xs text-gray-500 mt-1">äººæ°—ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯</div>
        </a>
        <a href="#" target="_blank" class="block border bg-white rounded p-3 hover:shadow">
          <div class="font-semibold text-gray-800">Amazon | ãƒˆãƒ¬ã‚« æ–°ç€ãƒ»äºˆç´„</div>
          <div class="text-xs text-gray-500 mt-1">æ–°ä½œã‚„å†å…¥è·ã‚’ç¢ºèª</div>
        </a>
        <a href="#" target="_blank" class="block border bg-white rounded p-3 hover:shadow">
          <div class="font-semibold text-gray-800">é§¿æ²³å±‹ | BOXåœ¨åº«</div>
          <div class="text-xs text-gray-500 mt-1">åœ¨åº«ã¨ä¾¡æ ¼ã‚’æ¯”è¼ƒ</div>
        </a>
      </div>
    </div>
  </section>

  <!-- è‡ªåˆ†ã§è¨ˆç®— -->
  <section class="card p-6">
    <h2 class="text-xl font-semibold mb-3">ğŸ§® è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹</h2>
    <p class="text-sm text-gray-600 mb-4">è²©å£²ä¾¡æ ¼ãƒ»å°å…¥æ•°ãƒ»å¹³å‡è²·å–ã‹ã‚‰ã€ç®±ã®æœŸå¾…å€¤ã¨å›åç‡ã‚’å³æ™‚è¨ˆç®—ã€‚å…¥åŠ›ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆLocalStorageï¼‰ã€‚</p>
    <form id="calcForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <label class="text-sm">ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆå††ï¼‰
        <input type="number" id="packPrice" class="border p-2 w-full" value="200" min="0">
      </label>
      <label class="text-sm">ãƒ‘ãƒƒã‚¯æ•°ï¼ˆç®±ï¼‰
        <input type="number" id="packCount" class="border p-2 w-full" value="30" min="1">
      </label>
      <div class="sm:col-span-2 lg:col-span-3">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <label class="text-sm">ãƒ¬ã‚¢1 å¹³å‡è²·å–<input type="number" id="r1avg" class="border p-2 w-full" value="900" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢1 å°å…¥æ•°<input type="number" id="r1cpb" class="border p-2 w-full" value="3" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢2 å¹³å‡è²·å–<input type="number" id="r2avg" class="border p-2 w-full" value="450" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢2 å°å…¥æ•°<input type="number" id="r2cpb" class="border p-2 w-full" value="6" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢3 å¹³å‡è²·å–<input type="number" id="r3avg" class="border p-2 w-full" value="1800" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢3 å°å…¥æ•°<input type="number" id="r3cpb" class="border p-2 w-full" value="1" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢4 å¹³å‡è²·å–<input type="number" id="r4avg" class="border p-2 w-full" value="0" min="0"></label>
          <label class="text-sm">ãƒ¬ã‚¢4 å°å…¥æ•°<input type="number" id="r4cpb" class="border p-2 w-full" value="0" min="0"></label>
        </div>
      </div>
    </form>
    <div class="flex items-center gap-3 mt-4">
      <button id="calcBtn" class="btn btn-primary">è¨ˆç®—ã™ã‚‹</button>
      <button id="saveBtn" class="btn btn-ghost">ã“ã®æ¡ä»¶ã‚’ä¿å­˜</button>
      <span id="calcSaved" class="text-xs text-green-600 hidden">ä¿å­˜ã—ã¾ã—ãŸ</span>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>
    <div class="mt-6">
      <h3 class="font-semibold mb-2">ğŸ—‚ ä¿å­˜ã—ãŸæ¡ä»¶</h3>
      <div id="savedList" class="text-sm text-gray-700 space-y-1"></div>
    </div>
  </section>

  <!-- æ³•å‹™ -->
  <section class="mt-10 text-sm text-gray-700">
    <h2 class="text-lg font-semibold mb-2">åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h2>
    <div class="card p-4 space-y-2">
      <p>æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ãŸã‚‚ã®ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¾¡æ ¼ãƒ»åœ¨åº«ãƒ»ä»•æ§˜ã¯å„ã‚·ãƒ§ãƒƒãƒ—ã®å…¬è¡¨ã«åŸºã¥ãã¾ã™ãŒã€æœ€æ–°æ€§ãƒ»æ­£ç¢ºæ€§ã¯ä¿è¨¼ã—ã¾ã›ã‚“ã€‚è³¼å…¥ãƒ»å£²å´ç­‰ã®åˆ¤æ–­ã¯è‡ªå·±è²¬ä»»ã«ã¦ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
      <p>å½“ã‚µã‚¤ãƒˆã«ã¯åºƒå‘Šï¼ˆã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ï¼‰ã‚’å«ã¿ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã®å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã«é–¢ã™ã‚‹ãŠå•ã„åˆã‚ã›ã¯å„è²©å£²è€…ã¸ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
      <p>ã‚¢ã‚¯ã‚»ã‚¹è§£æã¨ã—ã¦ Google Analytics 4 ãŠã‚ˆã³ Microsoft Clarity ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚åé›†ã™ã‚‹æƒ…å ±ã¯ã‚µã‚¤ãƒˆæ”¹å–„ã®ãŸã‚ã«ç”¨ã„ã‚‰ã‚Œã€å€‹äººã‚’ç‰¹å®šã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <p>è‘—ä½œæ¨©ã¯å„æ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ã€‚æ³•ä»¤ãƒ»è¦ç´„ã«æŠµè§¦ã™ã‚‹è¡Œç‚ºãŒç¢ºèªã•ã‚ŒãŸå ´åˆã€æ²è¼‰å†…å®¹ã‚’äºˆå‘Šãªãä¿®æ­£ãƒ»å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
      <button id="openPolicy" class="underline text-gray-600">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼è¡¨ç¤º / åŒæ„è¨­å®šã‚’é–‹ã</button></p>
    </div>
  </section>
</main>

<footer class="text-center text-gray-600 text-sm py-8 mt-10">
  <p>Â© 2025 ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î² | ãƒ‡ãƒ¼ã‚¿å‚è€ƒ: CardRush / ãƒˆãƒ¬ã‚³ãƒ­ / Mercari / yugioh-starter.com</p>
</footer>

<!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-mask" id="policyMask" role="dialog" aria-modal="true" aria-labelledby="policyTitle">
  <div class="modal">
    <header><h3 id="policyTitle" class="text-lg font-bold">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¨åŒæ„</h3></header>
    <main>
      <p class="text-sm text-gray-700 mb-2">æœ¬ã‚µã‚¤ãƒˆã§ã¯ã€ã‚µã‚¤ãƒˆæ”¹å–„ã®ãŸã‚ã«ã‚¢ã‚¯ã‚»ã‚¹è§£æï¼ˆGoogle Analytics 4 / Microsoft Clarityï¼‰ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚åé›†ãƒ‡ãƒ¼ã‚¿ã«ã¯å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚è©³ç´°ã¯ä»¥ä¸‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
      <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
        <li>è§£æãƒ„ãƒ¼ãƒ«ã¯Cookieã‚„é¡ä¼¼æŠ€è¡“ã‚’ç”¨ã„ã¦åˆ©ç”¨çŠ¶æ³ã‚’æŠŠæ¡ã—ã¾ã™ã€‚</li>
        <li>å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯çµ±è¨ˆçš„ã«å‡¦ç†ã•ã‚Œã€ã‚µã‚¤ãƒˆæ”¹å–„ã®ç›®çš„ã«é™ã‚Šåˆ©ç”¨ã—ã¾ã™ã€‚</li>
        <li>åºƒå‘Šï¼ˆã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆï¼‰ãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã§ã®è³¼å…¥ãƒ»å¥‘ç´„ã¯å„äº‹æ¥­è€…ã®è¦ç´„ã«å¾“ã„ã¾ã™ã€‚</li>
        <li>åŒæ„ã¯ã„ã¤ã§ã‚‚æ’¤å›ã§ãã¾ã™ï¼ˆæœ¬ãƒãƒªã‚·ãƒ¼ã‚’å†è¡¨ç¤ºã—ã¦å¤‰æ›´ï¼‰ã€‚</li>
      </ul>
    </main>
    <footer>
      <button class="btn btn-ghost" id="policyDecline">åŒæ„ã—ãªã„</button>
      <button class="btn btn-primary" id="policyAgree">åŒæ„ã™ã‚‹</button>
    </footer>
  </div>
</div>

<script>
/* ====== ã‚²ãƒ¼ãƒ IDã®è¡¨ç¤ºã¨ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ­£ã—ãä¸€è‡´ã•ã›ã‚‹ãŸã‚ã®ãƒãƒƒãƒ”ãƒ³ã‚° ====== */
const GAME_LABELS = { ygo:"éŠæˆ¯ç‹", pkm:"ãƒã‚±ã‚«", ws:"ãƒ´ã‚¡ã‚¤ã‚¹", dm:"ãƒ‡ãƒ¥ã‚¨ãƒ", mtg:"MTG" };
const REVERSE_LABELS = Object.fromEntries(Object.entries(GAME_LABELS).map(([k,v])=>[v,k]));
function toGameCode(v){
  if(!v) return "";
  const s = String(v).trim();
  const low = s.toLowerCase();
  if (GAME_LABELS[low]) return low;         // 'ygo'
  if (REVERSE_LABELS[s]) return REVERSE_LABELS[s]; // 'éŠæˆ¯ç‹'â†’'ygo'
  return low; // äºˆå‚™
}
function toGameLabel(code){ return GAME_LABELS[code] || code; }

/* ====== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨æ•´å½¢ ====== */
let dataTable, fullData=[];
let currentGameCode = "all";
let roiMin = 100, roiMax = 200, priceMin = 3000, priceMax = 15000;

fetch("torekadata.json")
  .then(r => r.json())
  .then(json => {
    fullData = json.map(x=>{
      const gameCode = toGameCode(x.game);
      const boxPrice = num(x.boxPrice) || (num(x.packPrice) * num(x.packCount));
      const avgBuyTotal = num(x.avgBuyTotal);
      const packEV = (avgBuyTotal && num(x.packCount)) ? Math.round(avgBuyTotal/num(x.packCount)) : num(x.packEV);
      const roi = (boxPrice && avgBuyTotal) ? (avgBuyTotal/boxPrice) : num(x.roi);
      const roi_pct = (roi? (roi*100) : 0).toFixed(1) + "%";
      return {
        ...x,
        gameCode,
        gameLabel: toGameLabel(gameCode),
        boxPrice, avgBuyTotal, packEV, roi, roi_pct
      };
    });
    initFilters(fullData);
    initTable(fullData);
    ensureConsentModal(); // åˆå›ã®åŒæ„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
  })
  .catch(err=>{
    console.error(err);
    $("#torekaTable").html("<tr><td>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</td></tr>");
  });

function num(v){ const n = Number(v); return isNaN(n)?0:n; }

/* ====== DataTables åˆæœŸåŒ– ====== */
function initTable(rows){
  const columns = [
    { title:"ã‚²ãƒ¼ãƒ ", data:"gameLabel" },
    { title:"ãƒœãƒƒã‚¯ã‚¹å", data:"boxName", render:(val,type,row)=>{
        const img = row.affiliateImage ? `<img class="thumb mr-3" src="${row.affiliateImage}" alt="">`
                                       : `<span class="mr-3 inline-block w-14 h-14 bg-gray-100 border rounded"></span>`;
        const link = row.affiliateUrl ? `<a href="${row.affiliateUrl}" target="_blank" class="text-yellow-700 underline">ã‚¢ãƒ•ã‚£ã‚’è¦‹ã‚‹</a>`
                                       : `<span class="text-gray-400">ãƒªãƒ³ã‚¯ãªã—</span>`;
        return `<div class="flex items-center">${img}<div><div class="font-semibold">${escapeHtml(val||"-")}</div><div class="text-xs">${link}</div></div></div>`;
      }},
    { title:"ç™ºå£²æ—¥", data:"releaseDate" },
    { title:"ç®±ä¾¡æ ¼(å††)", data:"boxPrice", render:v=>num(v).toLocaleString() },
    { title:"æœŸå¾…å€¤(å††)", data:"avgBuyTotal", render:v=>num(v).toLocaleString() },
    { title:"1ãƒ‘ãƒƒã‚¯EV", data:"packEV", render:v=>num(v).toLocaleString() },
    { title:"å›åç‡", data:"roi_pct" }
  ];

  dataTable = $("#torekaTable").DataTable({
    data: rows,
    columns,
    order: [[6,"desc"]],
    pageLength: 10,
    responsive: true,
    language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" },
    createdRow: function(row, data){ if (data.roi >= 1.2) $(row).addClass("rank-gold"); }
  });

  applyAllFilters();
}

/* ====== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å†…ï¼‰ ====== */
function initFilters(rows){
  const roiVals = rows.map(r=>Math.round((r.roi||0)*100)).filter(Number.isFinite);
  const rMin = roiVals.length ? Math.max(0, Math.min(...roiVals, 50)) : 50;
  const rMax = roiVals.length ? Math.max(...roiVals, 200) : 200;
  roiMin = rMin; roiMax = rMax;

  const priceVals = rows.map(r=>r.boxPrice||0).filter(Number.isFinite);
  const pMin = priceVals.length ? Math.max(0, Math.min(...priceVals)) : 1000;
  const pMax = priceVals.length ? Math.max(...priceVals) : 20000;
  priceMin = pMin; priceMax = pMax;

  const roiSlider = document.getElementById('roiSlider');
  noUiSlider.create(roiSlider, {
    start:[roiMin, roiMax], connect:true, step:1,
    range:{min:Math.max(0,Math.min(roiMin,50)), max:Math.max(roiMax,200)},
    format:{to:v=>Math.round(v), from:v=>Number(v)}
  });
  roiSlider.noUiSlider.on('update', (values)=>{
    roiMin = Number(values[0]); roiMax = Number(values[1]);
    document.getElementById('roiLabel').textContent = `${roiMin}% ã€œ ${roiMax}%`;
  });
  roiSlider.noUiSlider.on('change', applyAllFilters);

  const priceSlider = document.getElementById('priceSlider');
  noUiSlider.create(priceSlider, {
    start:[priceMin, priceMax], connect:true, step:100,
    range:{min:Math.max(0,Math.min(priceMin,500)), max:Math.max(priceMax,20000)},
    format:{to:v=>Math.round(v), from:v=>Number(v)}
  });
  priceSlider.noUiSlider.on('update', (values)=>{
    priceMin = Number(values[0]); priceMax = Number(values[1]);
    document.getElementById('priceLabel').textContent = `${priceMin.toLocaleString()} ã€œ ${priceMax.toLocaleString()}`;
  });
  priceSlider.noUiSlider.on('change', applyAllFilters);

  // ã‚¿ãƒ–
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentGameCode = btn.getAttribute("data-game-code");
      applyAllFilters();
    });
  });
}

/* ====== ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ ====== */
function applyAllFilters(){
  if(!dataTable) return;
  $.fn.dataTable.ext.search = [];
  $.fn.dataTable.ext.search.push((settings, data, dataIndex)=>{
    const row = dataTable.row(dataIndex).data();
    if(!row) return true;
    // ã‚²ãƒ¼ãƒ ï¼šall ã‹ã€ã‚³ãƒ¼ãƒ‰ä¸€è‡´
    if(currentGameCode !== "all" && row.gameCode !== currentGameCode) return false;
    // ROI%
    const roiPctVal = Number(String(row.roi_pct||"0").replace("%",""));
    if(roiPctVal < roiMin || roiPctVal > roiMax) return false;
    // ä¾¡æ ¼
    const priceVal = Number(row.boxPrice||0);
    if(priceVal < priceMin || priceVal > priceMax) return false;
    return true;
  });
  dataTable.draw();
}

/* ====== è¨ˆç®—ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆLocalStorageï¼‰ ====== */
function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s])); }
function getForm(){ return {
  packPrice:num($("#packPrice").val()), packCount:num($("#packCount").val()),
  r1avg:num($("#r1avg").val()), r1cpb:num($("#r1cpb").val()),
  r2avg:num($("#r2avg").val()), r2cpb:num($("#r2cpb").val()),
  r3avg:num($("#r3avg").val()), r3cpb:num($("#r3cpb").val()),
  r4avg:num($("#r4avg").val()), r4cpb:num($("#r4cpb").val())
};}
function calcNow(){
  const f=getForm();
  const boxPrice=f.packPrice*f.packCount;
  const avgBuyTotal=f.r1avg*f.r1cpb+f.r2avg*f.r2cpb+f.r3avg*f.r3cpb+f.r4avg*f.r4cpb;
  const packEV=f.packCount?Math.round(avgBuyTotal/f.packCount):0;
  const roi=boxPrice?avgBuyTotal/boxPrice:0;
  $("#calcResult").html(`ç®±ä¾¡æ ¼ï¼š<b>${boxPrice.toLocaleString()}å††</b> ï¼ æœŸå¾…å€¤ï¼š<b>${avgBuyTotal.toLocaleString()}å††</b> ï¼ 1ãƒ‘ãƒƒã‚¯EVï¼š<b>${packEV.toLocaleString()}å††</b> ï¼ ROIï¼š<b>${(roi*100).toFixed(1)}%</b>`);
}
$("#calcBtn").on("click", calcNow);
const LS_KEY="toreka_calc_saved";
$("#saveBtn").on("click", ()=>{
  const f=getForm(); const list=JSON.parse(localStorage.getItem(LS_KEY)||"[]");
  list.unshift({...f, ts:Date.now()}); localStorage.setItem(LS_KEY, JSON.stringify(list.slice(0,20)));
  $("#calcSaved").removeClass("hidden"); setTimeout(()=>$("#calcSaved").addClass("hidden"),1200);
  renderSaved();
});
function renderSaved(){
  const list=JSON.parse(localStorage.getItem(LS_KEY)||"[]");
  const box=document.getElementById("savedList");
  if(!list.length){ box.innerHTML='<div class="text-xs text-gray-400">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>'; return; }
  box.innerHTML=list.map((it,i)=>{
    const d=new Date(it.ts);
    return `<div class="flex items-center justify-between border rounded p-2">
      <div class="text-xs">${d.toLocaleString()} ï½œ å˜ä¾¡${it.packPrice}Ã—${it.packCount}ï¼r1:${it.r1avg}Ã—${it.r1cpb}ï¼r2:${it.r2avg}Ã—${it.r2cpb}</div>
      <button class="text-yellow-700 underline text-xs" onclick="loadSaved(${i})">èª­ã¿è¾¼ã‚€</button>
    </div>`;
  }).join("");
}
window.loadSaved=function(i){
  const list=JSON.parse(localStorage.getItem(LS_KEY)||"[]"); const it=list[i]; if(!it) return;
  $("#packPrice").val(it.packPrice); $("#packCount").val(it.packCount);
  $("#r1avg").val(it.r1avg); $("#r1cpb").val(it.r1cpb);
  $("#r2avg").val(it.r2avg); $("#r2cpb").val(it.r2cpb);
  $("#r3avg").val(it.r3avg); $("#r3cpb").val(it.r3cpb);
  $("#r4avg").val(it.r4avg); $("#r4cpb").val(it.r4cpb);
  calcNow();
}
renderSaved();

/* ====== ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
const CONSENT_KEY="toreka_privacy_consent_v1";
function ensureConsentModal(){
  const consent=localStorage.getItem(CONSENT_KEY);
  if(consent!=="granted"){ openPolicy(); }
}
function openPolicy(){ document.getElementById("policyMask").style.display="flex"; }
function closePolicy(){ document.getElementById("policyMask").style.display="none"; }
document.getElementById("openPolicy").addEventListener("click", openPolicy);
document.getElementById("policyAgree").addEventListener("click", ()=>{ localStorage.setItem(CONSENT_KEY,"granted"); closePolicy(); });
document.getElementById("policyDecline").addEventListener("click", ()=>{ localStorage.setItem(CONSENT_KEY,"declined"); closePolicy(); });

</script>
</body>
</html>
