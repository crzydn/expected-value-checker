<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²ï½œä¸»è¦ãƒˆãƒ¬ã‚«ã®æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <meta name="description" content="éŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒãªã©ä¸»è¦ãƒˆãƒ¬ã‚«ã®ãƒœãƒƒã‚¯ã‚¹æœŸå¾…å€¤ã‚’è‡ªå‹•é›†è¨ˆã€‚å¹³å‡è²·å–ã‹ã‚‰å›åç‡ã¨1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’è¨ˆç®—ã—ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€‚">
  <link rel="icon" href="assets/favicon.ico">
  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    :root{ --brand:#2563eb; --brand2:#60a5fa; --accent:#f59e0b; --bg:#f8fafc; }
    body{ background:var(--bg); color:#111827; }
    header{ background:linear-gradient(90deg,#fff 0%,#eaf2ff 40%,#fff7e6 100%); border-bottom:1px solid #e5e7eb; }
    .title-lg{ font-size:2rem; } @media(min-width:1024px){ .title-lg{ font-size:2.25rem; } }
    .h-icon{ display:inline-flex; align-items:center; gap:.5rem; }
    .h-dot{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand2)); }
    .section{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:1.25rem; }
    .thumb{ width:56px; height:56px; object-fit:cover; border-radius:.6rem; border:1px solid #e5e7eb; background:#f1f5f9; }
    .badge{ display:inline-block; padding:.15rem .45rem; border-radius:.4rem; background:#fff3cd; color:#92400e; font-size:.75rem; border:1px solid #ffe69c; }
    .is-top{ background:linear-gradient(180deg,#fffbe6,#fff7cc); box-shadow:inset 0 0 0 2px var(--accent); }
    .dt-container{ overflow-x:auto; }
  </style>
</head>
<body>
<header class="py-6">
  <div class="max-w-7xl mx-auto px-4 flex items-center justify-between">
    <div>
      <div class="h-icon"><span class="h-dot"></span><h1 class="title-lg font-extrabold">ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î²</h1></div>
      <p class="mt-1 text-sm text-gray-600">å›åç‡ã¨1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ã‚’æ¯”è¼ƒï¼ˆéŠæˆ¯ç‹ãƒ»ãƒã‚±ã‚«ãƒ»ãƒ´ã‚¡ã‚¤ã‚¹ãƒ»ãƒ‡ãƒ¥ã‚¨ãƒï¼‰</p>
    </div>
    <span class="hidden lg:inline-block badge">PRã‚’å«ã¿ã¾ã™</span>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <section id="ranking" class="section mb-8">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#22c55e,#86efac)"></span>æœ€æ–°æœŸå¾…å€¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span></h2>
      <div class="flex gap-2">
        <a id="share-line" class="px-3 py-2 rounded text-white" style="background:#06C755">LINEã§å…±æœ‰</a>
        <a id="share-x" class="px-3 py-2 rounded text-white" style="background:#000">Xã§å…±æœ‰</a>
      </div>
    </div>
    <table id="rankingTable" class="stripe hover w-full text-sm"></table>
    <p class="text-xs text-gray-500 mt-2">â€» ãƒ‡ãƒ¼ã‚¿ã¯å‚è€ƒå€¤ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚’ç›®çš„ã¨ã—ã¾ã›ã‚“ã€‚ä¾¡æ ¼ã¯å¤‰å‹•ã—ã¾ã™ã€‚</p>
  </section>

  <!-- PRãƒ–ãƒ­ãƒƒã‚¯ -->
  <section class="section mb-10">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">ã€PRã€‘äººæ°—ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½å¤© / Amazonï¼‰</div>
        <div class="text-xs text-gray-500">ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™</div>
      </div>
      <div class="flex gap-3">
        <a id="pr-rakuten" href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#f59e0b,#fcd34d);">æ¥½å¤©</a>
        <a id="pr-amazon" href="#" target="_blank" rel="nofollow noopener sponsored" class="px-3 py-2 rounded text-white" style="background:linear-gradient(135deg,#111827,#4b5563);">Amazon</a>
      </div>
    </div>
  </section>

  <!-- å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§ -->
  <section id="all" class="section mb-12">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-semibold"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#2563eb,#93c5fd)"></span>å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§</span></h3>
      <div id="gameTabs" class="flex gap-2"></div>
    </div>
    <table id="allTable" class="stripe hover w-full text-sm"></table>
  </section>

  <!-- è‡ªåˆ†ã§è¨ˆç®— -->
  <section id="calc" class="section mb-12">
    <h3 class="text-xl font-semibold mb-4"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#a855f7,#c084fc)"></span>è‡ªåˆ†ã§è¨ˆç®—ã™ã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¯ï¼‰</span></h3>
    <div class="grid md:grid-cols-3 gap-4">
      <label>ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰
        <input type="text" id="c_title" class="border p-2 w-full rounded" placeholder="ä¾‹ï¼šè‡ªåˆ†ç”¨ãƒ†ã‚¹ãƒˆè¨ˆç®—">
      </label>
      <label>ãƒ‘ãƒƒã‚¯å˜ä¾¡ï¼ˆå††ï¼‰
        <input type="number" id="c_packPrice" class="border p-2 w-full rounded" value="200" min="0">
      </label>
      <label>ãƒ‘ãƒƒã‚¯æ•°ï¼ˆç®±ï¼‰
        <input type="number" id="c_packCount" class="border p-2 w-full rounded" value="30" min="1">
      </label>
    </div>
    <div id="rarityRows" class="grid md:grid-cols-3 gap-4 mt-4"></div>
    <div class="mt-3 flex gap-2">
      <button id="addRarity" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded">ï¼‹ ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¿½åŠ </button>
      <button id="calcBtn" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);">è¨ˆç®—ã™ã‚‹</button>
      <button id="saveCalc" class="px-4 py-2 text-white rounded" style="background:linear-gradient(135deg,#2563eb,#60a5fa);">ä¿å­˜</button>
    </div>
    <div id="calcResult" class="mt-4 text-lg font-semibold"></div>

    <div class="mt-6">
      <h4 class="font-semibold mb-2">ğŸ’¾ ä¿å­˜å±¥æ­´</h4>
      <table id="historyTable" class="stripe hover w-full text-sm"></table>
    </div>
  </section>

  <!-- æ³•å‹™ -->
  <section id="legal" class="section">
    <h3 class="text-xl font-semibold mb-3"><span class="h-icon"><span class="h-dot" style="background:linear-gradient(135deg,#ef4444,#fca5a5)"></span>åˆ©ç”¨è¦ç´„ãƒ»å…è²¬ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</span></h3>
    <details class="mb-2" open>
      <summary class="cursor-pointer font-medium">åˆ©ç”¨è¦ç´„ï¼ˆè¦æ—¨ï¼‰</summary>
      <ul class="ml-6 mt-2 list-disc text-sm text-gray-700 space-y-1">
        <li>æœ¬ã‚µã‚¤ãƒˆã¯å‚è€ƒæƒ…å ±ã®æä¾›ã‚’ç›®çš„ã¨ã—ã€æŠ•è³‡åŠ©è¨€ãƒ»å‹§èª˜ã‚’è¡Œã†ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
        <li>æ²è¼‰æƒ…å ±ã®æ­£ç¢ºæ€§ãƒ»æœ€æ–°æ€§ã¯ä¿è¨¼ã—ã¾ã›ã‚“ã€‚ä¾¡æ ¼ãƒ»ç›¸å ´ã¯å¸¸ã«å¤‰å‹•ã—ã¾ã™ã€‚</li>
        <li>å½“ã‚µã‚¤ãƒˆã®æ•°å€¤ã‚„APIã‚’ç¬¬ä¸‰è€…ã«æä¾›ã™ã‚‹å ´åˆã¯å‡ºå…¸ï¼ˆã‚µã‚¤ãƒˆåãƒ»URLï¼‰ã®æ˜ç¤ºãŒå¿…è¦ã§ã™ã€‚</li>
        <li>å•†ç”¨ã§ã®ç¶™ç¶šçš„åˆ©ç”¨ï¼ˆå†é…å¸ƒãƒ»æœ‰å„Ÿã‚µãƒ¼ãƒ“ã‚¹ç­‰ï¼‰ã¯äº‹å‰è¨±è«¾ãŒå¿…è¦ã§ã™ã€‚</li>
      </ul>
    </details>
    <details class="mb-2">
      <summary class="cursor-pointer font-medium">å…è²¬äº‹é …</summary>
      <ul class="ml-6 mt-2 list-disc text-sm text-gray-700 space-y-1">
        <li>å¤–éƒ¨ã‚µã‚¤ãƒˆã®ä»•æ§˜å¤‰æ›´ãƒ»é€šä¿¡éšœå®³ãƒ»æƒ…å ±é…å»¶ç­‰ã«èµ·å› ã™ã‚‹æå®³ã«ã¤ã„ã¦ã€å½“æ–¹ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</li>
        <li>è©¦ç®—çµæœã¯æ¨è¨ˆå€¤ã§ã‚ã‚Šã€å®Ÿéš›æ¡ä»¶ã«ã‚ˆã‚Šä¹–é›¢ã—ã¾ã™ã€‚</li>
      </ul>
    </details>
    <details>
      <summary class="cursor-pointer font-medium">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</summary>
      <ul class="ml-6 mt-2 list-disc text-sm text-gray-700 space-y-1">
        <li>åˆ©ç”¨çŠ¶æ³æŠŠæ¡ã®ãŸã‚è§£æãƒ„ãƒ¼ãƒ«ï¼ˆCookieå«ã‚€ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
        <li>Cookieã‚’æ‹’å¦ã™ã‚‹ã¨ä¸€éƒ¨æ©Ÿèƒ½ï¼ˆä¿å­˜å±¥æ­´ãªã©ï¼‰ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</li>
      </ul>
    </details>
  </section>
</main>

<footer class="text-center text-gray-600 text-sm py-6 mt-12">
  <p>Â© 2025 ãƒˆãƒ¬ã‚«æœŸå¾…å€¤ãƒã‚§ãƒƒã‚«ãƒ¼ Î² | å‚è€ƒ: CardRush / ãƒˆãƒ¬ã‚³ãƒ­ / ãƒ¡ãƒ«ã‚«ãƒª / yugioh-starter.com</p>
  <p class="text-xs mt-2">æœ¬ãƒšãƒ¼ã‚¸ã«ã¯åºƒå‘Šãƒ»ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’å«ã¿ã¾ã™ï¼ˆPRï¼‰ã€‚</p>
</footer>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
(async function(){
  /* ====== ã“ã“ã ã‘ã‚ãªãŸã®URLã«å¤‰æ›´ ====== */
  const WORKER_BASE = 'https://evchecker.crzydn.workers.dev';
  const SHEET_NAME  = 'ãƒˆãƒ¬ã‚«æœŸå¾…å€¤å…¥åŠ›'; // ã‚·ãƒ¼ãƒˆã‚¿ãƒ–å
  /* ===================================== */

  // å…±æœ‰ãƒœã‚¿ãƒ³
  document.getElementById('share-line').href = `https://line.me/R/msg/text/?${encodeURIComponent(document.title+'\n'+location.href)}`;
  document.getElementById('share-x').href    = `https://x.com/intent/tweet?text=${encodeURIComponent(document.title)}&url=${encodeURIComponent(location.href)}`;

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  let rows=[];
  try{
    const res = await fetch(`${WORKER_BASE}/gas?sheet=${encodeURIComponent(SHEET_NAME)}&ts=${Date.now()}`, {cache:'no-store'});
    const json = await res.json();
    rows = (json && json.data) || [];
  }catch(e){
    alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'); return;
  }

  // æ­£è¦åŒ–
  const gameMap={ygo:'éŠæˆ¯ç‹',YGO:'éŠæˆ¯ç‹',pkm:'ãƒã‚±ã‚«',PKM:'ãƒã‚±ã‚«',ws:'ãƒ´ã‚¡ã‚¤ã‚¹',WS:'ãƒ´ã‚¡ã‚¤ã‚¹',dm:'ãƒ‡ãƒ¥ã‚¨ãƒ',DM:'ãƒ‡ãƒ¥ã‚¨ãƒ',mtg:'MTG',MTG:'MTG'};
  const toNum = v => (typeof v==='number')?v:Number(String(v||'').replace(/[^\d.-]/g,'')||0);
  const toSlug = s => (String(s||'').toLowerCase().trim().replace(/[^\wä¸€-é¾¥ã-ã‚“ã‚¡-ãƒ¶]+/g,'-').replace(/^-+|-+$/g,''));

  const data = rows.filter(r=>r && (r.boxName||r.boxname||r['ãƒœãƒƒã‚¯ã‚¹å']))
    .map(r=>{
      const game = r.game||r['game']||'';
      const packPrice = toNum(r.packPrice||r['packPrice']||r['ãƒ‘ãƒƒã‚¯å˜ä¾¡']);
      const packCount = toNum(r.packCount||r['packCount']||r['ãƒ‘ãƒƒã‚¯æ•°']);
      const boxPrice  = toNum(r.boxPrice||r['boxPrice']||r['ç®±ä¾¡æ ¼']||packPrice*packCount);

      const avgBuyTotal = toNum(r.avgBuyTotal||r['avgBuyTotal']||r['æœŸå¾…å€¤åˆè¨ˆ']);
      const packEV      = toNum(r.packEV||r['packEV']||r['1P_EV']|| (packCount? Math.round(avgBuyTotal/packCount):0));
      const roi         = r.roi? Number(r.roi) : (boxPrice? (avgBuyTotal/boxPrice):0);
      const roi_pct     = r.roi_pct || (roi? (roi*100).toFixed(1)+'%':'');

      const boxName = r.boxName || r.boxname || r['ãƒœãƒƒã‚¯ã‚¹å'] || '';
      const slug    = r.slug || toSlug(boxName);

      return {
        game: gameMap[game] || game,
        boxName,
        slug,
        releaseDate: r.releaseDate || r['releaseDate'] || r['ç™ºå£²æ—¥'] || '',
        boxPrice, avgBuyTotal, packEV, roi, roi_pct,
        affiliateImage: r.affiliateImage || r['affiliateImage'] || '',
        affiliateUrl:   r.affiliateUrl   || r['affiliateUrl']   || ''
      };
    });

  // PRãƒªãƒ³ã‚¯ï¼ˆä»»æ„å·®æ›¿ï¼‰
  document.getElementById('pr-rakuten').href = 'https://a.r10.to/hRBtGE';
  document.getElementById('pr-amazon').href  = 'https://amzn.to/3XXXXXX';

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨
  const rankCols=[
    { title:"å•†å“", data:null, render:(_,__,row)=>{
        const img = row.affiliateImage ? `<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">` : `<div class="thumb"></div>`;
        const link=`<a href="box.html?slug=${encodeURIComponent(row.slug)}" class="text-blue-700 underline">${row.boxName||'-'}</a>`;
        const pr  = row.affiliateUrl?`<a class="badge ml-2" href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored">PR</a>`:'';
        const sub = `${row.game||''}${row.releaseDate?'ï½œ'+row.releaseDate:''}`;
        return `<div class="flex items-center gap-3">${img}<div><div class="font-medium">${link}${pr}</div><div class="text-xs text-gray-500">${sub}</div></div></div>`;
    }},
    { title:"ç™ºå£²", data:"releaseDate" },
    { title:"ç®±(å††)", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
    { title:"æœŸå¾…å€¤åˆè¨ˆ(å††)", data:"avgBuyTotal", render:v=>Number(v||0).toLocaleString() },
    { title:"1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data:"packEV", render:v=>Number(v||0).toLocaleString() },
    { title:"å›åç‡ï¼ˆï¼…ï¼‰", data:"roi_pct" },
    { title:"roi_raw", data:"roi", visible:false }
  ];
  const rankingDT = $('#rankingTable').DataTable({
    data, columns:rankCols, order:[[6,'desc']], pageLength:10, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function top3(){ $(rankingDT.rows().nodes()).removeClass('is-top'); rankingDT.rows({order:'applied'}).indexes().toArray().slice(0,3).forEach(i=>$(rankingDT.row(i).node()).addClass('is-top')); }
  rankingDT.on('draw', top3); top3();

  // å…¨ãƒˆãƒ¬ã‚«ä¸€è¦§
  const games = Array.from(new Set(data.map(d=>d.game).filter(Boolean)));
  const tabs=document.getElementById('gameTabs');
  function mkBtn(t){const b=document.createElement('button'); b.className='px-3 py-1 rounded border text-sm bg-white'; b.textContent=t; b.onclick=()=>setFilter(t); return b;}
  tabs.appendChild(mkBtn('ã™ã¹ã¦')); games.forEach(g=>tabs.appendChild(mkBtn(g)));

  const allDT=$('#allTable').DataTable({
    data, columns:[
      { title:"ã‚²ãƒ¼ãƒ ", data:"game" },
      { title:"å•†å“", data:null, render:(_,__,row)=>{
          const img=row.affiliateImage?`<img src="${row.affiliateImage}" alt="${row.boxName}" class="thumb">`:`<div class="thumb"></div>`;
          const link=`<a href="box.html?slug=${encodeURIComponent(row.slug)}" class="text-blue-700 underline">${row.boxName||'-'}</a>`;
          const pr=row.affiliateUrl?`<a class="badge ml-2" href="${row.affiliateUrl}" target="_blank" rel="nofollow noopener sponsored">PR</a>`:'';
          return `<div class="flex items-center gap-3">${img}<div><div class="font-medium">${link}${pr}</div><div class="text-xs text-gray-500">${row.releaseDate||''}</div></div></div>`;
      }},
      { title:"ç®±(å††)", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title:"æœŸå¾…å€¤åˆè¨ˆ(å††)", data:"avgBuyTotal", render:v=>Number(v||0).toLocaleString() },
      { title:"1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data:"packEV", render:v=>Number(v||0).toLocaleString() },
      { title:"å›åç‡ï¼ˆï¼…ï¼‰", data:"roi_pct" }
    ],
    order:[[0,'asc'],[5,'desc']], pageLength:10, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function setFilter(label){ if(label==='ã™ã¹ã¦'){ allDT.column(0).search('').draw(); }else{ allDT.column(0).search('^'+label+'$',true,false).draw(); } }
  setFilter('ã™ã¹ã¦');

  // ç°¡æ˜“è¨ˆç®—
  const rarityRows=document.getElementById('rarityRows'); let rarityCount=0;
  function addRarity(avg=0, cpb=0){
    if(rarityCount>=6)return;
    rarityCount++;
    const wrap=document.createElement('div'); wrap.className='border rounded p-3 bg-white';
    wrap.innerHTML=`<div class="font-medium mb-2">ãƒ¬ã‚¢${rarityCount}</div>
      <label class="block text-sm">å¹³å‡è²·å–ï¼ˆå††ï¼‰<input type="number" class="r-avg border p-2 w-full mt-1 rounded" value="${avg}"></label>
      <label class="block text-sm mt-2">å°å…¥æ•°ï¼ˆæšï¼‰<input type="number" class="r-cpb border p-2 w-full mt-1 rounded" value="${cpb}"></label>
      <button type="button" class="mt-2 text-xs text-red-600 underline remove">å‰Šé™¤</button>`;
    wrap.querySelector('.remove').addEventListener('click',()=>{ rarityRows.removeChild(wrap); rarityCount--; });
    rarityRows.appendChild(wrap);
  }
  addRarity(900,3); addRarity(450,6);
  document.getElementById('addRarity').onclick=()=>addRarity();

  function calcNow(){
    const n=v=> (v===''||v==null||isNaN(Number(v)))?0:Number(v);
    const price=n(document.getElementById('c_packPrice').value);
    const count=Math.max(1,n(document.getElementById('c_packCount').value));
    const box=price*count;
    let ev=0;
    rarityRows.querySelectorAll('.border').forEach(boxEl=>{
      ev += n(boxEl.querySelector('.r-avg').value) * n(boxEl.querySelector('.r-cpb').value);
    });
    const packEV=Math.round(ev/count);
    const roi=box?ev/box:0, roiPct=(roi*100).toFixed(1)+'%';
    document.getElementById('calcResult').textContent=`ç®±ä¾¡æ ¼ï¼š${box.toLocaleString()}å†† ï¼ æœŸå¾…å€¤åˆè¨ˆï¼š${ev.toLocaleString()}å†† ï¼ 1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤ï¼š${packEV.toLocaleString()}å†† ï¼ å›åç‡ï¼š${roiPct}`;
    return {boxPrice:box, ev, packEV, roi, roiPct};
  }
  document.getElementById('calcBtn').onclick=calcNow;

  const STORAGE_KEY='toreka_calc_history_v1';
  const hisDT=$('#historyTable').DataTable({
    data:[], columns:[
      { title:"ã‚¿ã‚¤ãƒˆãƒ«", data:"title" },
      { title:"ç®±ä¾¡æ ¼", data:"boxPrice", render:v=>Number(v||0).toLocaleString() },
      { title:"æœŸå¾…å€¤åˆè¨ˆ", data:"ev", render:v=>Number(v||0).toLocaleString() },
      { title:"1ãƒ‘ãƒƒã‚¯æœŸå¾…å€¤", data:"packEV", render:v=>Number(v||0).toLocaleString() },
      { title:"å›åç‡ï¼ˆï¼…ï¼‰", data:"roiPct" },
      { title:"ä¿å­˜æ—¥æ™‚", data:"savedAt" }
    ],
    pageLength:5, autoWidth:false, scrollX:true,
    language:{ url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json" }
  });
  function loadHistory(){ try{ const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); hisDT.clear().rows.add(arr).draw(); }catch{} }
  loadHistory();
  document.getElementById('saveCalc').onclick=()=>{ const title=(document.getElementById('c_title').value||'æœªã‚¿ã‚¤ãƒˆãƒ«').trim(); const now=calcNow(); const rec={ title, boxPrice:now.boxPrice, ev:now.ev, packEV:now.packEV, roi:now.roi, roiPct:now.roiPct, savedAt:new Date().toLocaleString() }; const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); arr.unshift(rec); localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,100))); loadHistory(); alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰'); };

})();
</script>
</body>
</html>
